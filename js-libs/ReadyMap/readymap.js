/*
 MIT
*/
var osg={version:"0.0.5",copyright:"Cedric Pinson - cedric.pinson@plopbyte.com",instance:0,version:0,log:function(a){window.console!==void 0&&window.console.log(a)},reportErrorGL:!1,init:function(){}};osg.checkError=function(a){a!==0&&(a===1280?osg.log("detected error INVALID_ENUM"):a===1281?osg.log("detected error INVALID_VALUE"):a===1282?osg.log("detected error INVALID_OPERATION"):a===1285?osg.log("detected error OUT_OF_MEMORY"):a===1286?osg.log("detected error INVALID_FRAMEBUFFER_OPERATION"):osg.log("detected error UNKNOWN"))};
osg.extend=function(){var a=Object.prototype.toString,c=Object.prototype.hasOwnProperty,e=function(c){return a.call(c)==="[object Array]"},f=function(e){if(!e||a.call(e)!=="[object Object]"||e.nodeType||e.setInterval)return!1;if(e.constructor&&!c.call(e,"constructor")&&!c.call(e.constructor.prototype,"isPrototypeOf"))return!1;for(var f in e);return f===void 0||c.call(e,f)},g=arguments[0]||{},h=1,k=arguments.length,i=!1,m,n,o,p;typeof g==="boolean"&&(i=g,g=arguments[1]||{},h=2);typeof g!=="object"&&
a.call(g)!=="[object Function]"&&(g={});k===h&&(g=this,--h);for(;h<k;h++)if((m=arguments[h])!=null)for(n in m)o=g[n],p=m[n],g!==p&&(i&&p&&(f(p)||e(p))?(o=o&&(f(o)||e(o))?o:e(p)?[]:{},g[n]=osg.extend(i,o,p)):p!==void 0&&(g[n]=p));return g};osg.objectInehrit=function(a,c){function e(){}e.prototype=a;var f=new e;c&&osg.objectMix(f,c,!1);return f};osg.objectMix=function(a,c,e){for(var f in c)if(!e||!a[f])a[f]=c[f];return a};osg.objectType={};osg.objectType.type=0;
osg.objectType.generate=function(a){var c=osg.objectType.type;osg.objectType[c]=a;osg.objectType[a]=c;osg.objectType.type+=1;return c};osg.Float32Array=Float32Array;osg.Int32Array=Int32Array;osg.Uint16Array=Uint16Array;
osg.Vec2={copy:function(a,c){c[0]=a[0];c[1]=a[1];return c},valid:function(a){return isNaN(a[0])?!1:isNaN(a[1])?!1:!0},mult:function(a,c,e){e[0]=a[0]*c;e[1]=a[1]*c;return e},length2:function(a){return a[0]*a[0]+a[1]*a[1]},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},normalize:function(a,c){var e=this.length2(a);e>0?(e=1/Math.sqrt(e),c[0]=a[0]*e,c[1]=a[1]*e):(c[0]=a[0],c[1]=a[1]);return c},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]},sub:function(a,c,e){e[0]=a[0]-c[0];e[1]=a[1]-c[1];return e},
add:function(a,c,e){e[0]=a[0]+c[0];e[1]=a[1]+c[1];return e},neg:function(a,c){c[0]=-a[0];c[1]=-a[1];return c},lerp:function(a,c,e,f){var g=1-a;f[0]=c[0]*g+a*e[0];f[1]=c[1]*g+a*e[1];return f}};
osg.Vec3={copy:function(a,c){c[0]=a[0];c[1]=a[1];c[2]=a[2];return c},cross:function(a,c,e){e[0]=a[1]*c[2]-a[2]*c[1];e[1]=a[2]*c[0]-a[0]*c[2];e[2]=a[0]*c[1]-a[1]*c[0];return e},valid:function(a){return isNaN(a[0])?!1:isNaN(a[1])?!1:isNaN(a[2])?!1:!0},mult:function(a,c,e){e[0]=a[0]*c;e[1]=a[1]*c;e[2]=a[2]*c;return e},length2:function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},normalize:function(a,c){var e=this.length2(a);e>0?(e=1/Math.sqrt(e),
c[0]=a[0]*e,c[1]=a[1]*e,c[2]=a[2]*e):(c[0]=a[0],c[1]=a[1],c[2]=a[2]);return c},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]},sub:function(a,c,e){e[0]=a[0]-c[0];e[1]=a[1]-c[1];e[2]=a[2]-c[2];return e},add:function(a,c,e){e[0]=a[0]+c[0];e[1]=a[1]+c[1];e[2]=a[2]+c[2];return e},neg:function(a,c){c[0]=-a[0];c[1]=-a[1];c[2]=-a[2];return c},lerp:function(a,c,e,f){var g=1-a;f[0]=c[0]*g+a*e[0];f[1]=c[1]*g+a*e[1];f[2]=c[2]*g+a*e[2];return f}};
osg.Vec4={dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3]*c[3]},copy:function(a,c){c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];return c},sub:function(a,c,e){e[0]=a[0]-c[0];e[1]=a[1]-c[1];e[2]=a[2]-c[2];e[3]=a[3]-c[3];return e},mult:function(a,c){r[0]=a[0]*c;r[1]=a[1]*c;r[2]=a[2]*c;r[3]=a[3]*c;return r},add:function(a,c,e){e[0]=a[0]+c[0];e[1]=a[1]+c[1];e[2]=a[2]+c[2];e[3]=a[3]+c[3];return e},neg:function(a,c){c[0]=-a[0];c[1]=-a[1];c[2]=-a[2];c[3]=-a[3];return c},lerp:function(a,c,e,f){var g=
1-a;f[0]=c[0]*g+a*e[0];f[1]=c[1]*g+a*e[1];f[2]=c[2]*g+a*e[2];f[3]=c[3]*g+a*e[3];return f}};
osg.Matrix={setRow:function(a,c,e,f,g,h){c*=4;a[c+0]=e;a[c+1]=f;a[c+2]=g;a[c+3]=h},innerProduct:function(a,c,e,f){e*=4;return a[e+0]*c[0+f]+a[e+1]*c[4+f]+a[e+2]*c[8+f]+a[e+3]*c[12+f]},set:function(a,c,e,f){return a[c*4+e]=f},get:function(a,c,e){return a[c*4+e]},makeIdentity:function(a){a===void 0&&(a=[]);osg.Matrix.setRow(a,0,1,0,0,0);osg.Matrix.setRow(a,1,0,1,0,0);osg.Matrix.setRow(a,2,0,0,1,0);osg.Matrix.setRow(a,3,0,0,0,1);return a},makeTranslate:function(a,c,e,f){f===void 0&&(f=[]);osg.Matrix.setRow(f,
0,1,0,0,0);osg.Matrix.setRow(f,1,0,1,0,0);osg.Matrix.setRow(f,2,0,0,1,0);osg.Matrix.setRow(f,3,a,c,e,1);return f},setTrans:function(a,c,e,f){a[12]=c;a[13]=e;a[14]=f;return a},getTrans:function(a,c){c===void 0&&(c=[]);c[0]=a[12];c[1]=a[13];c[2]=a[14];return c},preMult:function(a,c){var e,f,g,h;e=c[0]*a[0]+c[1]*a[4]+c[2]*a[8]+c[3]*a[12];f=c[4]*a[0]+c[5]*a[4]+c[6]*a[8]+c[7]*a[12];g=c[8]*a[0]+c[9]*a[4]+c[10]*a[8]+c[11]*a[12];h=c[12]*a[0]+c[13]*a[4]+c[14]*a[8]+c[15]*a[12];a[0]=e;a[4]=f;a[8]=g;a[12]=h;
e=c[0]*a[1]+c[1]*a[5]+c[2]*a[9]+c[3]*a[13];f=c[4]*a[1]+c[5]*a[5]+c[6]*a[9]+c[7]*a[13];g=c[8]*a[1]+c[9]*a[5]+c[10]*a[9]+c[11]*a[13];h=c[12]*a[1]+c[13]*a[5]+c[14]*a[9]+c[15]*a[13];a[1]=e;a[5]=f;a[9]=g;a[13]=h;e=c[0]*a[2]+c[1]*a[6]+c[2]*a[10]+c[3]*a[14];f=c[4]*a[2]+c[5]*a[6]+c[6]*a[10]+c[7]*a[14];g=c[8]*a[2]+c[9]*a[6]+c[10]*a[10]+c[11]*a[14];h=c[12]*a[2]+c[13]*a[6]+c[14]*a[10]+c[15]*a[14];a[2]=e;a[6]=f;a[10]=g;a[14]=h;e=c[0]*a[3]+c[1]*a[7]+c[2]*a[11]+c[3]*a[15];f=c[4]*a[3]+c[5]*a[7]+c[6]*a[11]+c[7]*
a[15];g=c[8]*a[3]+c[9]*a[7]+c[10]*a[11]+c[11]*a[15];h=c[12]*a[3]+c[13]*a[7]+c[14]*a[11]+c[15]*a[15];a[3]=e;a[7]=f;a[11]=g;a[15]=h;return a},postMult:function(a,c){btmp0=c[0]*a[0]+c[1]*a[4]+c[2]*a[8]+c[3]*a[12];btmp1=c[0]*a[1]+c[1]*a[5]+c[2]*a[9]+c[3]*a[13];btmp2=c[0]*a[2]+c[1]*a[6]+c[2]*a[10]+c[3]*a[14];btmp3=c[0]*a[3]+c[1]*a[7]+c[2]*a[11]+c[3]*a[15];c[0]=btmp0;c[1]=btmp1;c[2]=btmp2;c[3]=btmp3;btmp0=c[4]*a[0]+c[5]*a[4]+c[6]*a[8]+c[7]*a[12];btmp1=c[4]*a[1]+c[5]*a[5]+c[6]*a[9]+c[7]*a[13];btmp2=c[4]*
a[2]+c[5]*a[6]+c[6]*a[10]+c[7]*a[14];btmp3=c[4]*a[3]+c[5]*a[7]+c[6]*a[11]+c[7]*a[15];c[4]=btmp0;c[5]=btmp1;c[6]=btmp2;c[7]=btmp3;btmp0=c[8]*a[0]+c[9]*a[4]+c[10]*a[8]+c[11]*a[12];btmp1=c[8]*a[1]+c[9]*a[5]+c[10]*a[9]+c[11]*a[13];btmp2=c[8]*a[2]+c[9]*a[6]+c[10]*a[10]+c[11]*a[14];btmp3=c[8]*a[3]+c[9]*a[7]+c[10]*a[11]+c[11]*a[15];c[8]=btmp0;c[9]=btmp1;c[10]=btmp2;c[11]=btmp3;btmp0=c[12]*a[0]+c[13]*a[4]+c[14]*a[8]+c[15]*a[12];btmp1=c[12]*a[1]+c[13]*a[5]+c[14]*a[9]+c[15]*a[13];btmp2=c[12]*a[2]+c[13]*a[6]+
c[14]*a[10]+c[15]*a[14];btmp3=c[12]*a[3]+c[13]*a[7]+c[14]*a[11]+c[15]*a[15];c[12]=btmp0;c[13]=btmp1;c[14]=btmp2;c[15]=btmp3;return c},multa:function(a,c,e){return e===a?this.preMult(a,c):e===c?this.postMult(a,c):(e===void 0&&(e=[]),e[0]=c[0]*a[0]+c[1]*a[4]+c[2]*a[8]+c[3]*a[12],e[1]=c[0]*a[1]+c[1]*a[5]+c[2]*a[9]+c[3]*a[13],e[2]=c[0]*a[2]+c[1]*a[6]+c[2]*a[10]+c[3]*a[14],e[3]=c[0]*a[3]+c[1]*a[7]+c[2]*a[11]+c[3]*a[15],e[4]=c[4]*a[0]+c[5]*a[4]+c[6]*a[8]+c[7]*a[12],e[5]=c[4]*a[1]+c[5]*a[5]+c[6]*a[9]+c[7]*
a[13],e[6]=c[4]*a[2]+c[5]*a[6]+c[6]*a[10]+c[7]*a[14],e[7]=c[4]*a[3]+c[5]*a[7]+c[6]*a[11]+c[7]*a[15],e[8]=c[8]*a[0]+c[9]*a[4]+c[10]*a[8]+c[11]*a[12],e[9]=c[8]*a[1]+c[9]*a[5]+c[10]*a[9]+c[11]*a[13],e[10]=c[8]*a[2]+c[9]*a[6]+c[10]*a[10]+c[11]*a[14],e[11]=c[8]*a[3]+c[9]*a[7]+c[10]*a[11]+c[11]*a[15],e[12]=c[12]*a[0]+c[13]*a[4]+c[14]*a[8]+c[15]*a[12],e[13]=c[12]*a[1]+c[13]*a[5]+c[14]*a[9]+c[15]*a[13],e[14]=c[12]*a[2]+c[13]*a[6]+c[14]*a[10]+c[15]*a[14],e[15]=c[12]*a[3]+c[13]*a[7]+c[14]*a[11]+c[15]*a[15],
e)},mult:function(a,c,e){var f=c[0],g=c[1],h=c[2],k=c[3],i=c[4],m=c[5],n=c[6],o=c[7],p=c[8],q=c[9],t=c[10],s=c[11],u=c[12],y=c[13],z=c[14],c=c[15],D=a[0],v=a[1],w=a[2],I=a[3],B=a[4],F=a[5],E=a[6],H=a[7],G=a[8],A=a[9],C=a[10],J=a[11],x=a[12],K=a[13],M=a[14],a=a[15];e[0]=f*D+g*B+h*G+k*x;e[1]=f*v+g*F+h*A+k*K;e[2]=f*w+g*E+h*C+k*M;e[3]=f*I+g*H+h*J+k*a;e[4]=i*D+m*B+n*G+o*x;e[5]=i*v+m*F+n*A+o*K;e[6]=i*w+m*E+n*C+o*M;e[7]=i*I+m*H+n*J+o*a;e[8]=p*D+q*B+t*G+s*x;e[9]=p*v+q*F+t*A+s*K;e[10]=p*w+q*E+t*C+s*M;e[11]=
p*I+q*H+t*J+s*a;e[12]=u*D+y*B+z*G+c*x;e[13]=u*v+y*F+z*A+c*K;e[14]=u*w+y*E+z*C+c*M;e[15]=u*I+y*H+z*J+c*a;return e},multOrig:function(a,c,e){if(e===a){for(var e=[],f=0;f<4;f++)e[0]=osg.Matrix.innerProduct(c,a,0,f),e[1]=osg.Matrix.innerProduct(c,a,1,f),e[2]=osg.Matrix.innerProduct(c,a,2,f),e[3]=osg.Matrix.innerProduct(c,a,3,f),a[0+f]=e[0],a[4+f]=e[1],a[8+f]=e[2],a[12+f]=e[3];return a}else if(e===c){e=[];for(f=0;f<4;f++)e[0]=osg.Matrix.innerProduct(c,a,f,0),e[1]=osg.Matrix.innerProduct(c,a,f,1),e[2]=
osg.Matrix.innerProduct(c,a,f,2),e[3]=osg.Matrix.innerProduct(c,a,f,3),this.setRow(c,f,e[0],e[1],e[2],e[3]);return c}e===void 0&&(e=[]);var f=c[0],g=c[1],h=c[2],k=c[3],i=c[4],m=c[5],n=c[6],o=c[7],p=c[8],q=c[9],t=c[10],s=c[11],u=c[12],y=c[13],z=c[14],c=c[15],D=a[0],v=a[1],w=a[2],I=a[3],B=a[4],F=a[5],E=a[6],H=a[7],G=a[8],A=a[9],C=a[10],J=a[11],x=a[12],K=a[13],M=a[14],a=a[15];e[0]=f*D+g*B+h*G+k*x;e[1]=f*v+g*F+h*A+k*K;e[2]=f*w+g*E+h*C+k*M;e[3]=f*I+g*H+h*J+k*a;e[4]=i*D+m*B+n*G+o*x;e[5]=i*v+m*F+n*A+o*K;
e[6]=i*w+m*E+n*C+o*M;e[7]=i*I+m*H+n*J+o*a;e[8]=p*D+q*B+t*G+s*x;e[9]=p*v+q*F+t*A+s*K;e[10]=p*w+q*E+t*C+s*M;e[11]=p*I+q*H+t*J+s*a;e[12]=u*D+y*B+z*G+c*x;e[13]=u*v+y*F+z*A+c*K;e[14]=u*w+y*E+z*C+c*M;e[15]=u*I+y*H+z*J+c*a;return e},makeLookAt:function(a,c,e,f){f===void 0&&(f=[]);c=osg.Vec3.sub(c,a,[]);osg.Vec3.normalize(c,c);e=osg.Vec3.cross(c,e,[]);osg.Vec3.normalize(e,e);var g=osg.Vec3.cross(e,c,[]);osg.Vec3.normalize(g,g);f[0]=e[0];f[1]=g[0];f[2]=-c[0];f[3]=0;f[4]=e[1];f[5]=g[1];f[6]=-c[1];f[7]=0;f[8]=
e[2];f[9]=g[2];f[10]=-c[2];f[11]=0;f[12]=0;f[13]=0;f[14]=0;f[15]=1;osg.Matrix.multTranslate(f,osg.Vec3.neg(a,[]),f);return f},makeOrtho:function(a,c,e,f,g,h,k){k===void 0&&(k=[]);var i=-(c+a)/(c-a),m=-(f+e)/(f-e),n=-(h+g)/(h-g),o=osg.Matrix.setRow;o(k,0,2/(c-a),0,0,0);o(k,1,0,2/(f-e),0,0);o(k,2,0,0,-2/(h-g),0);o(k,3,i,m,n,1);return k},getLookAt:function(a,c,e,f,g){g===void 0&&(g=1);var h=[];osg.Matrix.inverse(a,h)||osg.Matrix.makeIdentity(h);osg.Matrix.transformVec3(h,[0,0,0],c);osg.Matrix.transform3x3(a,
[0,1,0],f);osg.Matrix.transform3x3(a,[0,0,-1],e);osg.Vec3.normalize(e,e);osg.Vec3.add(osg.Vec3.mult(e,g,[]),c,e)},getRotate:function(a,c){c===void 0&&(c=[]);var e;e=[];var f,g;f=a[0];g=a[5];var h=a[10];e[0]=1+f+g+h;e[1]=1+f-g-h;e[2]=1-f+g-h;e[3]=1-f-g+h;g=0;for(f=1;f<4;f++)e[f]>e[g]&&(g=f);g===0?(c[3]=e[0],c[0]=a[6]-a[9],c[1]=a[8]-a[2],c[2]=a[1]-a[4]):g==1?(c[3]=a[6]-a[9],c[0]=e[1],c[1]=a[1]+a[4],c[2]=a[8]+a[2]):g==2?(c[3]=a[8]-a[2],c[0]=a[1]+a[4],c[1]=e[2],c[2]=a[6]+a[9]):(c[3]=a[1]-a[4],c[0]=a[8]+
a[2],c[1]=a[6]+a[9],c[2]=e[3]);e=Math.sqrt(0.25/e[g]);c[3]*=e;c[0]*=e;c[1]*=e;c[2]*=e;return c},multTranslate:function(a,c,e){e===void 0&&(e=[]);e!==a&&osg.Matrix.copy(a,e);var f;c[0]!==0&&(f=c[0],e[12]+=f*a[0],e[13]+=f*a[1],e[14]+=f*a[2],e[15]+=f*a[3]);c[1]!==0&&(f=c[1],e[12]+=f*a[4],e[13]+=f*a[5],e[14]+=f*a[6],e[15]+=f*a[7]);c[2]!==0&&(f=c[2],e[12]+=f*a[8],e[13]+=f*a[9],e[14]+=f*a[10],e[15]+=f*a[11]);return e},makeRotate:function(a,c,e,f,g){g===void 0&&(g=[]);var h=Math.sqrt(c*c+e*e+f*f),k=Math.sin(a),
a=Math.cos(a);if(h>0){var i,m,n,o,p,h=1/h;c*=h;e*=h;f*=h;h=c*e;i=e*f;m=f*c;n=c*k;o=e*k;k*=f;p=1-a;g[0]=p*c*c+a;g[1]=p*h-k;g[2]=p*m+o;g[3]=0;g[4]=p*h+k;g[5]=p*e*e+a;g[6]=p*i-n;g[7]=0;g[8]=p*m-o;g[9]=p*i+n;g[10]=p*f*f+a;g[11]=0;g[12]=0;g[13]=0;g[14]=0;g[15]=1}return g},transform3x3:function(a,c,e){e===void 0&&(e=[]);e[0]=a[0]*c[0]+a[1]*c[1]+a[2]*c[2];e[1]=a[4]*c[0]+a[5]*c[1]+a[6]*c[2];e[2]=a[8]*c[0]+a[9]*c[1]+a[10]*c[2];return e},transformVec3:function(a,c,e){var f=1/(a[3]*c[0]+a[7]*c[1]+a[11]*c[2]+
a[15]);e===void 0&&(e=[]);var g;g=e===c?[]:e;g[0]=(a[0]*c[0]+a[4]*c[1]+a[8]*c[2]+a[12])*f;g[1]=(a[1]*c[0]+a[5]*c[1]+a[9]*c[2]+a[13])*f;g[2]=(a[2]*c[0]+a[6]*c[1]+a[10]*c[2]+a[14])*f;e===c&&osg.Vec3.copy(g,e);return e},transformVec4:function(a,c,e){e===void 0&&(e=[]);var f;f=e===c?[]:e;f[0]=a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3]*c[3];f[1]=a[4]*c[0]+a[5]*c[1]+a[6]*c[2]+a[7]*c[3];f[2]=a[8]*c[0]+a[9]*c[1]+a[10]*c[2]+a[11]*c[3];f[3]=a[12]*c[0]+a[13]*c[1]+a[14]*c[2]+a[15]*c[3];e===c&&osg.Vec4.copy(f,e);return e},
copy:function(a,c){c===void 0&&(c=[]);c[0]=a[0];c[1]=a[1];c[2]=a[2];c[3]=a[3];c[4]=a[4];c[5]=a[5];c[6]=a[6];c[7]=a[7];c[8]=a[8];c[9]=a[9];c[10]=a[10];c[11]=a[11];c[12]=a[12];c[13]=a[13];c[14]=a[14];c[15]=a[15];return c},inverse:function(a,c){return this.inverse4x4(a,c)},inverse4x4:function(a,c){result=c===void 0?[]:c;var e=a[10]*a[15],f=a[14]*a[11],g=a[6]*a[15],h=a[14]*a[7],k=a[6]*a[11],i=a[10]*a[7],m=a[2]*a[15],n=a[14]*a[3],o=a[2]*a[11],p=a[10]*a[3],q=a[2]*a[7],t=a[6]*a[3],s=a[8]*a[13],u=a[12]*a[9],
y=a[4]*a[13],z=a[12]*a[5],D=a[4]*a[9],v=a[8]*a[5],w=a[0]*a[13],I=a[12]*a[1],B=a[0]*a[9],F=a[8]*a[1],E=a[0]*a[5],H=a[4]*a[1],G=e*a[5]+h*a[9]+k*a[13]-(f*a[5]+g*a[9]+i*a[13]),A=f*a[1]+m*a[9]+p*a[13]-(e*a[1]+n*a[9]+o*a[13]),C=g*a[1]+n*a[5]+q*a[13]-(h*a[1]+m*a[5]+t*a[13]),J=i*a[1]+o*a[5]+t*a[9]-(k*a[1]+p*a[5]+q*a[9]),x=a[0]*G+a[4]*A+a[8]*C+a[12]*J;if(Math.abs(x)<1.0E-5)if(osg.log("Warning can't inverse matrix "+a),c!==void 0)return!1;else osg.Matrix.makeIdentity(result);var x=1/x,K=x*(f*a[4]+g*a[8]+i*
a[12]-(e*a[4]+h*a[8]+k*a[12])),e=x*(e*a[0]+n*a[8]+o*a[12]-(f*a[0]+m*a[8]+p*a[12])),g=x*(h*a[0]+m*a[4]+t*a[12]-(g*a[0]+n*a[4]+q*a[12])),k=x*(k*a[0]+p*a[4]+q*a[8]-(i*a[0]+o*a[4]+t*a[8])),i=x*(s*a[7]+z*a[11]+D*a[15]-(u*a[7]+y*a[11]+v*a[15])),o=x*(u*a[3]+w*a[11]+F*a[15]-(s*a[3]+I*a[11]+B*a[15])),p=x*(y*a[3]+I*a[7]+E*a[15]-(z*a[3]+w*a[7]+H*a[15])),q=x*(v*a[3]+B*a[7]+H*a[11]-(D*a[3]+F*a[7]+E*a[11])),t=x*(y*a[10]+v*a[14]+u*a[6]-(D*a[14]+s*a[6]+z*a[10])),s=x*(B*a[14]+s*a[2]+I*a[10]-(w*a[10]+F*a[14]+u*a[2])),
y=x*(w*a[6]+H*a[14]+z*a[2]-(E*a[14]+y*a[2]+I*a[6])),D=x*(E*a[10]+D*a[2]+F*a[6]-(B*a[6]+H*a[10]+v*a[2]));result[0]=x*G;result[1]=x*A;result[2]=x*C;result[3]=x*J;result[4]=K;result[5]=e;result[6]=g;result[7]=k;result[8]=i;result[9]=o;result[10]=p;result[11]=q;result[12]=t;result[13]=s;result[14]=y;result[15]=D;return c!==void 0?!0:result},inverse4x3:function(a,c){result=c===void 0?[]:c;result[0]=a[5]*a[10]-a[6]*a[9];result[1]=a[2]*a[9]-a[1]*a[10];result[2]=a[1]*a[6]-a[2]*a[5];var e=a[0],f=a[4],g=a[8],
h=1/(e*result[0]+f*result[1]+g*result[2]);e*=h;f*=h;g*=h;result[0]*=h;result[1]*=h;result[2]*=h;result[3]=0;result[4]=a[6]*g-f*a[10];result[5]=e*a[10]-a[2]*g;result[6]=a[2]*f-e*a[6];result[7]=0;result[8]=f*a[9]-a[5]*g;result[9]=a[1]*g-e*a[9];result[10]=e*a[5]-a[1]*f;result[11]=0;result[15]=1;var e=a[15],f=e-1,k,i,m;if(f*f>1.0E-6){f=[];result[12]=result[13]=result[15]=0;k=a[3];i=a[7];m=a[11];var g=result[0]*k+result[1]*i+result[2]*m,h=result[4]*k+result[5]*i+result[6]*m,n=result[8]*k+result[9]*i+result[10]*
m;k=a[12];i=a[13];m=a[14];e=1/(e-(k*g+i*h+m*n));k*=e;i*=e;m*=e;f[0]=k*g+1;f[1]=i*g;f[2]=m*g;f[3]=-g*e;f[4]=k*h;f[5]=i*h+1;f[6]=m*h;f[7]=-h*e;f[8]=k*n;f[9]=i*n;f[10]=m*n+1;f[11]=-n*e;f[12]=-k;f[13]=-i;f[14]=-m;f[15]=e;this.mult(result,f,result)}else k=a[12],i=a[13],m=a[14],result[12]=-(k*result[0]+i*result[4]+m*result[8]),result[13]=-(k*result[1]+i*result[5]+m*result[9]),result[14]=-(k*result[2]+i*result[6]+m*result[10]);return c!==void 0?!0:result},transpose:function(a,c){if(a===c){var e=a[1],f=a[2],
g=a[3],h=a[6],k=a[7],i=a[11];a[1]=a[4];a[2]=a[8];a[3]=a[12];a[4]=e;a[6]=a[9];a[7]=a[13];a[8]=f;a[9]=h;a[11]=a[14];a[12]=g;a[13]=k;a[14]=i;return a}else return c[0]=a[0],c[1]=a[4],c[2]=a[8],c[3]=a[12],c[4]=a[1],c[5]=a[5],c[6]=a[9],c[7]=a[13],c[8]=a[2],c[9]=a[6],c[10]=a[10],c[11]=a[14],c[12]=a[3],c[13]=a[7],c[14]=a[11],c[15]=a[15],c},makePerspective:function(a,c,e,f,g){g===void 0&&(g=[]);var a=e*Math.tan(a*Math.PI/360),h=-a;return osg.Matrix.makeFrustum(h*c,a*c,h,a,e,f,g)},makeScale:function(a,c,e,
f){f===void 0&&(f=[]);this.setRow(f,0,a,0,0,0);this.setRow(f,1,0,c,0,0);this.setRow(f,2,0,0,e,0);this.setRow(f,3,0,0,0,1);return f},makeFrustum:function(a,c,e,f,g,h,k){k===void 0&&(k=[]);var i=2*g/(f-e),m=(c+a)/(c-a),e=(f+e)/(f-e),f=-(h+g)/(h-g),h=-2*h*g/(h-g);this.setRow(k,0,2*g/(c-a),0,0,0);this.setRow(k,1,0,i,0,0);this.setRow(k,2,m,e,f,-1);this.setRow(k,3,0,0,h,0);return k},makeRotateFromQuat:function(a,c){c===void 0&&(c=[]);this.makeIdentity(c);return this.setRotateFromQuat(c,a)},setRotateFromQuat:function(a,
c){var e=osg.Quat.length2(c);if(Math.abs(e)<=Number.MIN_VALUE)a[0]=0,a[1]=0,a[2]=0,a[4]=0,a[5]=0,a[6]=0,a[8]=0,a[9]=0,a[10]=0;else{var e=e!==1?2/e:2,f,g,h,k,i,m,n,o;f=e*c[0];g=e*c[1];h=e*c[2];e=c[0]*f;m=c[0]*g;n=c[0]*h;k=c[1]*g;i=c[1]*h;o=c[2]*h;f*=c[3];g*=c[3];h*=c[3];a[0]=1-(k+o);a[4]=m-h;a[8]=n+g;a[1]=m+h;a[5]=1-(e+o);a[9]=i-f;a[2]=n-g;a[6]=i+f;a[10]=1-(e+k)}return a}};osg.ShaderGeneratorType={VertexInit:0,VertexFunction:1,VertexMain:2,FragmentInit:3,FragmentMain:5};
osg.Shader=function(a,c){this.type=a;this.text=c};osg.Shader.prototype={compile:function(){this.shader=gl.createShader(this.type);gl.shaderSource(this.shader,this.text);gl.compileShader(this.shader);if(!gl.getShaderParameter(this.shader,gl.COMPILE_STATUS)){osg.log("can't compile shader:\n"+this.text+"\n");for(var a=("\n"+this.text).split("\n"),c="\n",e=0,f=a.length;e<f;++e)c+=e+" "+a[e]+"\n";osg.log(c);osg.log(gl.getShaderInfoLog(this.shader))}}};
osg.Shader.create=function(a,c){osg.log("osg.Shader.create is deprecated, use new osg.Shader with the same arguments instead");return new osg.Shader(a,c)};osg.StateAttribute=function(){this._dirty=!0};osg.StateAttribute.prototype={isDirty:function(){return this._dirty},dirty:function(){this._dirty=!0},setDirty:function(a){this._dirty=a}};osg.StateAttribute.OFF=0;osg.StateAttribute.ON=1;osg.StateAttribute.OVERRIDE=2;osg.StateAttribute.PROTECTED=4;osg.StateAttribute.INHERIT=8;
osg.Uniform=function(){this.transpose=!1;this._dirty=!0};
osg.Uniform.prototype={get:function(){return this.data},set:function(a){this.data=a;this.dirty()},dirty:function(){this._dirty=!0},apply:function(a){if(this._dirty)this.update.call(this.glData,this.data),this._dirty=!1;this.glCall(a,this.glData)},applyMatrix:function(a){if(this._dirty)this.update.call(this.glData,this.data),this._dirty=!1;this.glCall(a,this.transpose,this.glData)},update:function(a){for(var c=0,e=a.length;c<e;++c)this[c]=a[c]},_updateFloat1:function(a){this[0]=a[0]},_updateFloat2:function(a){this[0]=
a[0];this[1]=a[1]},_updateFloat3:function(a){this[0]=a[0];this[1]=a[1];this[2]=a[2]},_updateFloat4:function(a){this[0]=a[0];this[1]=a[1];this[2]=a[2];this[3]=a[3]},_updateFloat9:function(a){this[0]=a[0];this[1]=a[1];this[2]=a[2];this[3]=a[3];this[4]=a[4];this[5]=a[5];this[6]=a[6];this[7]=a[7];this[8]=a[8]},_updateFloat16:function(a){this[0]=a[0];this[1]=a[1];this[2]=a[2];this[3]=a[3];this[4]=a[4];this[5]=a[5];this[6]=a[6];this[7]=a[7];this[8]=a[8];this[9]=a[9];this[10]=a[10];this[11]=a[11];this[12]=
a[12];this[13]=a[13];this[14]=a[14];this[15]=a[15]}};osg.Uniform.createFloat1=function(a,c){var e=new osg.Uniform;e.data=[a];e.glCall=function(a,c){gl.uniform1fv(a,c)};e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat1;e.name=c;return e};osg.Uniform.createFloat2=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform2fv(a,c)};e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat2;e.name=c;return e};
osg.Uniform.createFloat3=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform3fv(a,c)};e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat3;e.name=c;return e};osg.Uniform.createFloat4=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform4fv(a,c)};e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat4;e.name=c;return e};
osg.Uniform.createInt1=function(a,c){var e=new osg.Uniform;e.data=[a];e.glCall=function(a,c){gl.uniform1iv(a,c)};e.glData=new osg.Int32Array(e.data);e.name=c;return e};osg.Uniform.createInt2=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform2iv(a,c)};e.glData=new osg.Int32Array(e.data);e.name=c;return e};osg.Uniform.createInt3=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform3iv(a,c)};e.glData=new osg.Int32Array(e.data);e.name=c;return e};
osg.Uniform.createInt4=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c){gl.uniform4iv(a,c)};e.glData=new osg.Int32Array(e.data);e.name=c;return e};osg.Uniform.createMatrix2=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c,e){gl.uniformMatrix2fv(a,c,e)};e.apply=e.applyMatrix;e.transpose=!1;e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat4;e.name=c;return e};
osg.Uniform.createMatrix3=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c,e){gl.uniformMatrix3fv(a,c,e)};e.apply=e.applyMatrix;e.transpose=!1;e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat9;e.name=c;return e};
osg.Uniform.createMatrix4=function(a,c){var e=new osg.Uniform;e.data=a;e.glCall=function(a,c,e){gl.uniformMatrix4fv(a,c,e)};e.apply=e.applyMatrix;e.transpose=!1;e.glData=new osg.Float32Array(e.data);e.update=osg.Uniform.prototype._updateFloat16;e.name=c;return e};osg.Node=function(){this.children=[];this.parents=[];this.nodeMask=-1;this.boundingSphere=new osg.BoundingSphere;this.boundingSphereComputed=!1};
osg.Node.prototype={getOrCreateStateSet:function(){if(this.stateset===void 0)this.stateset=new osg.StateSet;return this.stateset},getStateSet:function(){return this.stateset},accept:function(a){a.validNodeMask(this)&&(a.pushOntoNodePath(this),a.apply(this),a.popFromNodePath())},dirtyBound:function(){if(this.boundingSphereComputed===!0){this.boundingSphereComputed=!1;for(var a=0,c=this.parents.length;a<c;a++)this.parents[a].dirtyBound()}},setNodeMask:function(a){this.nodeMask=a},getNodeMask:function(){return this.nodeMask},
setStateSet:function(a){this.stateset=a},setUpdateCallback:function(a){this.updateCallback=a},getUpdateCallback:function(){return this.updateCallback},setName:function(a){this.name=a},getName:function(){return this.name},hasChild:function(a){for(var c=0,e=this.children.length;c<e;c++)if(this.children[c]===a)return!0;return!1},addChild:function(a){var c=this.children.push(a);a.addParent(this);this.dirtyBound();return c},getChildren:function(){return this.children},addParent:function(a){this.parents.push(a)},
removeParent:function(a){for(var c=0,e=this.parents.length,f=this.parents;c<e;c++)if(f[c]===a){f.splice(c,1);break}},removeChildren:function(){var a=this.children;if(a.length!==0){for(var c=0,e=a.length;c<e;c++)a[c].removeParent(this);this.children.length=0;this.dirtyBound()}},removeChild:function(a){for(var c=0,e=this.children.length;c<e;c++)this.children[c]===a&&(a.removeParent(this),this.children.splice(c,1),this.dirtyBound())},traverse:function(a){for(var c=0,e=this.children.length;c<e;c++)this.children[c].accept(a)},
ascend:function(a){for(var c=0,e=this.parents.length;c<e;c++)this.parents[c].accept(a)},getBound:function(){if(!this.boundingSphereComputed)this.computeBound(this.boundingSphere),this.boundingSphereComputed=!0;return this.boundingSphere},computeBound:function(a){var c=new osg.BoundingBox;c.init();a.init();for(var e=0,f=this.children.length;e<f;e++){var g=this.children[e];(g.referenceFrame===void 0||g.referenceFrame===osg.Transform.RELATIVE_RF)&&c.expandBySphere(g.getBound())}if(!c.valid())return a;
a._center=c.center();c=a._radius=0;for(e=this.children.length;c<e;c++)f=this.children[c],(f.referenceFrame===void 0||f.referenceFrame===osg.Transform.RELATIVE_RF)&&a.expandRadiusBySphere(f.getBound());return a},getWorldMatrices:function(a){var c=function(a){this.nodePaths=[];this.halt=a;osg.NodeVisitor.call(this,osg.NodeVisitor.TRAVERSE_PARENTS)};c.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{apply:function(a){a.parents.length===0||a===this.halt?this.nodePaths.push(this.nodePath.slice(0)):
this.traverse(a)}});a=new c(a);this.accept(a);for(var c=[],e=0,f=a.nodePaths.length;e<f;e++){var g=a.nodePaths[e];g.length===0?c.push(osg.Matrix.makeIdentity()):c.push(osg.computeLocalToWorld(g))}return c}};osg.Node.prototype.objectType=osg.objectType.generate("Node");osg.NodeVisitor=function(a){this.traversalMask=-1;this.nodeMaskOverride=0;this.traversalMode=a;if(a===void 0)this.traversalMode=osg.NodeVisitor.TRAVERSE_ALL_CHILDREN;this.nodePath=[]};osg.NodeVisitor.TRAVERSE_PARENTS=1;
osg.NodeVisitor.TRAVERSE_ALL_CHILDREN=2;osg.NodeVisitor._traversalFunctions={};osg.NodeVisitor._traversalFunctions[osg.NodeVisitor.TRAVERSE_PARENTS]=function(a){a.ascend(this)};osg.NodeVisitor._traversalFunctions[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(a){a.traverse(this)};osg.NodeVisitor._pushOntoNodePath={};osg.NodeVisitor._pushOntoNodePath[osg.NodeVisitor.TRAVERSE_PARENTS]=function(a){this.nodePath.unshift(a)};osg.NodeVisitor._pushOntoNodePath[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(a){this.nodePath.push(a)};
osg.NodeVisitor._popFromNodePath={};osg.NodeVisitor._popFromNodePath[osg.NodeVisitor.TRAVERSE_PARENTS]=function(){return this.nodePath.shift()};osg.NodeVisitor._popFromNodePath[osg.NodeVisitor.TRAVERSE_ALL_CHILDREN]=function(){this.nodePath.pop()};
osg.NodeVisitor.prototype={setTraversalMask:function(a){this.traversalMask=a},getTraversalMask:function(){return this.traversalMask},pushOntoNodePath:function(a){osg.NodeVisitor._pushOntoNodePath[this.traversalMode].call(this,a)},popFromNodePath:function(){osg.NodeVisitor._popFromNodePath[this.traversalMode].call(this)},validNodeMask:function(a){return(this.traversalMask&(this.nodeMaskOverride|a.getNodeMask()))!==0},apply:function(a){this.traverse(a)},traverse:function(a){osg.NodeVisitor._traversalFunctions[this.traversalMode].call(this,
a)}};osg.Transform=function(){osg.Node.call(this);this.referenceFrame=osg.Transform.RELATIVE_RF};osg.Transform.RELATIVE_RF=0;osg.Transform.ABSOLUTE_RF=1;
osg.Transform.prototype=osg.objectInehrit(osg.Node.prototype,{setReferenceFrame:function(a){this.referenceFrame=a},getReferenceFrame:function(){return this.referenceFrame},computeBound:function(a){osg.Node.prototype.computeBound.call(this,a);if(!a.valid())return a;var c=osg.Matrix.makeIdentity();this.computeLocalToWorldMatrix(c);var e=osg.Vec3.copy(a._center,[]);e[0]+=a._radius;osg.Matrix.transformVec3(c,e,e);var f=osg.Vec3.copy(a._center,[]);f[1]+=a._radius;osg.Matrix.transformVec3(c,f,f);var g=
osg.Vec3.copy(a._center,[]);g[2]+=a._radius;osg.Matrix.transformVec3(c,g,g);osg.Matrix.transformVec3(c,a._center,a._center);osg.Vec3.sub(e,a._center,e);c=osg.Vec3.length(e);osg.Vec3.sub(f,a._center,f);f=osg.Vec3.length(f);osg.Vec3.sub(g,a._center,g);g=osg.Vec3.length(g);a._radius=c;if(a._radius<f)a._radius=f;if(a._radius<g)a._radius=g;return a}});
osg.computeLocalToWorld=function(a,c){var e=c;e===void 0&&(e=!0);var f=osg.Matrix.makeIdentity(),g=0;if(e)for(g=a.length-1;g>0;g--)if(e=a[g],e.objectType===osg.Camera.prototype.objectType&&(e.getReferenceFrame!==osg.Transform.RELATIVE_RF||e.getParents().length===0))break;for(e=a.length;g<e;g++){var h=a[g];h.computeLocalToWorldMatrix&&h.computeLocalToWorldMatrix(f)}return f};
osg.BlendFunc=function(a,c){osg.StateAttribute.call(this);this.sourceFactor="ONE";this.destinationFactor="ZERO";if(a!==void 0)this.sourceFactor=a;if(c!==void 0)this.destinationFactor=c};osg.BlendFunc.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"BlendFunc",cloneType:function(){return new osg.BlendFunc},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(){gl.blendFunc(gl[this.sourceFactor],gl[this.destinationFactor])}});
osg.BoundingBox=function(){this._min=[1,1,1];this._max=[0,0,0]};
osg.BoundingBox.prototype={init:function(){this._min=[1,1,1];this._max=[0,0,0]},valid:function(){return this._max[0]>=this._min[0]&&this._max[1]>=this._min[1]&&this._max[2]>=this._min[2]},expandBySphere:function(a){a.valid()&&(a._center[0]-a._radius<this._min[0]&&(this._min[0]=a._center[0]-a._radius),a._center[0]+a._radius>this._max[0]&&(this._max[0]=a._center[0]+a._radius),a._center[1]-a._radius<this._min[1]&&(this._min[1]=a._center[1]-a._radius),a._center[1]+a._radius>this._max[1]&&(this._max[1]=
a._center[1]+a._radius),a._center[2]-a._radius<this._min[2]&&(this._min[2]=a._center[2]-a._radius),a._center[2]+a._radius>this._max[2]&&(this._max[2]=a._center[2]+a._radius))},expandByVec3:function(a){this.valid()?(this._min[0]>a[0]&&(this._min[0]=a[0]),this._min[1]>a[1]&&(this._min[1]=a[1]),this._min[2]>a[2]&&(this._min[2]=a[2]),this._max[0]<a[0]&&(this._max[0]=a[0]),this._max[1]<a[1]&&(this._max[1]=a[1]),this._max[2]<a[2]&&(this._max[2]=a[2])):(this._min[0]=a[0],this._min[1]=a[1],this._min[2]=a[2],
this._max[0]=a[0],this._max[1]=a[1],this._max[2]=a[2])},center:function(){return osg.Vec3.mult(osg.Vec3.add(this._min,this._max,[]),0.5,[])},radius:function(){return Math.sqrt(this.radius2())},radius2:function(){return 0.25*osg.Vec3.length2(osg.Vec3.sub(this._max,this._min,[]))},corner:function(a){ret=[0,0,0];ret[0]=a&1?this._max[0]:this._min[0];ret[1]=a&2?this._max[1]:this._min[1];ret[2]=a&4?this._max[2]:this._min[2];return ret}};osg.BoundingSphere=function(){this._center=[0,0,0];this._radius=-1};
osg.BoundingSphere.prototype={init:function(){this._center=[0,0,0];this._radius=-1},valid:function(){return this._radius>=0},set:function(a,c){this._center=a;this._radius=c},center:function(){return this._center},radius:function(){return this._radius},radius2:function(){return this._radius*this._radius},expandByBox:function(a){if(a.valid()){var c;if(this.valid()){var e=new osg.BoundingBox;e._min[0]=a._min[0];e._min[1]=a._min[1];e._min[2]=a._min[2];e._max[0]=a._max[0];e._max[1]=a._max[1];e._max[2]=
a._max[2];for(var f=0;f<8;f++){var g=osg.Vec3.sub(a.corner(c),this._center,[]);osg.Vec3.normalize(g,g);nv[0]*=-this._radius;nv[1]*=-this._radius;nv[2]*=-this._radius;nv[0]+=this._center[0];nv[1]+=this._center[1];nv[2]+=this._center[2];e.expandBy(nv)}c=e.center();this._center[0]=c[0];this._center[1]=c[1];this._center[2]=c[2];this._radius=e.radius()}else c=a.center(),this._center[0]=c[0],this._center[1]=c[1],this._center[2]=c[2],this._radius=a.radius()}},expandByVec3:function(a){this.valid()?(a=osg.Vec3.sub(a,
this.center(),[]),r=osg.Vec3.length(a),r>this.radius()&&(dr=(r-this.radius())*0.5,this._center[0]+=a[0]*(dr/r),this._center[1]+=a[1]*(dr/r),this._center[2]+=a[2]*(dr/r),this._radius+=dr)):(this._center[0]=a[0],this._center[1]=a[1],this._center[2]=a[2],this._radius=0)},expandRadiusBySphere:function(a){if(a.valid())if(this.valid()){var c=osg.Vec3.sub,e=osg.Vec3.length,a=e(c(a._center,this._center,[]))+a._radius;if(a>this._radius)this._radius=a}else this._center=osg.Vec3.copy(a._center,[]),this._radius=
a._radius},expandBy:function(a){if(a.valid())if(this.valid()){var c=osg.Vec3.sub(this.center(),a.center(),[]);d=osg.Vec3.length(c);if(!(d+a.radius()<=this.radius()))d+this.radius()<=a.radius()?(this._center[0]=a._center[0],this._center[1]=a._center[1],this._center[2]=a._center[2],this._radius=a._radius):(new_radius=(this.radius()+d+a.radius())*0.5,ratio=(new_radius-this.radius())/d,this._center[0]+=(a._center[0]-this._center[0])*ratio,this._center[1]+=(a._center[1]-this._center[1])*ratio,this._center[2]+=
(a._center[2]-this._center[2])*ratio,this._radius=new_radius)}else this._center[0]=a._center[0],this._center[1]=a._center[1],this._center[2]=a._center[2],this._radius=a.radius()},contains:function(a){a=osg.Vec3.sub(a,this.center(),[]);return valid()&&osg.Vec3.length2(a)<=radius2()},intersects:function(a){var c=osg.Vec3.length2(osg.Vec3.sub(this.center(),a.center(),[]));return valid()&&a.valid()&&c<=(this.radius()+a.radius())*(this.radius()+a.radius())}};
osg.BufferArray=function(a,c,e){if(osg.BufferArray.instanceID===void 0)osg.BufferArray.instanceID=0;this.instanceID=osg.BufferArray.instanceID;osg.BufferArray.instanceID+=1;this.dirty();this.itemSize=e;this.type=a;this.elements=this.type===gl.ELEMENT_ARRAY_BUFFER?new osg.Uint16Array(c):new osg.Float32Array(c)};
osg.BufferArray.prototype={init:function(){if(!this.buffer&&this.elements.length>0)this.buffer=gl.createBuffer(),this.buffer.itemSize=this.itemSize,this.buffer.numItems=this.elements.length/this.itemSize},dirty:function(){this._dirty=!0},isDirty:function(){return this._dirty},compile:function(){if(this._dirty)gl.bufferData(this.type,this.elements,gl.STATIC_DRAW),this._dirty=!1},getElements:function(){return this.elements}};
osg.BufferArray.create=function(a,c,e){osg.log("osg.BufferArray.create is deprecated, use new osg.BufferArray with same arguments instead");return new osg.BufferArray(a,c,e)};osg.CullFace=function(a){osg.StateAttribute.call(this);this.mode="BACK";if(a!==void 0)this.mode=a};
osg.CullFace.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"CullFace",cloneType:function(){return new osg.CullFace},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(){this.mode==="DISABLE"?gl.disable(gl.CULL_FACE):(gl.enable(gl.CULL_FACE),gl.cullFace(gl[this.mode]));this._dirty=!1}});
osg.CullSettings=function(){this.computeNearFar=!0;this.nearFarRatio=5.0E-4;var a=[0,0,-1];this.bbCornerFar=(a[0]>=0?1:0)|(a[1]>=0?2:0)|(a[2]>=0?4:0);this.bbCornerNear=~this.bbCornerFar&7};osg.CullSettings.prototype={setCullSettings:function(a){this.computeNearFar=a.computeNearFar;this.nearFarRatio=a.nearFarRatio},setNearFarRatio:function(a){this.nearFarRatio=a},getNearFarRatio:function(){return this.nearFarRatio},setComputeNearFar:function(a){this.computeNearFar=a},getComputeNearFar:function(){return this.computeNearFar}};
osg.Camera=function(){osg.Transform.call(this);osg.CullSettings.call(this);this.viewport=void 0;this.setClearColor([0,0,0,1]);this.setClearDepth(1);this.setClearMask(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT);this.setViewMatrix(osg.Matrix.makeIdentity());this.setProjectionMatrix(osg.Matrix.makeIdentity());this.renderOrder=osg.Camera.NESTED_RENDER;this.renderOrderNum=0};osg.Camera.PRE_RENDER=0;osg.Camera.NESTED_RENDER=1;osg.Camera.POST_RENDER=2;
osg.Camera.prototype=osg.objectInehrit(osg.CullSettings.prototype,osg.objectInehrit(osg.Transform.prototype,{setClearDepth:function(a){this.clearDepth=a},getClearDepth:function(){return this.clearDepth},setClearMask:function(a){this.clearMask=a},getClearMask:function(){return this.clearMask},setClearColor:function(a){this.clearColor=a},getClearColor:function(){return this.clearColor},setViewport:function(a){this.viewport=a;this.getOrCreateStateSet().setAttributeAndMode(a)},getViewport:function(){return this.viewport},
setViewMatrix:function(a){this.modelviewMatrix=a},setProjectionMatrix:function(a){this.projectionMatrix=a},setProjectionMatrixAsOrtho:function(a,c,e,f,g,h){osg.Matrix.makeOrtho(a,c,e,f,g,h,this.getProjectionMatrix())},getViewMatrix:function(){return this.modelviewMatrix},getProjectionMatrix:function(){return this.projectionMatrix},getRenderOrder:function(){return this.renderOrder},setRenderOrder:function(a,c){this.renderOrder=a;this.renderOrderNum=c},attachTexture:function(a,c,e){this.frameBufferObject&&
this.frameBufferObject.dirty();e===void 0&&(e=0);if(this.attachments===void 0)this.attachments={};this.attachments[a]={texture:c,level:e}},attachRenderBuffer:function(a,c){this.frameBufferObject&&this.frameBufferObject.dirty();if(this.attachments===void 0)this.attachments={};this.attachments[a]={format:c}},computeLocalToWorldMatrix:function(a){this.referenceFrame===osg.Transform.RELATIVE_RF&&osg.Matrix.preMult(a,this.modelviewMatrix);return!0},computeWorldToLocalMatrix:function(a){var c=osg.Matrix.inverse(this.modelviewMatrix);
this.referenceFrame===osg.Transform.RELATIVE_RF&&osg.Matrix.postMult(c,a);return!0}}));osg.Camera.prototype.objectType=osg.objectType.generate("Camera");osg.Depth=function(a,c,e,f){osg.StateAttribute.call(this);this.func="LESS";this.near=0;this.far=1;this.writeMask=!0;if(a!==void 0)this.func=a;if(c!==void 0)this.near=c;if(e!==void 0)this.far=e;if(f!==void 0)this.writeMask=e};
osg.Depth.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Depth",cloneType:function(){return new osg.Depth},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setRange:function(a,c){this.near=a;this.far=c},setWriteMask:function(a){this.mask=a},apply:function(){this.func==="DISABLE"?gl.disable(gl.DEPTH_TEST):(gl.enable(gl.DEPTH_TEST),gl.depthFunc(gl[this.func]),gl.depthMask(this.writeMask),gl.depthRange(this.near,this.far))}});
osg.WGS_84_RADIUS_EQUATOR=6378137;osg.WGS_84_RADIUS_POLAR=6356752.3142;osg.EllipsoidModel=function(){this._radiusEquator=osg.WGS_84_RADIUS_EQUATOR;this._radiusPolar=osg.WGS_84_RADIUS_POLAR;this.computeCoefficients()};
osg.EllipsoidModel.prototype={setRadiusEquator:function(){this._radiusEquator=radius;this.computeCoefficients()},getRadiusEquator:function(){return this._radiusEquator},setRadiusPolar:function(a){this._radiusPolar=a;this.computeCoefficients()},getRadiusPolar:function(){return this._radiusPolar},convertLatLongHeightToXYZ:function(a,c,e){var f=Math.sin(a),a=Math.cos(a),g=this._radiusEquator/Math.sqrt(1-this._eccentricitySquared*f*f);return[(g+e)*a*Math.cos(c),(g+e)*a*Math.sin(c),(g*(1-this._eccentricitySquared)+
e)*f]},convertXYZToLatLongHeight:function(a,c,e){var f=Math.sqrt(a*a+c*c),g=Math.atan2(e*this._radiusEquator,f*this._radiusPolar),h=Math.sin(g),g=Math.cos(g);latitude=Math.atan((e+(this._radiusEquator*this._radiusEquator-this._radiusPolar*this._radiusPolar)/(this._radiusPolar*this._radiusPolar)*this._radiusPolar*h*h*h)/(f-this._eccentricitySquared*this._radiusEquator*g*g*g));longitude=Math.atan2(c,a);a=Math.sin(latitude);height=f/Math.cos(latitude)-this._radiusEquator/Math.sqrt(1-this._eccentricitySquared*
a*a);return[latitude,longitude,height]},computeLocalUpVector:function(a,c,e){var f,g,a=this.convertXYZToLatLongHeight(a,c,e,f,g,void 0);f=a[0];g=a[1];return[Math.cos(g)*Math.cos(f),Math.sin(g)*Math.cos(f),Math.sin(f)]},isWGS84:function(){return this._radiusEquator==osg.WGS_84_RADIUS_EQUATOR&&this._radiusPolar==osg.WGS_84_RADIUS_POLAR},computeCoefficients:function(){var a=(this._radiusEquator-this._radiusPolar)/this._radiusEquator;this._eccentricitySquared=2*a-a*a},computeLocalToWorldTransformFromLatLongHeight:function(a,
c,e){e=this.convertLatLongHeightToXYZ(a,c,e);e=osg.Matrix.makeTranslate(e[0],e[1],e[2],[]);this.computeCoordinateFrame(a,c,e);return e},computeLocalToWorldTransformFromXYZ:function(a,c,e){var f=this.convertXYZToLatLongHeight(a,c,e),a=osg.Matrix.makeTranslate(a,c,e);this.computeCoordinateFrame(f[0],f[1],a);return a},computeCoordinateFrame:function(a,c,e){var a=[Math.cos(c)*Math.cos(a),Math.sin(c)*Math.cos(a),Math.sin(a)],c=[-Math.sin(c),Math.cos(c),0],f=osg.Vec3.cross(a,c,[]);osg.Matrix.set(e,0,0,
c[0]);osg.Matrix.set(e,0,1,c[1]);osg.Matrix.set(e,0,2,c[2]);osg.Matrix.set(e,1,0,f[0]);osg.Matrix.set(e,1,1,f[1]);osg.Matrix.set(e,1,2,f[2]);osg.Matrix.set(e,2,0,a[0]);osg.Matrix.set(e,2,1,a[1]);osg.Matrix.set(e,2,2,a[2])}};osg.FrameBufferObject=function(){osg.StateAttribute.call(this);this.fbo=void 0;this.attachments=[];this.dirty()};
osg.FrameBufferObject.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"FrameBufferObject",cloneType:function(){return new osg.FrameBufferObject},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setAttachment:function(a){this.attachments.push(a)},apply:function(a){if(this.attachments.length>0)if(this.isDirty()){if(!this.fbo)this.fbo=gl.createFramebuffer();gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo);for(var c=!1,e=0,f=this.attachments.length;e<
f;++e)if(this.attachments[e].texture===void 0)c=gl.createRenderbuffer(),gl.bindRenderbuffer(gl.RENDERBUFFER,c),gl.renderbufferStorage(gl.RENDERBUFFER,this.attachments[e].format,this.attachments[e].width,this.attachments[e].height),gl.framebufferRenderbuffer(gl.FRAMEBUFFER,this.attachments[e].attachment,gl.RENDERBUFFER,c),c=!0;else{var g=this.attachments[e].texture;a.applyTextureAttribute(0,g);gl.framebufferTexture2D(gl.FRAMEBUFFER,this.attachments[e].attachment,gl[g.target],g.textureObject,this.attachments[e].level)}a=
gl.checkFramebufferStatus(gl.FRAMEBUFFER);a!==36053&&osg.log("framebuffer error check "+a);c&&gl.bindRenderbuffer(null);this.setDirty(!1)}else gl.bindFramebuffer(gl.FRAMEBUFFER,this.fbo),osg.reportErrorGL===!0&&(a=gl.checkFramebufferStatus(gl.FRAMEBUFFER),a!==36053&&osg.log("framebuffer error check "+a));else gl.bindFramebuffer(gl.FRAMEBUFFER,null)}});
osg.FrameStamp=function(){var a=0,c=0,e=0;this.setReferenceTime=function(a){c=a};this.setSimulationTime=function(a){e=a};this.getReferenceTime=function(){return c};this.getSimulationTime=function(){return e};this.setFrameNumber=function(c){a=c};this.getFrameNumber=function(){return a}};osg.Geometry=function(){osg.Node.call(this);this.primitives=[];this.attributes={};this.boundingBox=new osg.BoundingBox;this.boundingBoxComputed=!1;this.cacheAttributeList={}};
osg.Geometry.prototype=osg.objectInehrit(osg.Node.prototype,{dirtyBound:function(){if(this.boundingBoxComputed===!0)this.boundingBoxComputed=!1;osg.Node.dirtyBound.call(this)},dirty:function(){this.cacheAttributeList={}},getPrimitives:function(){return this.primitives},getAttributes:function(){return this.attributes},drawImplementation:function(a){var c=a.getLastProgramApplied(),e=c.instanceID;if(this.cacheAttributeList[e]===void 0){var f=c.attributesCache,g=[],h="//generated by Geometry::implementation\nfunction(state) {\n";
h+="state.lazyDisablingOfVertexAttributes();\n";for(var k=0,i=f.attributeKeys.length;k<i;k++){var m=f.attributeKeys[k],c=f[m];this.attributes[m]!==void 0&&(g.push(c),h+="state.setVertexAttribArray("+c+', this.attributes["'+m+'"], false);\n')}h+="state.applyDisablingOfVertexAttributes();\n";f=this.primitives;h+="var primitives = this.primitives;\n";c=0;for(f=f.length;c<f;++c)h+="primitives["+c+"].draw(state);\n";h+="}";this.cacheAttributeList[e]=function(){eval("var drawImplementationAutogenerated = "+
h+";");return drawImplementationAutogenerated}()}this.cacheAttributeList[e].call(this,a)},drawImplementationDummy:function(a){a.getLastProgramApplied();for(var a=0,c=this.primitives.length;a<c;++a);},getBoundingBox:function(){if(!this.boundingBoxComputed)this.computeBoundingBox(this.boundingBox),this.boundingBoxComputed=!0;return this.boundingBox},computeBoundingBox:function(a){var c=this.getAttributes();if(c.Vertex.itemSize==3){vertexes=c.Vertex.getElements();for(var c=0,e=vertexes.length;c<e;c+=
3)a.expandByVec3([vertexes[c],vertexes[c+1],vertexes[c+2]])}return a},computeBound:function(a){a.init();var c=this.getBoundingBox();a.expandByBox(c);return a}});osg.Geometry.prototype.objectType=osg.objectType.generate("Geometry");
osg.Light=function(){osg.StateAttribute.call(this);this.ambient=[0.2,0.2,0.2,1];this.diffuse=[0.8,0.8,0.8,1];this.specular=[0,0,0,1];this.direction=[0,0,1];this.quadratic_attenuation=this.linear_attenuation=this.constant_attenuation=1;this.enabled=this.light_unit=0;this.ambient=[1,1,1,1];this.diffuse=[1,1,1,1];this.specular=[1,1,1,1];this._dirty=!0};
osg.Light.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Light",cloneType:function(){return new osg.Light},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType+this.light_unit},getOrCreateUniforms:function(){if(osg.Light.uniforms===void 0)osg.Light.uniforms={};if(osg.Light.uniforms[this.getTypeMember()]===void 0){osg.Light.uniforms[this.getTypeMember()]={ambient:osg.Uniform.createFloat4([0.2,0.2,0.2,1],this.getParameterName("ambient")),
diffuse:osg.Uniform.createFloat4([0.8,0.8,0.8,1],this.getParameterName("diffuse")),specular:osg.Uniform.createFloat4([0.2,0.2,0.2,1],this.getParameterName("specular")),direction:osg.Uniform.createFloat3([0,0,1],this.getParameterName("direction")),constant_attenuation:osg.Uniform.createFloat1(0,this.getParameterName("constant_attenuation")),linear_attenuation:osg.Uniform.createFloat1(0,this.getParameterName("linear_attenuation")),quadratic_attenuation:osg.Uniform.createFloat1(0,this.getParameterName("quadratic_attenuation")),
enable:osg.Uniform.createInt1(0,this.getParameterName("enable")),matrix:osg.Uniform.createMatrix4(osg.Matrix.makeIdentity(),this.getParameterName("matrix"))};var a=[],c;for(c in osg.Light.uniforms[this.getTypeMember()])a.push(c);osg.Light.uniforms[this.getTypeMember()].uniformKeys=a}return osg.Light.uniforms[this.getTypeMember()]},getPrefix:function(){return this.getType()+this.light_unit},getParameterName:function(a){return this.getPrefix()+"_"+a},applyPositionedUniform:function(a){this.getOrCreateUniforms().matrix.set(a)},
apply:function(){var a=this.getOrCreateUniforms();a.ambient.set(this.ambient);a.diffuse.set(this.diffuse);a.specular.set(this.specular);a.direction.set(this.direction);a.constant_attenuation.set([this.constant_attenuation]);a.linear_attenuation.set([this.linear_attenuation]);a.quadratic_attenuation.set([this.quadratic_attenuation]);a.enable.set([this.enable]);this._dirty=!1},writeShaderInstance:function(a){var c="";switch(a){case osg.ShaderGeneratorType.VertexInit:c="\nvarying vec4 LightColor;\nvec3 EyeVector;\nvec3 NormalComputed;\n\n";
break;case osg.ShaderGeneratorType.VertexFunction:c="\nvec3 computeNormal() {\n   return vec3(NormalMatrix * vec4(Normal, 0.0));\n}\n\nvec3 computeEyeDirection() {\n   return vec3(ModelViewMatrix * vec4(Vertex,1.0));\n}\n\nvoid directionalLight(in vec3 lightDirection, in vec3 lightHalfVector, in float constantAttenuation, in float linearAttenuation, in float quadraticAttenuation, in vec4 ambient, in vec4 diffuse,in vec4 specular, in vec3 normal)\n{\n   float nDotVP;         // normal . light direction\n   float nDotHV;         // normal . light half vector\n   float pf;             // power factor\n\n   nDotVP = max(0.0, dot(normal, normalize(lightDirection)));\n   nDotHV = max(0.0, dot(normal, lightHalfVector));\n\n   if (nDotHV == 0.0)\n   {\n       pf = 0.0;\n   }\n   else\n   {\n       pf = pow(nDotHV, MaterialShininess);\n   }\n   Ambient  += ambient;\n   Diffuse  += diffuse * nDotVP;\n   Specular += specular * pf;\n}\n\nvoid flight(in vec3 lightDirection, in float constantAttenuation, in float linearAttenuation, in float quadraticAttenuation, in vec4 ambient, in vec4 diffuse, in vec4 specular, in vec3 normal)\n{\n    vec4 localColor;\n    vec3 lightHalfVector = normalize(EyeVector-lightDirection);\n    // Clear the light intensity accumulators\n    Ambient  = vec4 (0.0);\n    Diffuse  = vec4 (0.0);\n    Specular = vec4 (0.0);\n\n    directionalLight(lightDirection, lightHalfVector, constantAttenuation, linearAttenuation, quadraticAttenuation, ambient, diffuse, specular, normal);\n\n    vec4 sceneColor = vec4(0,0,0,0);\n    localColor = sceneColor +\n      MaterialEmission +\n      Ambient  * MaterialAmbient +\n      Diffuse  * MaterialDiffuse;\n      //Specular * MaterialSpecular;\n    localColor = clamp( localColor, 0.0, 1.0 );\n    LightColor += localColor;\n\n}";
break;case osg.ShaderGeneratorType.VertexMain:c="\nEyeVector = computeEyeDirection();\nNormalComputed = computeNormal();\nLightColor = vec4(0,0,0,0);\n";break;case osg.ShaderGeneratorType.FragmentInit:c="varying vec4 LightColor;\n";break;case osg.ShaderGeneratorType.FragmentMain:c="\nfragColor *= LightColor;"}return c},writeToShader:function(a){var c="";switch(a){case osg.ShaderGeneratorType.VertexInit:c=["","uniform bool "+this.getParameterName("enabled")+";","uniform vec4 "+this.getParameterName("ambient")+
";","uniform vec4 "+this.getParameterName("diffuse")+";","uniform vec4 "+this.getParameterName("specular")+";","uniform vec3 "+this.getParameterName("direction")+";","uniform float "+this.getParameterName("constantAttenuation")+";","uniform float "+this.getParameterName("linearAttenuation")+";","uniform float "+this.getParameterName("quadraticAttenuation")+";","\n"].join("\n");break;case osg.ShaderGeneratorType.VertexMain:var a=this.getParameterName("direction"),c=this.getParameterName("directionNormalized"),
e=this.getParameterName("NdotL"),c=["","//if ("+this.getParameterName("enabled")+") {","if (true) {","  vec3 "+c+" = normalize("+a+");","  float "+e+" = max(dot(Normal, "+c+"), 0.0);","  flight("+c+", "+this.getParameterName("constantAttenuation")+", "+this.getParameterName("linearAttenuation")+", "+this.getParameterName("quadraticAttenuation")+", "+this.getParameterName("ambient")+", "+this.getParameterName("diffuse")+", "+this.getParameterName("specular")+", NormalComputed );","}\n"].join("\n")}return c}});
osg.LineWidth=function(a){osg.StateAttribute.call(this);this.lineWidth=1;if(a!==void 0)this.lineWidth=a};osg.LineWidth.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"LineWidth",cloneType:function(){return new osg.LineWidth},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(){gl.lineWidth(this.lineWidth)}});
osg.Material=function(){osg.StateAttribute.call(this);this.ambient=[0.2,0.2,0.2,1];this.diffuse=[0.8,0.8,0.8,1];this.specular=[0,0,0,1];this.emission=[0,0,0,1];this.shininess=[0];this._dirty=!0};
osg.Material.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{setAmbient:function(a){this.ambient=a;this._dirty=!0},setSpecular:function(a){this.specular=a;this._dirty=!0},setDiffuse:function(a){this.diffuse=a;this._dirty=!0},attributeType:"Material",cloneType:function(){return new osg.Material},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},getOrCreateUniforms:function(){if(osg.Material.uniforms===void 0){osg.Material.uniforms={ambient:osg.Uniform.createFloat4([0,
0,0,0],"MaterialAmbient"),diffuse:osg.Uniform.createFloat4([0,0,0,0],"MaterialDiffuse"),specular:osg.Uniform.createFloat4([0,0,0,0],"MaterialSpecular"),emission:osg.Uniform.createFloat4([0,0,0,0],"MaterialEmission"),shininess:osg.Uniform.createFloat1([0],"MaterialShininess")};var a=[],c;for(c in osg.Material.uniforms)a.push(c);osg.Material.uniforms.uniformKeys=a}return osg.Material.uniforms},apply:function(){var a=this.getOrCreateUniforms();a.ambient.set(this.ambient);a.diffuse.set(this.diffuse);
a.specular.set(this.specular);a.emission.set(this.emission);a.shininess.set(this.shininess);this._dirty=!1},writeToShader:function(a){var c="";switch(a){case osg.ShaderGeneratorType.VertexInit:c="uniform vec4 MaterialAmbient;\nuniform vec4 MaterialDiffuse;\nuniform vec4 MaterialSpecular;\nuniform vec4 MaterialEmission;\nuniform float MaterialShininess;\nvec4 Ambient;\nvec4 Diffuse;\nvec4 Specular;\n"}return c}});osg.MatrixTransform=function(){osg.Transform.call(this);this.matrix=osg.Matrix.makeIdentity()};
osg.MatrixTransform.prototype=osg.objectInehrit(osg.Transform.prototype,{getMatrix:function(){return this.matrix},setMatrix:function(a){this.matrix=a},computeLocalToWorldMatrix:function(a){this.referenceFrame===osg.Transform.RELATIVE_RF&&osg.Matrix.preMult(a,this.matrix);return!0},computeWorldToLocalMatrix:function(a){var c=osg.Matrix.inverse(this.matrix);this.referenceFrame===osg.Transform.RELATIVE_RF&&osg.Matrix.postMult(c,a);return!0}});osg.MatrixTransform.prototype.objectType=osg.objectType.generate("MatrixTransform");
osg.DrawArrays=function(a,c,e){this.mode=a;this.first=c;this.count=e};osg.DrawArrays.prototype={draw:function(){gl.drawArrays(this.mode,this.first,this.count)},getMode:function(){return this.mode},getCount:function(){return this.count},getFirst:function(){return this.first}};osg.DrawArrays.create=function(a,c,e){osg.log("osg.DrawArrays.create is deprecated, use new osg.DrawArrays with same arguments");return new osg.DrawArray(a,c,e)};
osg.DrawElements=function(a,c){this.mode=gl.POINTS;if(a!==void 0)this.mode=a;this.offset=this.count=0;this.indices=c;if(c!==void 0)this.count=c.elements.length};osg.DrawElements.prototype={getMode:function(){return this.mode},draw:function(a){a.setIndexArray(this.indices);gl.drawElements(this.mode,this.count,gl.UNSIGNED_SHORT,this.offset)},getIndices:function(){return this.indices},setFirst:function(a){this.offset=a},getFirst:function(){return this.offset},setCount:function(a){this.count=a},getCount:function(){return this.count}};
osg.DrawElements.create=function(a,c){osg.log("osg.DrawElements.create is deprecated, use new osg.DrawElements with same arguments");return new osg.DrawElements(a,c)};osg.Program=function(a,c){if(osg.Program.instanceID===void 0)osg.Program.instanceID=0;this.instanceID=osg.Program.instanceID;this._dirty=!0;osg.Program.instanceID+=1;this.program=null;this.vertex=a;this.fragment=c;this.dirty=!0};
osg.Program.prototype={isDirty:function(){return this._dirty},attributeType:"Program",cloneType:function(){var a=new osg.Program;a.default_program=!0;return a},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},setVertexShader:function(a){program.vertex=a},setFragmentShader:function(a){program.fragment=a},apply:function(){if(!this.program||this._dirty){if(this.default_program===!0)return;this.vertex.shader||this.vertex.compile();this.fragment.shader||
this.fragment.compile();this.program=gl.createProgram();gl.attachShader(this.program,this.vertex.shader);gl.attachShader(this.program,this.fragment.shader);gl.linkProgram(this.program);gl.validateProgram(this.program);if(!gl.getProgramParameter(this.program,gl.LINK_STATUS)){osg.log("can't link program\nvertex shader:\n"+this.vertex.text+"\n fragment shader:\n"+this.fragment.text);osg.log(gl.getProgramInfoLog(this.program));debugger;return null}this.uniformsCache={};this.uniformsCache.uniformKeys=
[];this.attributesCache={};this.attributesCache.attributeKeys=[];this.cacheUniformList(this.vertex.text);this.cacheUniformList(this.fragment.text);this.cacheAttributeList(this.vertex.text);this._dirty=!1}gl.useProgram(this.program)},cacheUniformList:function(a){a=a.match(/uniform\s+\w+\s+\w+/g);if(a!==null)for(var c=0,e=a.length;c<e;c++){var f=a[c].match(/uniform\s+\w+\s+(\w+)/)[1],g=gl.getUniformLocation(this.program,f);g!==void 0&&g!==null&&this.uniformsCache[f]===void 0&&(this.uniformsCache[f]=
g,this.uniformsCache.uniformKeys.push(f))}},cacheAttributeList:function(a){a=a.match(/attribute\s+\w+\s+\w+/g);if(a!==null)for(var c=0,e=a.length;c<e;c++){var f=a[c].match(/attribute\s+\w+\s+(\w+)/)[1],g=gl.getAttribLocation(this.program,f);g!==-1&&g!==void 0&&this.attributesCache[f]===void 0&&(this.attributesCache[f]=g,this.attributesCache.attributeKeys.push(f))}}};
osg.Program.create=function(a,c){console.log("osg.Program.create is deprecated use new osg.Program(vertex, fragment) instead");return new osg.Program(a,c)};osg.Projection=function(){osg.Node.call(this);this.projection=osg.Matrix.makeIdentity()};osg.Projection.prototype=osg.objectInehrit(osg.Node.prototype,{getProjectionMatrix:function(){return this.projection},setProjectionMatrix:function(a){this.projection=a}});osg.Projection.prototype.objectType=osg.objectType.generate("Projection");
osg.Quat={makeIdentity:function(a){return osg.Quat.init(a)},init:function(a){a===void 0&&(a=[]);a[0]=0;a[1]=0;a[2]=0;a[3]=1;return a},sub:function(a,c,e){e===void 0&&(e=[]);e[0]=a[0]-c[0];e[1]=a[1]-c[1];e[2]=a[2]-c[2];e[3]=a[3]-c[3];return e},add:function(a,c,e){e===void 0&&(e=[]);e[0]=a[0]+c[0];e[1]=a[1]+c[1];e[2]=a[2]+c[2];e[3]=a[3]+c[3];return e},dot:function(a,c){return a[0]*c[0]+a[1]*c[1]+a[2]*c[2]+a[3]*c[3]},length2:function(a){return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},neg:function(a,
c){c===void 0&&(c=[]);c[0]=-a[0];c[1]=-a[1];c[2]=-a[2];c[3]=-a[3];return c},makeRotate:function(a,c,e,f,g){var h=Math.sqrt(c*c+e*e+f*f);if(h<1.0E-7)return this.init();var h=1/h,k=Math.cos(0.5*a),a=Math.sin(0.5*a);g===void 0&&(g=[]);g[0]=c*a*h;g[1]=e*a*h;g[2]=f*a*h;g[3]=k;return g},lerp:function(a,c,e,f){f===void 0&&(f=[]);e=1-a;f[0]=c[0]*e+quatTo[0]*a;f[1]=c[1]*e+quatTo[1]*a;f[2]=c[2]*e+quatTo[2]*a;f[3]=c[3]*e+quatTo[3]*a;return f},slerp:function(a,c,e,f){var g=e,h=this.dot(c,g);h<0&&(h=-h,g=this.neg(e));
var k;1-h>1.0E-5?(h=Math.acos(h),k=Math.sin(h),e=Math.sin((1-a)*h)/k,a=Math.sin(a*h)/k):e=1-a;f===void 0&&(f=[]);f[0]=c[0]*e+g[0]*a;f[1]=c[1]*e+g[1]*a;f[2]=c[2]*e+g[2]*a;f[3]=c[3]*e+g[3]*a;return f},conj:function(a,c){c===void 0&&(c=[]);c[0]=-a[0];c[1]=-a[1];c[2]=-a[2];c[3]=a[3];return c},inverse:function(a,c){c===void 0&&(c=[]);var e=1/this.length2(a);this.conj(a,c);c[0]*=e;c[1]*=e;c[2]*=e;c[3]*=e;return c},mult:function(a,c,e){e===void 0&&(e=[]);e[0]=a[0]*c[3]+a[1]*c[2]-a[2]*c[1]+a[3]*c[0];e[1]=
-a[0]*c[2]+a[1]*c[3]+a[2]*c[0]+a[3]*c[1];e[2]=a[0]*c[1]-a[1]*c[0]+a[2]*c[3]+a[3]*c[2];e[3]=-a[0]*c[0]-a[1]*c[1]-a[2]*c[2]+a[3]*c[3];return e},div:function(a,c,e){e===void 0&&(e=[]);c=1/c;e[0]=a[0]*c;e[1]=a[1]*c;e[2]=a[2]*c;e[3]=a[3]*c;return e},exp:function(a,c){var e=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),f=Math.exp(a[3]),g=0;e>1.0E-5&&(g=f*Math.sin(e)/e);c===void 0&&(c=[]);c[0]=g*a[0];c[1]=g*a[1];c[2]=g*a[2];c[3]=f*Math.cos(e);return c},ln:function(a,c){var e=a[0]*a[0]+a[1]*a[1]+a[2]*a[2],f=Math.sqrt(e),
g=0;f>1.0E-5&&(g=Math.atan2(f,a[3])/f);c===void 0&&(c=[]);e+=a[3]*a[3];c[0]=g*a[0];c[1]=g*a[1];c[2]=g*a[2];c[3]=0.5*Math.log(e);return c},squad:function(a,c,e,f,g,h){c=this.slerp(a,c,g);e=this.slerp(a,e,f);return this.slerp(2*a*(1-a),c,e,h)},computeTangent:function(a,c,e,f){f===void 0&&(f=[]);c=this.inv(c);this.mult(e,c,void 0);this.ln(void 0,void 0);this.mult(a,c,void 0);this.ln(void 0,void 0);this.add(void 0,void 0,void 0);this.div(void 0,-4,void 0);this.exp(void 0,void 0);return this.mult(void 0,
q1,f)},createKey:function(a,c){c===void 0?c=this.init():a!==c&&(c[0]=a[0],c[1]=a[1],c[2]=a[2],c[3]=a[3]);c.time=0;c.tangent=[];return c}};osg.RenderBin=function(a){this.leafs=[];this.stateGraph=a;this.positionedAttribute=[];this.renderStage=void 0;this.renderBin={};this.stateGraphList=[]};
osg.RenderBin.prototype={getStage:function(){return this.renderStage},addStateGraph:function(a){this.stateGraphList.push(a)},reset:function(){this.stateGraph=void 0;this.stateGraphList.length=0;this.renderBin={};this.positionedAttribute.length=0;this.leafs.length=0},applyPositionedAttribute:function(a,c){for(var e=0,f=c.length;e<f;e++){var g=c[e],h=g[1],g=g[0];a.setGlobalDefaultValue(h);h.applyPositionedUniform(g,a)}},drawImplementation:function(a,c){var e=c,f;for(f in this.renderBin)f<0&&(e=this.renderBin[f].drawImplementation(a,
e));e=this.drawLeafs(a,e);for(f in this.renderBin)f>=0&&(e=this.renderBin[f].drawImplementation(a,e));return e},drawLeafs:function(a,c){var e=this.stateGraphList,f,g,h,k=c,i=[],m=osg.Matrix;c&&osg.StateGraph.prototype.moveToRootStateGraph(a,c.parent);this.positionedAttribute&&this.applyPositionedAttribute(a,this.positionedAttribute);for(var n=0,o=e.length;n<o;n++)for(var p=e[n],q=0,t=p.leafs.length;q<t;q++){var s=p.leafs[q],u=!1;if(k!==void 0){var k=k.parent,y=k.parent,z=s.parent;y!==z.parent?(z.moveStateGraph(a,
y,z.parent),a.pushStateSet(z.stateset),u=!0):z!==k&&(a.pushStateSet(z.stateset),u=!0)}else s.parent.moveStateGraph(a,void 0,s.parent.parent),a.pushStateSet(s.parent.stateset),u=!0;u===!0&&(a.apply(),f=a.getLastProgramApplied(),g=f.uniformsCache[a.modelViewMatrix.name],h=f.uniformsCache[a.projectionMatrix.name],f=f.uniformsCache[a.normalMatrix.name]);g!==void 0&&(a.modelViewMatrix.set(s.modelview),a.modelViewMatrix.apply(g));h!==void 0&&(a.projectionMatrix.set(s.projection),a.projectionMatrix.apply(h));
f!==void 0&&(m.copy(s.modelview,i),i[12]=0,i[13]=0,i[14]=0,m.inverse(i,i),m.transpose(i,i),a.normalMatrix.set(i),a.normalMatrix.apply(f));s.geometry.drawImplementation(a);u===!0&&(a.popGeneratedProgram(),a.popStateSet());k=s}return k}};
osg.RenderStage=function(){osg.RenderBin.call(this);this.positionedAttribute=[];this.clearDepth=1;this.clearColor=[0,0,0,1];this.clearMask=gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT;this.viewport=this.camera=void 0;this.preRenderList=[];this.postRenderList=[];this.renderStage=this};
osg.RenderStage.prototype=osg.objectInehrit(osg.RenderBin.prototype,{reset:function(){osg.RenderBin.prototype.reset.call(this);this.preRenderList.length=0;this.postRenderList.length=0},setClearDepth:function(a){this.clearDepth=a},getClearDepth:function(){return this.clearDepth},setClearColor:function(a){this.clearColor=a},getClearColor:function(){return this.clearColor},setClearMask:function(a){this.clearMask=a},getClearMask:function(){return this.clearMask},setViewport:function(a){this.viewport=
a},getViewport:function(){return this.viewport},setCamera:function(a){this.camera=a},addPreRenderStage:function(a,c){for(var e=0,f=this.preRenderList.length;e<f;e++)if(c<this.preRenderList[e].order)break;e<this.preRenderList.length?this.preRenderList=this.preRenderList.splice(e,0,{order:c,renderStage:a}):this.preRenderList.push({order:c,renderStage:a})},addPostRenderStage:function(a,c){for(var e=0,f=this.postRenderList.length;e<f;e++)if(c<this.postRenderList[e].order)break;e<this.postRenderList.length?
this.postRenderList=this.postRenderList.splice(e,0,{order:c,renderStage:a}):this.postRenderList.push({order:c,renderStage:a})},drawPreRenderStages:function(a,c){for(var e=c,f=0,g=this.preRenderList.length;f<g;++f)e=this.preRenderList[f].renderStage.draw(a,e);return e},draw:function(a,c){var e=this.drawPreRenderStages(a,c),e=this.drawImplementation(a,e);return e=this.drawPostRenderStages(a,e)},drawPostRenderStages:function(a,c){for(var e=c,f=0,g=this.postRenderList.length;f<g;++f)e=this.postRenderList[f].renderStage.draw(a,
e);return e},applyCamera:function(a){if(this.camera===void 0)gl.bindFramebuffer(gl.FRAMEBUFFER,null);else{var c=this.camera.getViewport(),e=this.camera.frameBufferObject;if(!e)e=new osg.FrameBufferObject,this.camera.frameBufferObject=e;if(e.isDirty()&&this.camera.attachments!==void 0)for(var f in this.camera.attachments){var g=this.camera.attachments[f],h=void 0;if(g.texture===void 0)h={attachment:f,format:g.format,width:c.width(),height:c.height()};else if(g.texture!==void 0&&(h={attachment:f,texture:g.texture,
level:g.level},g.format))h.format=g.format;e.setAttachment(h)}e.apply(a)}},drawImplementation:function(a,c){var e;osg.reportErrorGL===!0&&(e=gl.getError(),osg.checkError(e));this.applyCamera(a);this.viewport===void 0&&osg.log("RenderStage does not have a valid viewport");a.applyAttribute(this.viewport);this.clearMask&gl.COLOR_BUFFER_BIT&&gl.clearColor(this.clearColor[0],this.clearColor[1],this.clearColor[2],this.clearColor[3]);this.clearMask&gl.DEPTH_BUFFER_BIT&&gl.clearDepth(this.clearDepth);gl.clear(this.clearMask);
this.positionedAttribute&&this.applyPositionedAttribute(a,this.positionedAttribute);var f=osg.RenderBin.prototype.drawImplementation.call(this,a,c);osg.reportErrorGL===!0&&(e=gl.getError(),osg.checkError(e));return f}});osg.ShaderGenerator=function(){this.cache=[]};
osg.ShaderGenerator.prototype={getActiveTypeMember:function(a){for(var c=[],e=0,f=a.attributeMap.attributeKeys.length;e<f;e++){var g=a.attributeMap.attributeKeys[e],h=a.attributeMap[g];h.length===0&&h.globalDefault.applyPositionedUniform===void 0||(h.globalDefault.getOrCreateUniforms!==void 0||h.globalDefault.writeToShader!==void 0)&&c.push(g)}e=0;for(f=a.textureAttributeMapList.length;e<f;e++)if(g=a.textureAttributeMapList[e],g!==void 0)for(var h=0,k=g.attributeKeys.length;h<k;h++){var i=g.attributeKeys[h],
m=g[i];m.length!==0&&(m.globalDefault.getOrCreateUniforms!==void 0||m.globalDefault.writeToShader!==void 0)&&c.push(i+e)}return c},getActiveAttributeMapKeys:function(a){for(var c=[],e=0,f=a.attributeMap.attributeKeys.length;e<f;e++){var g=a.attributeMap.attributeKeys[e],h=a.attributeMap[g];h.length===0&&h.globalDefault.applyPositionedUniform===void 0||(h.globalDefault.getOrCreateUniforms!==void 0||h.globalDefault.writeToShader!==void 0)&&c.push(g)}return c},getActiveTextureAttributeMapKeys:function(a){for(var c=
[],e=0,f=a.textureAttributeMapList.length;e<f;e++){var g=a.textureAttributeMapList[e];if(g!==void 0){c[e]=[];for(var h=0,k=g.attributeKeys.length;h<k;h++){var i=g.attributeKeys[h],m=g[i];m.length!==0&&(m.globalDefault.getOrCreateUniforms!==void 0||m.globalDefault.writeToShader!==void 0)&&c[e].push(i)}}}return c},getActiveUniforms:function(a,c,e){for(var f={},g=0,h=c.length;g<h;g++){var k=c[g];if(a.attributeMap[k].globalDefault.getOrCreateUniforms!==void 0)for(var k=a.attributeMap[k].globalDefault.getOrCreateUniforms(),
i=0,m=k.uniformKeys.length;i<m;i++){var n=k[k.uniformKeys[i]];f[n.name]=n}}c=0;for(g=e.length;c<g;c++)if(h=e[c],h!==void 0){k=0;for(i=h.length;k<i;k++)if(m=a.textureAttributeMapList[c][h[k]].globalDefault,m.getOrCreateUniforms!==void 0)for(var m=m.getOrCreateUniforms(c),n=0,o=m.uniformKeys.length;n<o;n++){var p=m[m.uniformKeys[n]];f[p.name]=p}}var a=[],q;for(q in f)a.push(q);f.uniformKeys=a;return f},getOrCreateProgram:function(a){for(var c=this.getActiveTypeMember(a),e=0,f=this.cache.length;e<f;++e)if(this.compareAttributeMap(c,
this.cache[e].flattenKeys)===0)return this.cache[e];var e=this.getActiveAttributeMapKeys(a),f=this.getActiveTextureAttributeMapKeys(a),g=this.getOrCreateVertexShader(a,e,f),h=this.getOrCreateFragmentShader(a,e,f),g=new osg.Program(new osg.Shader(gl.VERTEX_SHADER,g),new osg.Shader(gl.FRAGMENT_SHADER,h));g.flattenKeys=c;g.activeAttributeKeys=e;g.activeTextureAttributeKeys=f;g.activeUniforms=this.getActiveUniforms(a,e,f);g.generated=!0;osg.log(g.vertex.text);osg.log(g.fragment.text);this.cache.push(g);
return g},compareAttributeMap:function(a,c){for(var e,f=0,g=a.length;f<g;f++)if(e=a[f],c.indexOf(e)===-1)return 1;return c.length!==a.length?-1:0},fillTextureShader:function(a,c,e){for(var f="",g={},h=0,k=c.length;h<k;h++){var i=c[h];if(i!==void 0)for(var m=a[h],n=0,o=i.length;n<o;n++){var p=i[n],q=m[p].globalDefault;q.writeShaderInstance!==void 0&&g[p]===void 0&&(f+=q.writeShaderInstance(h,e),g[p]=!0);q.writeToShader&&(f+=q.writeToShader(h,e))}}return f},fillShader:function(a,c,e){for(var f="",g=
{},h=0,k=c.length;h<k;h++){var i=c[h],m=a[i].globalDefault;m.writeShaderInstance!==void 0&&g[i]===void 0&&(f+=m.writeShaderInstance(e),g[i]=!0);m.writeToShader&&(f+=m.writeToShader(e))}return f},getOrCreateVertexShader:function(a,c,e){var f=osg.ShaderGeneratorType.VertexInit,g="\n#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 Vertex;\nattribute vec4 Color;\nattribute vec3 Normal;\nuniform int ArrayColorEnabled;\nuniform mat4 ModelViewMatrix;\nuniform mat4 ProjectionMatrix;\nuniform mat4 NormalMatrix;\nvarying vec4 VertexColor;\n";
g+=this.fillTextureShader(a.textureAttributeMapList,e,f);g+=this.fillShader(a.attributeMap,c,f);f=osg.ShaderGeneratorType.VertexFunction;g+="\nvec4 ftransform() {\nreturn ProjectionMatrix * ModelViewMatrix * vec4(Vertex, 1.0);\n}";g+=this.fillTextureShader(a.textureAttributeMapList,e,f);g+=this.fillShader(a.attributeMap,c,f);g+="\nvoid main(void) {\ngl_Position = ftransform();\nif (ArrayColorEnabled == 1)\n  VertexColor = Color;\nelse\n  VertexColor = vec4(1.0,1.0,1.0,1.0);\n";f=osg.ShaderGeneratorType.VertexMain;
g+=this.fillTextureShader(a.textureAttributeMapList,e,f);g+=this.fillShader(a.attributeMap,c,f);g+="}\n";return g},getOrCreateFragmentShader:function(a,c,e){var f="\n#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 VertexColor;\nuniform int ArrayColorEnabled;\nvec4 fragColor;\n",g=osg.ShaderGeneratorType.FragmentInit;f+=this.fillTextureShader(a.textureAttributeMapList,e,g);f+=this.fillShader(a.attributeMap,c,g);f+="void main(void) {\nfragColor = VertexColor;\n";g=osg.ShaderGeneratorType.FragmentMain;
e.length>0&&(e=this.fillTextureShader(a.textureAttributeMapList,e,g),f+=e);f+=this.fillShader(a.attributeMap,c,g);f+="\ngl_FragColor = fragColor;\n}";return f}};
osg.createTexturedBox=function(a,c,e,f,g,h){var k=new osg.Geometry;f/=2;g/=2;h/=2;var i=[],m=[],n=[];i[0]=a-f;i[1]=c-g;i[2]=e+h;n[0]=0;n[1]=-1;n[2]=0;m[0]=0;m[1]=1;i[3]=a-f;i[4]=c-g;i[5]=e-h;n[3]=0;n[4]=-1;n[5]=0;m[2]=0;m[3]=0;i[6]=a+f;i[7]=c-g;i[8]=e-h;n[6]=0;n[7]=-1;n[8]=0;m[4]=1;m[5]=0;i[9]=a+f;i[10]=c-g;i[11]=e+h;n[9]=0;n[10]=-1;n[11]=0;m[6]=1;m[7]=1;i[12]=a+f;i[13]=c+g;i[14]=e+h;n[12]=0;n[13]=1;n[14]=0;m[8]=0;m[9]=1;i[15]=a+f;i[16]=c+g;i[17]=e-h;n[15]=0;n[16]=1;n[17]=0;m[10]=0;m[11]=0;i[18]=
a-f;i[19]=c+g;i[20]=e-h;n[18]=0;n[19]=1;n[20]=0;m[12]=1;m[13]=0;i[21]=a-f;i[22]=c+g;i[23]=e+h;n[21]=0;n[22]=1;n[23]=0;m[14]=1;m[15]=1;i[24]=a+f;i[25]=c-g;i[26]=e+h;n[24]=1;n[25]=0;n[26]=0;m[16]=0;m[17]=1;i[27]=a+f;i[28]=c-g;i[29]=e-h;n[27]=1;n[28]=0;n[29]=0;m[18]=0;m[19]=0;i[30]=a+f;i[31]=c+g;i[32]=e-h;n[30]=1;n[31]=0;n[32]=0;m[20]=1;m[21]=0;i[33]=a+f;i[34]=c+g;i[35]=e+h;n[33]=1;n[34]=0;n[35]=0;m[22]=1;m[23]=1;i[36]=a-f;i[37]=c+g;i[38]=e+h;n[36]=-1;n[37]=0;n[38]=0;m[24]=0;m[25]=1;i[39]=a-f;i[40]=
c+g;i[41]=e-h;n[39]=-1;n[40]=0;n[41]=0;m[26]=0;m[27]=0;i[42]=a-f;i[43]=c-g;i[44]=e-h;n[42]=-1;n[43]=0;n[44]=0;m[28]=1;m[29]=0;i[45]=a-f;i[46]=c-g;i[47]=e+h;n[45]=-1;n[46]=0;n[47]=0;m[30]=1;m[31]=1;i[48]=a-f;i[49]=c+g;i[50]=e+h;n[48]=0;n[49]=0;n[50]=1;m[32]=0;m[33]=1;i[51]=a-f;i[52]=c-g;i[53]=e+h;n[51]=0;n[52]=0;n[53]=1;m[34]=0;m[35]=0;i[54]=a+f;i[55]=c-g;i[56]=e+h;n[54]=0;n[55]=0;n[56]=1;m[36]=1;m[37]=0;i[57]=a+f;i[58]=c+g;i[59]=e+h;n[57]=0;n[58]=0;n[59]=1;m[38]=1;m[39]=1;i[60]=a+f;i[61]=c+g;i[62]=
e-h;n[60]=0;n[61]=0;n[62]=-1;m[40]=0;m[41]=1;i[63]=a+f;i[64]=c-g;i[65]=e-h;n[63]=0;n[64]=0;n[65]=-1;m[42]=0;m[43]=0;i[66]=a-f;i[67]=c-g;i[68]=e-h;n[66]=0;n[67]=0;n[68]=-1;m[44]=1;m[45]=0;i[69]=a-f;i[70]=c+g;i[71]=e-h;n[69]=0;n[70]=0;n[71]=-1;m[46]=1;m[47]=1;k.getAttributes().Vertex=new osg.BufferArray(gl.ARRAY_BUFFER,i,3);k.getAttributes().Normal=new osg.BufferArray(gl.ARRAY_BUFFER,n,3);k.getAttributes().TexCoord0=new osg.BufferArray(gl.ARRAY_BUFFER,m,2);a=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,
[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23],1));k.getPrimitives().push(a);return k};
osg.createTexturedQuad=function(a,c,e,f,g,h,k,i,m,n,o,p,q){p===void 0&&q===void 0&&(p=n,q=o,o=n=0);var t=new osg.Geometry,s=[];s[0]=a+k;s[1]=c+i;s[2]=e+m;s[3]=a;s[4]=c;s[5]=e;s[6]=a+f;s[7]=c+g;s[8]=e+h;s[9]=a+f+k;s[10]=c+g+i;s[11]=e+h+m;p===void 0&&(p=1);q===void 0&&(q=1);a=[];a[0]=n;a[1]=q;a[2]=n;a[3]=o;a[4]=p;a[5]=o;a[6]=p;a[7]=q;f=osg.Vec3.cross([f,g,h],[k,i,m],[]);g=[];g[0]=f[0];g[1]=f[1];g[2]=f[2];g[3]=f[0];g[4]=f[1];g[5]=f[2];g[6]=f[0];g[7]=f[1];g[8]=f[2];g[9]=f[0];g[10]=f[1];g[11]=f[2];t.getAttributes().Vertex=
new osg.BufferArray(gl.ARRAY_BUFFER,s,3);t.getAttributes().Normal=new osg.BufferArray(gl.ARRAY_BUFFER,g,3);t.getAttributes().TexCoord0=new osg.BufferArray(gl.ARRAY_BUFFER,a,2);s=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,[0,1,2,0,2,3],1));t.getPrimitives().push(s);return t};osg.Stack=function(){};osg.Stack.create=function(){var a=[];a.globalDefault=void 0;a.lastApplied=void 0;a.back=function(){return this[this.length-1]};return a};
osg.StateGraph=function(){this.depth=0;this.children={};this.children.keys=[];this.leafs=[];this.parent=this.stateset=void 0};
osg.StateGraph.prototype={clean:function(){for(var a=this.leafs.length=0,c=this.children.keys.length;a<c;a++)this.children[this.children.keys[a]].clean()},findOrInsert:function(a){var c;this.children[a.id]?c=this.children[a.id]:(c=new osg.StateGraph,c.parent=this,c.depth=this.depth+1,c.stateset=a,this.children[a.id]=c,this.children.keys.push(a.id));return c},moveToRootStateGraph:function(a,c){for(;c;)c.stateSet&&a.popStateSet(),c=c._parent},moveStateGraph:function(a,c,e){var f;if(!(e===c||e===void 0))if(c===
void 0){f=[];do e.stateset!==void 0&&f.push(e.stateset),e=e.parent;while(e);f.reverse();c=0;for(l=f.length;c<l;++c)a.pushStateSet(f[c])}else if(c.parent===e.parent)c.stateset!==void 0&&a.popStateSet(),e.stateset!==void 0&&a.pushStateSet(e.stateset);else{for(;c.depth>e.depth;)c.stateset!==void 0&&a.popStateSet(),c=c.parent;for(f=[];e.depth>c.depth;)e.stateset!==void 0&&f.push(e.stateset),e=e.parent;for(;c!==e;)c.stateset!==void 0&&a.popStateSet(),c=c.parent,e.stateset!==void 0&&f.push(e.stateset),
e=e.parent;f.reverse();stackLength=f.length;for(c=0;c<stackLength;++c)a.pushStateSet(f[c])}}};
osg.State=function(){this.currentVBO=null;this.vertexAttribList=[];this.programs=osg.Stack.create();this.stateSets=osg.Stack.create();this.uniforms={};this.uniforms.uniformKeys=[];this.textureAttributeMapList=[];this.attributeMap={};this.attributeMap.attributeKeys=[];this.modeMap={};this.shaderGenerator=new osg.ShaderGenerator;this.modelViewMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity(),"ModelViewMatrix");this.projectionMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity(),"ProjectionMatrix");
this.normalMatrix=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity(),"NormalMatrix");this.uniformArrayState={};this.uniformArrayState.uniformKeys=[];this.uniformArrayState.Color=osg.Uniform.createInt1(0,"ArrayColorEnabled");this.uniformArrayState.uniformKeys.push("Color");this.vertexAttribMap={};this.vertexAttribMap._disable=[];this.vertexAttribMap._keys=[]};
osg.State.prototype={pushStateSet:function(a){this.stateSets.push(a);a.attributeMap&&this.pushAttributeMap(this.attributeMap,a.attributeMap);if(a.textureAttributeMapList)for(var c=a.textureAttributeMapList,e=0,f=c.length;e<f;e++)if(c[e]!==void 0){if(!this.textureAttributeMapList[e])this.textureAttributeMapList[e]={},this.textureAttributeMapList[e].attributeKeys=[];this.pushAttributeMap(this.textureAttributeMapList[e],c[e])}a.uniforms&&this.pushUniformsList(this.uniforms,a.uniforms)},applyStateSet:function(a){this.pushStateSet(a);
this.apply();this.popStateSet()},popAllStateSets:function(){for(;this.stateSets.length;)this.popStateSet()},popStateSet:function(){var a=this.stateSets.pop();a.program&&this.programs.pop();a.attributeMap&&this.popAttributeMap(this.attributeMap,a.attributeMap);if(a.textureAttributeMapList)for(var c=a.textureAttributeMapList,e=0,f=c.length;e<f;e++)c[e]!==void 0&&this.popAttributeMap(this.textureAttributeMapList[e],c[e]);a.uniforms&&this.popUniformsList(this.uniforms,a.uniforms)},applyAttribute:function(a){var c=
a.getTypeMember(),e=this.attributeMap[c];if(e===void 0)e=osg.Stack.create(),this.attributeMap[c]=e,this.attributeMap[c].globalDefault=a.cloneType(),this.attributeMap.attributeKeys.push(c);if(e.lastApplied!==a||a.isDirty())a.apply&&a.apply(this),e.lastApplied=a,e.asChanged=!0},applyTextureAttribute:function(a,c){gl.activeTexture(gl.TEXTURE0+a);var e=c.getTypeMember();if(!this.textureAttributeMapList[a])this.textureAttributeMapList[a]={},this.textureAttributeMapList[a].attributeKeys=[];var f=this.textureAttributeMapList[a][e];
if(f===void 0)f=osg.Stack.create(),this.textureAttributeMapList[a][e]=f,f.globalDefault=c.cloneType(),this.textureAttributeMapList[a].attributeKeys.push(e);if(f.lastApplied!==c||c.isDirty())c.apply&&c.apply(this),f.lastApplied=c,f.asChanged=!0},getLastProgramApplied:function(){return this.programs.lastApplied},pushGeneratedProgram:function(){var a;if(this.attributeMap.Program!==void 0&&this.attributeMap.Program.length!==0&&(a=this.attributeMap.Program.back().object,value=this.attributeMap.Program.back().value,
a!==void 0&&value!==osg.StateAttribute.OFF))return this.programs.push(this.getObjectPair(a,value)),a;a=this.shaderGenerator.getOrCreateProgram({textureAttributeMapList:this.textureAttributeMapList,attributeMap:this.attributeMap});this.programs.push(this.getObjectPair(a,osg.StateAttribute.ON));return a},popGeneratedProgram:function(){this.programs.pop()},applyWithoutProgram:function(){this.applyAttributeMap(this.attributeMap);this.applyTextureAttributeMapList(this.textureAttributeMapList)},apply:function(){this.applyAttributeMap(this.attributeMap);
this.applyTextureAttributeMapList(this.textureAttributeMapList);this.pushGeneratedProgram();var a=this.programs.back().object;if(this.programs.lastApplied!==a)a.apply(this),this.programs.lastApplied=a;var c,e,f,g;if(a.generated!==void 0&&a.generated===!0){c=a.uniformsCache;e=a.activeUniforms;a=!1;f=0;for(l=e.uniformKeys.length;f<l;f++){var h=e.uniformKeys[f],k=c[h];k!==void 0?e[h].apply(k):(a=!0,delete e[h])}if(a){c=[];for(g in e)g!=="uniformKeys"&&c.push(g);e.uniformKeys=c}}else{k=a.program;c=a.uniformsCache;
h=this.uniforms;e=[];f=a.trackUniforms;var i;if(a.trackAttributes!==void 0&&f===void 0){var m=a.trackAttributes.attributeKeys;f=0;for(l=m.length;f<l;f++)if(g=m[f],attributeStack=this.attributeMap[g],attributeStack!==void 0&&(g=attributeStack.globalDefault,g.getOrCreateUniforms!==void 0)){g=g.getOrCreateUniforms();i=0;for(b=g.uniformKeys.length;i<b;i++)e.push(g[g.uniformKeys[i]])}m=a.trackAttributes.textureAttributeKeys;if(m!==void 0){f=0;for(l=m.length;f<l;f++){var n=m[f];if(n!==void 0)for(var o=
0,p=n.length;o<p;o++)if(g=n[o],i=this.textureAttributeMapList[f],i!==void 0&&(attributeStack=i[g],attributeStack!==void 0&&(g=attributeStack.globalDefault,g.getOrCreateUniforms!==void 0))){g=g.getOrCreateUniforms(f);i=0;for(b=g.uniformKeys.length;i<b;i++)e.push(g[g.uniformKeys[i]])}}}g={};f=0;for(l=e.length;f<l;f++)m=e[f],n=gl.getUniformLocation(k,m.name),n!==void 0&&n!==null&&(g[m.name]=e[f]);a.trackUniforms=g}f=0;for(l=c.uniformKeys.length;f<l;f++)g=c.uniformKeys[f],e=c[g],k=h[g],k===void 0?a.trackUniforms!==
void 0&&(k=a.trackUniforms[g],k!==void 0&&k.apply(e)):(k=k.length===0?k.globalDefault:k.back().object,k.apply(e))}},applyUniformList:function(a,c){for(var e,f,g=this.getLastProgramApplied().uniformsCache,h=0,k=g.uniformKeys.length;h<k;h++){var i=g.uniformKeys[h];e=g[i];f=c[i];if(f===void 0){f=a[i];if(f===void 0)continue;f=f.length===0?f.globalDefault:f.back().object}f.apply(e)}},applyAttributeMap:function(a){for(var c,e=0,f=a.attributeKeys.length;e<f;e++)if(c=a[a.attributeKeys[e]],c!==void 0){var g;
g=c.length===0?c.globalDefault:c.back().object;if(c.lastApplied!==g||g.isDirty())g.apply&&g.apply(this),c.lastApplied=g,c.asChanged=!0}},getObjectPair:function(a,c){return{object:a,value:c}},pushUniformsList:function(a,c){for(var e,f,g=0,h=c.uniformKeys.length;g<h;g++){uniformPair=c[c.uniformKeys[g]];f=uniformPair.object;e=f.name;if(a[e]===void 0)a[e]=osg.Stack.create(),a[e].globalDefault=f,a.uniformKeys.push(e);e=a[e];e.length===0?e.push(this.getObjectPair(f,uniformPair.value)):e[e.length-1].value&
osg.StateAttribute.OVERRIDE&&!(uniformPair.value&osg.StateAttribute.PROTECTED)?e.push(e[e.length-1]):e.push(this.getObjectPair(f,uniformPair.value))}},popUniformsList:function(a,c){for(var e=0,f=c.uniformKeys.length;e<f;e++)a[c.uniformKeys[e]].pop()},applyTextureAttributeMapList:function(a){for(var c,e=0,f=a.length;e<f;e++)if(c=a[e],c!==void 0)for(var g=0,h=c.attributeKeys.length;g<h;g++){var k=c[c.attributeKeys[g]];if(k!==void 0){var i;i=k.length===0?k.globalDefault:k.back().object;if(k.lastApplied!==
i||i.isDirty())gl.activeTexture(gl.TEXTURE0+e),i.apply(this.state),k.lastApplied=i}}},setGlobalDefaultValue:function(a){var c=a.getTypeMember();this.attributeMap[c]?this.attributeMap[c].globalDefault=a:(this.attributeMap[c]=osg.Stack.create(),this.attributeMap[c].globalDefault=a,this.attributeMap.attributeKeys.push(c))},pushAttributeMap:function(a,c){for(var e,f=0,g=c.attributeKeys.length;f<g;f++){e=c.attributeKeys[f];var h=c[e],k=h.object;if(a[e]===void 0)a[e]=osg.Stack.create(),a[e].globalDefault=
k.cloneType(),a.attributeKeys.push(e);e=a[e];e.length===0?e.push(this.getObjectPair(k,h.value)):e[e.length-1].value&osg.StateAttribute.OVERRIDE&&!(h.value&osg.StateAttribute.PROTECTED)?e.push(e[e.length-1]):e.push(this.getObjectPair(k,h.value));e.asChanged=!0}},popAttributeMap:function(a,c){for(var e,f=0,g=c.attributeKeys.length;f<g;f++)type=c.attributeKeys[f],e=a[type],e.pop(),e.asChanged=!0},setIndexArray:function(a){if(this.currentIndexVBO!==a)a.buffer||a.init(),gl.bindBuffer(a.type,a.buffer),
this.currentIndexVBO=a;a.isDirty()&&a.compile()},lazyDisablingOfVertexAttributes:function(){for(var a=this.vertexAttribMap._keys,c=0,e=a.length;c<e;c++){var f=a[c];this.vertexAttribMap[f]&&(this.vertexAttribMap._disable[f]=!0)}},applyDisablingOfVertexAttributes:function(){for(var a=this.vertexAttribMap._keys,c=0,e=a.length;c<e;c++)if(this.vertexAttribMap._disable[a[c]]===!0){var f=a[c];gl.disableVertexAttribArray(f);this.vertexAttribMap._disable[f]=!1;this.vertexAttribMap[f]=!1}a=this.programs.lastApplied;
if(a.generated===!0&&(c=!1,this.previousAppliedProgram!==this.programs.lastApplied?(c=!0,this.previousAppliedProgram=this.programs.lastApplied):(e=a.attributesCache.Color,this.vertexAttribMap[e]!==this.previousColorAttrib&&(c=!0)),c&&(e=a.attributesCache.Color,e!==void 0)))this.vertexAttribMap[e]?this.uniformArrayState.Color.set([1]):this.uniformArrayState.Color.set([0]),this.previousColorAttrib=this.vertexAttribMap[e],this.uniformArrayState.Color.apply(a.uniformsCache.ArrayColorEnabled)},setVertexAttribArray:function(a,
c,e){this.vertexAttribMap._disable[a]=!1;c.buffer||c.init();c.isDirty()&&(gl.bindBuffer(c.type,c.buffer),c.compile());this.vertexAttribMap[a]!==c&&(gl.bindBuffer(c.type,c.buffer),this.vertexAttribMap[a]||(gl.enableVertexAttribArray(a),this.vertexAttribMap[a]===void 0&&this.vertexAttribMap._keys.push(a)),this.vertexAttribMap[a]=c,gl.vertexAttribPointer(a,c.itemSize,gl.FLOAT,e,0,0))}};osg.State.create=function(){var a=new osg.State;gl.hint(gl.NICEST,gl.GENERATE_MIPMAP_HINT);return a};
osg.StateSet=function(){this.id=osg.instance++};
osg.StateSet.prototype={getObjectPair:function(a,c){return{object:a,value:c}},addUniform:function(a,c){if(c===void 0)c=osg.StateAttribute.ON;if(!this.uniforms)this.uniforms={},this.uniforms.uniformKeys=[];var e=a.name;this.uniforms[e]=this.getObjectPair(a,c);this.uniforms.uniformKeys.indexOf(e)===-1&&this.uniforms.uniformKeys.push(e)},getUniform:function(a){if(this.uniforms[a])return this.uniforms[a].object},setTextureAttributeAndMode:function(a,c,e){if(e===void 0)e=osg.StateAttribute.ON;this._setTextureAttribute(a,
this.getObjectPair(c,e))},getTextureAttribute:function(a,c){return this.textureAttributeMapList[a]===void 0||this.textureAttributeMapList[a][c]===void 0?void 0:this.textureAttributeMapList[a][c].object},setAttributeAndMode:function(a,c){if(c===void 0)c=osg.StateAttribute.ON;this._setAttribute(this.getObjectPair(a,c))},_getUniformMap:function(){return this.uniforms},_setTextureAttribute:function(a,c){if(!this.textureAttributeMapList)this.textureAttributeMapList=[];if(this.textureAttributeMapList[a]===
void 0)this.textureAttributeMapList[a]={},this.textureAttributeMapList[a].attributeKeys=[];var e=c.object.getTypeMember();this.textureAttributeMapList[a][e]=c;this.textureAttributeMapList[a].attributeKeys.indexOf(e)===-1&&this.textureAttributeMapList[a].attributeKeys.push(e)},_setAttribute:function(a){if(!this.attributeMap)this.attributeMap={},this.attributeMap.attributeKeys=[];var c=a.object.getTypeMember();this.attributeMap[c]=a;this.attributeMap.attributeKeys.indexOf(c)===-1&&this.attributeMap.attributeKeys.push(c)},
getAttributeMap:function(){return this.attributeMap}};osg.Texture=function(){osg.StateAttribute.call(this);this.setDefaultParameters()};
osg.Texture.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Texture",cloneType:function(){var a=new osg.Texture;a.default_type=!0;return a},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},getOrCreateUniforms:function(a){if(osg.Texture.uniforms===void 0)osg.Texture.uniforms=[];if(osg.Texture.uniforms[a]===void 0){var c=this.getType()+a,e={};e[c]=osg.Uniform.createInt1(a,c);e.uniformKeys=[c];osg.Texture.uniforms[a]=e}return osg.Texture.uniforms[a]},
setDefaultParameters:function(){this.min_filter=this.mag_filter="LINEAR";this.wrap_t=this.wrap_s="CLAMP_TO_EDGE";this.textureHeight=this.textureWidth=0;this.target="TEXTURE_2D"},setTextureSize:function(a,c){this.textureWidth=a;this.textureHeight=c},init:function(){if(!this.textureObject)this.textureObject=gl.createTexture(),this._dirty=!0},getWidth:function(){return this.textureWidth},getHeight:function(){return this.textureHeight},setWrapS:function(a){this.wrap_s=a},setWrapT:function(a){this.wrap_t=
a},setMinFilter:function(a){this.min_filter=a},setMagFilter:function(a){this.mag_filter=a},setImage:function(a){this.image=a;this._dirty=!0},setFromCanvas:function(a){this.init();gl.bindTexture(gl.TEXTURE_2D,this.textureObject);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,a);this.setTextureSize(a.width,a.height);this.applyFilterParameter();this._dirty=!1},isImageReady:function(){var a=this.image;return a&&a.complete?typeof a.naturalWidth!=="undefined"&&a.naturalWidth===0?!1:!0:!1},
applyFilterParameter:function(){gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl[this.mag_filter]);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl[this.min_filter]);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl[this.wrap_s]);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl[this.wrap_t]);(this.min_filter==="NEAREST_MIPMAP_NEAREST"||this.min_filter==="LINEAR_MIPMAP_NEAREST"||this.min_filter==="NEAREST_MIPMAP_LINEAR"||this.min_filter==="LINEAR_MIPMAP_LINEAR")&&gl.generateMipmap(gl.TEXTURE_2D)},
apply:function(){if(this.image!==void 0)if(this.textureObject)gl.bindTexture(gl.TEXTURE_2D,this.textureObject);else if(this.isImageReady()){if(!this.textureObject)this.init(),this.setTextureSize(this.image.naturalWidth,this.image.naturalHeight),this._dirty=!1;gl.bindTexture(gl.TEXTURE_2D,this.textureObject);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,this.image);this.applyFilterParameter()}else gl.bindTexture(gl.TEXTURE_2D,null);else this.textureHeight!==0&&this.textureWidth!==
0?this.textureObject?gl.bindTexture(gl.TEXTURE_2D,this.textureObject):(this.init(),gl.bindTexture(gl.TEXTURE_2D,this.textureObject),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,this.textureWidth,this.textureHeight,0,gl.RGBA,gl.UNSIGNED_BYTE,null),this.applyFilterParameter()):this.textureObject!==void 0?gl.bindTexture(gl.TEXTURE_2D,this.textureObject):gl.bindTexture(gl.TEXTURE_2D,null)},setShaderGeneratorFunction:function(a,c){this[c]=a},writeToShader:function(a,c){return this[c]?this[c].call(this,a):""}});
osg.Texture.prototype[osg.ShaderGeneratorType.VertexInit]=function(a){var c="attribute vec2 TexCoord"+a+";\n";c+="varying vec2 FragTexCoord"+a+";\n";return c};osg.Texture.prototype[osg.ShaderGeneratorType.VertexMain]=function(a){return"FragTexCoord"+a+" = TexCoord"+a+";\n"};osg.Texture.prototype[osg.ShaderGeneratorType.FragmentInit]=function(a){var c="varying vec2 FragTexCoord"+a+";\n";c+="uniform sampler2D Texture"+a+";\n";c+="vec4 texColor"+a+";\n";return c};
osg.Texture.prototype[osg.ShaderGeneratorType.FragmentMain]=function(a){var c="texColor"+a+" = texture2D( Texture"+a+", FragTexCoord"+a+".xy );\n";c+="fragColor = fragColor * texColor"+a+";\n";return c};osg.Texture.createFromURL=function(a){var c=new osg.Texture;if(a!==void 0){var e=new Image;e.src=a;c.setImage(e)}return c};osg.Texture.createFromImg=function(a){var c=new osg.Texture;c.setImage(a);return c};osg.Texture.createFromCanvas=function(a){var c=new osg.Texture;c.setFromCanvas(a);return c};
osg.Texture.create=function(a){osg.log("osg.Texture.create is deprecated, use osg.Texture.createFromURL instead");return osg.Texture.createFromURL(a)};osg.UpdateVisitor=function(){osg.NodeVisitor.call(this);var a=new osg.FrameStamp;this.getFrameStamp=function(){return a};this.setFrameStamp=function(c){a=c}};
osg.UpdateVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{apply:function(a){if(a.getUpdateCallback!==void 0){var c=a.getUpdateCallback();if(c!==void 0){c.update(a,this);return}}a.traverse&&this.traverse(a)}});osg.View=function(){osg.Camera.call(this)};osg.View.prototype=osg.objectInehrit(osg.Camera.prototype,{computeIntersections:function(a,c,e){e===void 0&&(e=-1);var f=new osgUtil.IntersectVisitor;f.setTraversalMask(e);f.addLineSegment([a,c,0],[a,c,1]);f.apply(this);return f.hits}});
osg.Viewport=function(a,c,e,f){osg.StateAttribute.call(this);a===void 0&&(a=0);c===void 0&&(c=0);e===void 0&&(e=800);f===void 0&&(f=600);var g=a,h=c,k=e,i=f;this.x=function(){return g};this.y=function(){return h};this.width=function(){return k};this.height=function(){return i};this.computeWindowMatrix=function(){var a=osg.Matrix.makeTranslate(1,1,1),c=osg.Matrix.makeScale(0.5*k,0.5*i,0.5),e=osg.Matrix.makeTranslate(g,h,0);return osg.Matrix.preMult(e,osg.Matrix.preMult(c,a))};this._dirty=!0};
osg.Viewport.prototype=osg.objectInehrit(osg.StateAttribute.prototype,{attributeType:"Viewport",cloneType:function(){return new osg.Viewport},getType:function(){return this.attributeType},getTypeMember:function(){return this.attributeType},apply:function(){gl.viewport(this.x(),this.y(),this.width(),this.height());this._dirty=!1}});osg.CullStack=function(){this.modelviewMatrixStack=[osg.Matrix.makeIdentity()];this.projectionMatrixStack=[osg.Matrix.makeIdentity()];this.viewportStack=[]};
osg.CullStack.prototype={getViewport:function(){return this.viewportStack.length===0?void 0:this.viewportStack[this.viewportStack.length-1]},getLookVectorLocal:function(){var a=this.modelviewMatrixStack[this.modelviewMatrixStack.length-1];return[-a[2],-a[6],-a[10]]},pushViewport:function(a){this.viewportStack.push(a)},popViewport:function(){this.viewportStack.pop()},pushModelviewMatrix:function(a){this.modelviewMatrixStack.push(a);a=this.getLookVectorLocal();this.bbCornerFar=(a[0]>=0?1:0)|(a[1]>=
0?2:0)|(a[2]>=0?4:0);this.bbCornerNear=~this.bbCornerFar&7},popModelviewMatrix:function(){this.modelviewMatrixStack.pop();var a;a=this.modelviewMatrixStack.length!==0?this.getLookVectorLocal():[0,0,-1];this.bbCornerFar=(a[0]>=0?1:0)|(a[1]>=0?2:0)|(a[2]>=0?4:0);this.bbCornerNear=~this.bbCornerFar&7},pushProjectionMatrix:function(a){this.projectionMatrixStack.push(a)},popProjectionMatrix:function(){this.projectionMatrixStack.pop()}};
osg.CullVisitor=function(){osg.NodeVisitor.call(this);osg.CullSettings.call(this);osg.CullStack.call(this);this.rootRenderStage=this.currentRenderStage=this.currentRenderBin=this.currentStateGraph=this.rootStateGraph=void 0;this.computeNearFar=!0;this.computedNear=Number.POSITIVE_INFINITY;this.computedFar=Number.NEGATIVE_INFINITY;var a=[0,0,-1];this.bbCornerFar=(a[0]>=0?1:0)|(a[1]>=0?2:0)|(a[2]>=0?4:0);this.bbCornerNear=~this.bbCornerFar&7;this.reserveMatrixStack=[[]];this.reserveMatrixStack.current=
0;this.reserveLeafStack=[{}];this.reserveLeafStack.current=0};
osg.CullVisitor.prototype=osg.objectInehrit(osg.CullStack.prototype,osg.objectInehrit(osg.CullSettings.prototype,osg.objectInehrit(osg.NodeVisitor.prototype,{distance:function(a,c){return-(a[0]*c[2]+a[1]*c[6]+a[2]*c[10]+c[14])},updateCalculatedNearFar:function(a,c){var e=c.getBoundingBox(),f;f=this.distance(e.corner(this.bbCornerNear),a);e=this.distance(e.corner(this.bbCornerFar),a);if(f>e){var g=f;f=e;e=g}if(e<0)return!1;if(f<this.computedNear)this.computedNear=f;if(e>this.computedFar)this.computedFar=
e;return!0},clampProjectionMatrix:function(a,c,e,f,g){if(e<c-1.0E-6)return osg.log("clampProjectionMatrix not applied, invalid depth range, znear = "+c+"  zfar = "+e),!1;var h,k;e<c+1.0E-6&&(e=(c+e)*0.5,c=e-1.0E-6,e+=1.0E-6);if(Math.abs(osg.Matrix.get(a,0,3))<1.0E-6&&Math.abs(osg.Matrix.get(a,1,3))<1.0E-6&&Math.abs(osg.Matrix.get(a,2,3))<1.0E-6)k=(e-c)*0.02,k<1&&(k=1),h=c-k,k=e+k,c=h,e=k,osg.Matrix.set(a,2,2,-2/(k-h)),osg.Matrix.set(a,3,2,-(k+h)/(k-h));else{h=c*0.98;k=e*1.02;c=e*f;h<c&&(h=c);var c=
h,e=k,f=osg.Matrix.get(a,2,2),i=osg.Matrix.get(a,3,2),m=osg.Matrix.get(a,2,3),n=osg.Matrix.get(a,3,3);h=(-h*f+i)/(-h*m+n);k=(-k*f+i)/(-k*m+n);f=Math.abs(2/(h-k));osg.Matrix.postMult([1,0,0,0,0,1,0,0,0,0,f,0,0,0,-(h+k)/2*f,1],a)}g!==void 0&&(g[0]=c,g[1]=e);return!0},setStateGraph:function(a){this.currentStateGraph=this.rootStateGraph=a},setRenderStage:function(a){this.currentRenderBin=this.rootRenderStage=a},reset:function(){this.modelviewMatrixStack.length=1;this.projectionMatrixStack.length=1;this.reserveMatrixStack.current=
0;this.reserveLeafStack.current=0},getCurrentRenderBin:function(){return this.currentRenderBin},setCurrentRenderBin:function(a){this.currentRenderBin=a},addPositionedAttribute:function(a){var c=this.modelviewMatrixStack[this.modelviewMatrixStack.length-1];this.currentRenderBin.getStage().positionedAttribute.push([c,a])},pushStateSet:function(a){this.currentStateGraph=this.currentStateGraph.findOrInsert(a)},popStateSet:function(){this.currentStateGraph=this.currentStateGraph.parent},popProjectionMatrix:function(){this.computeNearFar===
!0&&this.computedFar>=this.computedNear&&this.clampProjectionMatrix(this.projectionMatrixStack[this.projectionMatrixStack.length-1],this.computedNear,this.computedFar,this.nearFarRatio);osg.CullStack.prototype.popProjectionMatrix.call(this)},apply:function(a){this[a.objectType].call(this,a)},getReservedMatrix:function(){var a=this.reserveMatrixStack[this.reserveMatrixStack.current++];this.reserveMatrixStack.current===this.reserveMatrixStack.length&&this.reserveMatrixStack.push(osg.Matrix.makeIdentity());
return a},getReservedLeaf:function(){var a=this.reserveLeafStack[this.reserveLeafStack.current++];this.reserveLeafStack.current===this.reserveLeafStack.length&&this.reserveLeafStack.push({});return a}})));
osg.CullVisitor.prototype[osg.Camera.prototype.objectType]=function(a){var c=a.getStateSet();c&&this.pushStateSet(c);a.light&&this.addPositionedAttribute(a.light);var e=this.getReservedMatrix(),f=this.getReservedMatrix();a.getReferenceFrame()===osg.Transform.RELATIVE_RF?(osg.Matrix.mult(this.projectionMatrixStack[this.projectionMatrixStack.length-1],a.getProjectionMatrix(),f),osg.Matrix.mult(this.modelviewMatrixStack[this.modelviewMatrixStack.length-1],a.getViewMatrix(),e)):(osg.Matrix.copy(a.getViewMatrix(),
e),osg.Matrix.copy(a.getProjectionMatrix(),f));this.pushProjectionMatrix(f);this.pushModelviewMatrix(e);a.getViewport()&&this.pushViewport(a.getViewport());var e=this.computedNear,f=this.computedFar,g=new osg.CullSettings;g.setCullSettings(this);this.computedNear=Number.POSITIVE_INFINITY;this.computedFar=Number.NEGATIVE_INFINITY;this.setCullSettings(a);if(a.getRenderOrder()===osg.Camera.NESTED_RENDER)a.traverse&&this.traverse(a);else{var h=this.getCurrentRenderBin().getStage(),k=new osg.RenderStage;
k.setCamera(a);k.setClearDepth(a.getClearDepth());k.setClearColor(a.getClearColor());k.setClearMask(a.getClearMask());h=a.getViewport()===void 0?h.getViewport():a.getViewport();k.setViewport(h);h=this.getCurrentRenderBin();this.setCurrentRenderBin(k);a.traverse&&a.traverse(this);this.setCurrentRenderBin(h);a.getRenderOrder()===osg.Camera.PRE_RENDER?this.getCurrentRenderBin().getStage().addPreRenderStage(k,a.renderOrderNum):this.getCurrentRenderBin().getStage().addPostRenderStage(k,a.renderOrderNum)}this.popModelviewMatrix();
this.popProjectionMatrix();a.getViewport()&&this.popViewport();this.setCullSettings(g);this.computedNear=e;this.computedFar=f;c&&this.popStateSet()};
osg.CullVisitor.prototype[osg.MatrixTransform.prototype.objectType]=function(a){var c=this.modelviewMatrixStack[this.modelviewMatrixStack.length-1],e=this.getReservedMatrix();osg.Matrix.mult(c,a.getMatrix(),e);this.pushModelviewMatrix(e);(c=a.getStateSet())&&this.pushStateSet(c);a.light&&this.addPositionedAttribute(a.light);a.traverse&&this.traverse(a);c&&this.popStateSet();this.popModelviewMatrix()};
osg.CullVisitor.prototype[osg.Projection.prototype.objectType]=function(a){lastMatrixStack=this.projectionMatrixStack[this.projectionMatrixStack.length-1];var c=this.getReservedMatrix();osg.Matrix.mult(lastMatrixStack,a.getProjectionMatrix(),c);this.pushProjectionMatrix(c);(c=a.getStateSet())&&this.pushStateSet(c);a.traverse&&this.traverse(a);c&&this.popStateSet();this.popProjectionMatrix()};
osg.CullVisitor.prototype[osg.Node.prototype.objectType]=function(a){var c=a.getStateSet();c&&this.pushStateSet(c);a.light&&this.addPositionedAttribute(a.light);a.traverse&&this.traverse(a);c&&this.popStateSet()};
osg.CullVisitor.prototype[osg.Geometry.prototype.objectType]=function(a){matrix=this.modelviewMatrixStack[this.modelviewMatrixStack.length-1];var c=a.getBoundingBox();if(!this.computeNearFar||!c.valid()||this.updateCalculatedNearFar(matrix,a)){(c=a.getStateSet())&&this.pushStateSet(c);var e=this.currentStateGraph.leafs;e.length===0&&this.currentRenderBin.addStateGraph(this.currentStateGraph);var f=this.getReservedLeaf();f.parent=this.currentStateGraph;f.modelview=this.modelviewMatrixStack[this.modelviewMatrixStack.length-
1];f.projection=this.projectionMatrixStack[this.projectionMatrixStack.length-1];f.geometry=a;e.push(f);c&&this.popStateSet()}};
var osgAnimation={EaseOutQuad:function(a){return-(a*(a-2))},EaseInQuad:function(a){return a*a},EaseOutCubic:function(a){a-=1;return a*a*a+1},EaseInCubic:function(a){return a*a*a},EaseOutQuart:function(a){a-=1;return-(a*a*a*a-1)},EaseInQuart:function(a){return a*a*a*a},EaseOutElastic:function(a){return Math.pow(2,-10*a)*Math.sin((a-0.075)*2*Math.PI/0.3)+1}},osgUtil={TriangleHit:function(a,c,e,f,g,h,k,i){this.index=a;this.normal=c;this.r1=e;this.v1=f;this.r2=g;this.v2=h;this.r3=k;this.v3=i},TriangleIntersect:function(){this.hits=
[];this.nodePath=[]}};
osgUtil.TriangleIntersect.prototype={setNodePath:function(a){this.nodePath=a},set:function(a,c){this.start=a;this.end=c;this.dir=osg.Vec3.sub(c,a,[]);this.length=osg.Vec3.length(this.dir);osg.Vec3.mult(this.dir,1/this.length,this.dir)},apply:function(a){var c,e,f,g,h,k,i;i=this.index=0;for(l=a.primitives.length;i<l;i++)if(c=a.primitives[i],c.getIndices!==void 0){e=a.getAttributes().Vertex.getElements();var m=c.indices.getElements();switch(c.getMode()){case gl.TRIANGLES:f=c.getCount();for(c=c.getFirst();c<
f;c+=3)g=[],h=[],k=[],g[0]=e[m[c]*3],g[1]=e[m[c]*3+1],g[2]=e[m[c]*3+2],h[0]=e[m[c+1]*3],h[1]=e[m[c+1]*3+1],h[2]=e[m[c+1]*3+2],k[0]=e[m[c+2]*3],k[1]=e[m[c+2]*3+1],k[2]=e[m[c+2]*3+2],this.intersect(g,h,k);break;case gl.TRIANGLE_STRIP:console&&console.log("TriangleIntersect does not support TRIANGLE_STRIP");break;case gl.TRIANGLE_FAN:console&&console.log("TriangleIntersect does not support TRIANGLE_FAN")}}else switch(e=a.getAttributes().Vertex.getElements(),c.getMode()){case gl.TRIANGLES:f=c.getCount();
for(c=c.getFirst();c<f;)g=[],h=[],k=[],g[0]=e[c++],g[1]=e[c++],g[2]=e[c++],h[0]=e[c++],h[1]=e[c++],h[2]=e[c++],k[0]=e[c++],k[1]=e[c++],k[2]=e[c++],this.intersect(g,h,k);break;case gl.TRIANGLE_STRIP:console&&console.log("TriangleIntersect does not support TRIANGLE_STRIP");break;case gl.TRIANGLE_FAN:console&&console.log("TriangleIntersect does not support TRIANGLE_FAN")}},intersect:function(a,c,e){this.index++;if(!(a==c||c==e||a==e)){var f=osg.Vec3.sub(c,a,[]),g=osg.Vec3.cross(f,this.dir,[]),h=osg.Vec3.dot(osg.Vec3.sub(this.start,
a,[]),g),k=osg.Vec3.dot(osg.Vec3.sub(e,a,[]),g);if(k>=0){if(h<0)return;if(h>k)return}else{if(h>0)return;if(h<k)return}var g=osg.Vec3.sub(e,c,[]),i=osg.Vec3.cross(g,this.dir,[]),m=osg.Vec3.dot(osg.Vec3.sub(this.start,c,[]),i),i=osg.Vec3.dot(osg.Vec3.sub(a,c,[]),i);if(i>=0){if(m<0)return;if(m>i)return}else{if(m>0)return;if(m<i)return}var n=osg.Vec3.sub(a,e,[]),o=osg.Vec3.cross(n,this.dir,[]),n=osg.Vec3.dot(osg.Vec3.sub(this.start,e,[]),o),o=osg.Vec3.dot(osg.Vec3.sub(c,e,[]),o);if(o>=0){if(n<0)return;
if(n>o)return}else{if(n>0)return;if(n<o)return}if(h===0)h=0;else if(k!==0)h/=k;else return;if(m===0)m=0;else if(i!==0)m/=i;else return;if(n===0)k=0;else if(o!==0)k=n/o;else return;i=m+k+h;if(i!==1){if(i===0)return;i=1/i;m*=i;k*=i;h*=i}i=[];osg.Vec3.add(osg.Vec3.mult(a,m,[]),osg.Vec3.mult(c,k,[]),i);osg.Vec3.add(osg.Vec3.mult(e,h,[]),i,i);if(osg.Vec3.valid(i)){if(i=osg.Vec3.dot(osg.Vec3.sub(i,this.start,[]),this.dir),!(i<0)&&!(i>this.length))f=osg.Vec3.cross(f,g,[]),osg.Vec3.normalize(f,f),this.hits.push({ratio:i/
this.length,nodepath:this.nodePath.slice(0),triangleHit:new osgUtil.TriangleHit(this.index-1,f,m,a,k,c,h,e)}),this.hit=!0}else osg.log("Warning: TriangleIntersect "),osg.log("hit:     "+i),osg.log("         "+a),osg.log("         "+c),osg.log("         "+e)}}};osgUtil.IntersectVisitor=function(){osg.NodeVisitor.call(this);this.matrix=[];this.hits=[];this.nodePath=[]};
osgUtil.IntersectVisitor.prototype=osg.objectInehrit(osg.NodeVisitor.prototype,{addLineSegment:function(a,c){this.start=a;this.end=c},intersectSegmentWithSphere:function(a,c,e){var f=osg.Vec3.sub(a,e.center),e=osg.Vec3.length2(f)-e.radius*e.radius;if(e<0)return!0;c=osg.Vec3.sub(c,a);a=osg.Vec3.length2(c);f=osg.Vec3.dot(f,c)*2;e=f*f-4*a*e;if(e<0)return!1;e=Math.sqrt(e);c=0.5*a;a=(-f-e)*c;f=(-f+e)*c;return a<=0&&f<=0?!1:a>=1&&f>=1?!1:!0},pushModelMatrix:function(a){if(this.matrix.length>0){var c=osg.Matrix.copy(this.matrix[this.matrix.length-
1]);osg.Matrix.preMult(c,a);this.matrix.push(c)}else this.matrix.push(a)},getModelMatrix:function(){return this.matrix.length===0?osg.Matrix.makeIdentity():this.matrix[this.matrix.length-1]},popModelMatrix:function(){return this.matrix.pop()},getWindowMatrix:function(){return this.windowMatrix},getProjectionMatrix:function(){return this.projectionMatrix},getViewMatrix:function(){return this.viewMatrix},intersectSegmentWithGeometry:function(a,c,e){ti=new osgUtil.TriangleIntersect;ti.setNodePath(this.nodePath);
ti.set(a,c);ti.apply(e);a=ti.hits.length;if(a>0){for(c=0;c<a;c++)this.hits.push(ti.hits[c]);return!0}return!1},applyCamera:function(a){this.projectionMatrix=a.getProjectionMatrix();this.viewMatrix=a.getViewMatrix();var c=a.getViewport();if(c!==void 0)this.windowMatrix=c.computeWindowMatrix();this.traverse(a)},applyNode:function(a){a.getMatrix&&this.pushModelMatrix(a.getMatrix());if(a.primitives){var c=[];osg.Matrix.copy(this.getWindowMatrix(),c);osg.Matrix.preMult(c,this.getProjectionMatrix());osg.Matrix.preMult(c,
this.getViewMatrix());osg.Matrix.preMult(c,this.getModelMatrix());var e=[];if(!osg.Matrix.inverse(c,e))return;c=osg.Matrix.transformVec3(e,this.start);e=osg.Matrix.transformVec3(e,this.end);this.intersectSegmentWithGeometry(c,e,a)}a.traverse&&this.traverse(a);a.getMatrix&&this.popModelMatrix()},apply:function(a){this.enterNode(a)!==!1&&(this.nodePath.push(a),a.getViewMatrix?this.applyCamera(a):this.applyNode(a),this.nodePath.pop())},enterNode:function(a){return a.boundingSphere!==void 0&&!this.intersectSegmentWithSphere?
!1:!0}});var osgDB={};
osgDB.parseSceneGraph=function(a){var c,e=a.children;if(a.primitives||a.attributes){c=new osg.Geometry;osg.extend(c,a);var a=c,f;for(f in a.primitives)if(c=a.primitives[f].mode,a.primitives[f].indices){var g=a.primitives[f].indices,g=new osg.BufferArray(gl[g.type],g.elements,g.itemSize);c=c?gl[c]:gl.TRIANGLES;a.primitives[f]=new osg.DrawElements(c,g)}else c=gl[c],a.primitives[f]=new osg.DrawArrays(c,a.primitives[f].first,a.primitives[f].count);for(var h in a.attributes)a.attributes.hasOwnProperty(h)&&(f=
a.attributes[h],a.attributes[h]=new osg.BufferArray(gl[f.type],f.elements,f.itemSize))}if(a.stateset){h=new osg.StateSet;if(a.stateset.textures){f=a.stateset.textures;c=0;for(g=f.length;c<g;c++)if(f[c].file){var k=new osg.Texture;osg.extend(k,f[c]);var i=new Image;i.src=f[c].file;k.setImage(i);h.setTextureAttributeAndMode(c,k);h.addUniform(osg.Uniform.createInt1(c,"Texture"+c))}else osg.log("no texture on unit "+c+" skip it")}if(a.stateset.material)f=a.stateset.material,c=new osg.Material,osg.extend(c,
f),h.setAttributeAndMode(c);a.stateset=h}a.matrix&&(c=new osg.MatrixTransform,osg.extend(c,a),c.setMatrix(osg.Matrix.copy(a.matrix)),a=c);a.projection&&(c=new osg.Projection,osg.extend(c,a),c.setProjectionMatrix(osg.Matrix.copy(a.projection)),a=c);a.objectType===void 0&&(c=new osg.Node,osg.extend(c,a),a=c);if(e){a.children=[];h=0;for(f=e.length;h<f;h++)a.addChild(osgDB.parseSceneGraph(e[h]))}return a};var osgViewer={};
WebGLUtils=function(){var a='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',c='It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org">Click here for more information.</a>',e=function(a,c){for(var e=["webgl","experimental-webgl","webkit-3d","moz-webgl"],k=null,i=0;i<e.length;++i){try{k=a.getContext(e[i],c)}catch(m){}if(k)break}return k};return{create3DContext:e,setupWebGL:function(f,g,h){function k(e){var f=
document.getElementsByTagName("body")[0];if(f){var g=window.WebGLRenderingContext?c:a;e&&(g+="<br/><br/>Status: "+e);f.innerHTML='<div style="margin: auto; width:500px;z-index:10000;margin-top:20em;text-align:center;">'+g+"</div>"}}h=h||k;f.addEventListener&&f.addEventListener("webglcontextcreationerror",function(a){h(a.statusMessage)},!1);(f=e(f,g))||h("");return f}}}();
if(!window.requestAnimationFrame)window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}();var Stats={Stats:function(a){this.layers=[];this.last_update=void 0;this.canvas=a}};
Stats.Stats.prototype={addLayer:function(a,c){a===void 0&&(a="rgb(255,255,255)");this.layers.push({previous:0,color:a,getValue:c})},update:function(){var a=(new Date).getTime();if(this.last_update===void 0)this.last_update=a;var c=(a-this.last_update)*120/1E3;if(!(c<1)){var e=this.canvas,f=e.width,g=e.height,h=e.getContext("2d");h.save();h.globalCompositeOperation="copy";h.mozImageSmoothingEnabled=!1;h.translate(-c,0);h.drawImage(e,0,0,f,g);h.restore();h.clearRect(f-c,0,c,g);for(var k=0,i=this.layers.length;k<
i;k++){var m=this.layers[k],e=this.canvas,n=m.getValue(a),f=e.width,g=e.height;h.lineWidth=1;h.strokeStyle=m.color;h.beginPath();h.moveTo(f-c,g-m.previous);h.lineTo(f,g-n);h.stroke();m.previous=n}this.last_update=a}}};
osgViewer.Viewer=function(a,c,e){c===void 0&&(c={antialias:!0});if(gl=WebGLUtils.setupWebGL(a,c,e)){if(this.gl=gl,osg.init(),this.canvas=a,this.frameRate=60,osgUtil.UpdateVisitor=osg.UpdateVisitor,osgUtil.CullVisitor=osg.CullVisitor,this.urlOptions=!0,this.mouseEventNode=this.mouseWheelEventNode=a,this.keyboardEventNode=document,c){if(c.mouseWheelEventNode)this.mouseWheelEventNode=c.mouseWheelEventNode;if(c.mouseEventNode)this.mouseEventNode=c.mouseEventNode;if(c.mouseWheelEventNode)this.keyboardEventNode=
c.keyboardEventNode}}else throw"No WebGL implementation found";};
osgViewer.Viewer.prototype={getScene:function(){return this.scene},setScene:function(a){this.root.removeChildren();this.root.addChild(a);this.scene=a},init:function(){this._done=!1;this.root=new osg.Node;this.state=new osg.State;this.view=new osg.View;this.view.addChild(this.root);var a=this.canvas.width/this.canvas.height;this.view.setViewport(new osg.Viewport(0,0,this.canvas.width,this.canvas.height));this.view.setViewMatrix(osg.Matrix.makeLookAt([0,0,-10],[0,0,0],[0,1,0]));this.view.setProjectionMatrix(osg.Matrix.makePerspective(60,
a,1,1E3));this.view.light=new osg.Light;this.view.getOrCreateStateSet().setAttributeAndMode(new osg.Material);gl.enable(gl.DEPTH_TEST);gl.enable(gl.BLEND);gl.enable(gl.CULL_FACE);gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,!0);this.updateVisitor=new osgUtil.UpdateVisitor;this.cullVisitor=new osgUtil.CullVisitor;this.renderStage=new osg.RenderStage;this.stateGraph=new osg.StateGraph;this.renderStage.setViewport(this.view.getViewport());this.urlOptions&&this.parseOptions()},parseOptions:function(){var a=
function(){for(var a=[],e,f=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),g=0;g<f.length;g++)e=f[g].split("="),a.push(e[0]),a[e[0]]=e[1];return a}();(a.stats==="1"||a.STATS==="1"||a.Stats==="1")&&this.initStats(a);a.DEPTH_TEST==="0"&&gl.disable(gl.DEPTH_TEST);a.BLEND==="0"&&gl.disable(gl.BLEND);a.CULL_FACE==="0"&&gl.disable(gl.CULL_FACE);a.LIGHT==="0"&&delete this.view.light},initStats:function(a){var c=50,e=10;a.statsMaxMS!==void 0&&(c=parseInt(a.statsMaxMS));a.statsStepMS!==
void 0&&(e=parseInt(a.statsStepMS));a=function(a){var a=a===void 0?document.body:document.getElementById(a),f=document.createElement("div");f.innerHTML="<div id='StatsDiv' style='float: left; position: relative; width: 300px; height: 150px; z-index: 10;'>\n<div id='StatsLegends' style='position: absolute; left: 0px; font-size: 14px;color: #ffffff;'>\n<div id='frameRate' style='color: #00ff00;' > frameRate </div>\n<div id='frameTime' style='color: #ffff00;' > frameTime </div>\n<div id='updateTime' style='color: #d07b1f;'> updateTime </div>\n<div id='cullTime' style='color: #73e0ff;'> cullTime </div>\n<div id='drawTime' style='color: #ff0000;'> drawTime </div>\n<div id='fps'> </div>\n</div>\n<div id='StatsCanvasDiv' style='position: relative;'>\n<canvas id='StatsCanvasGrid' width='300' height='150' style='z-index:-1; position: absolute; background: rgba(14,14,14,0.8); ' ></canvas>\n<canvas id='StatsCanvas' width='300' height='150' style='z-index:8; position: absolute;' ></canvas>\n<canvas id='StatsCanvasFps' width='30' height='15' style='z-index:9; position: absolute; top: 130px' ></canvas>\n</div>\n</div>";
a.appendChild(f);a=document.getElementById("StatsCanvasGrid");f=a.getContext("2d");f.clearRect(0,0,a.width,a.height);var g=Math.floor(c/e).toFixed(0),h=a.height/g;f.strokeStyle="rgb(70,70,70)";for(var o=0;o<g;o++)f.beginPath(),f.moveTo(0,o*h),f.lineTo(a.width,o*h),f.stroke();f=document.getElementById("StatsCanvasFps").getContext("2d");f.font="14px Sans";return document.getElementById("StatsCanvas")};if(this.canvasStats===void 0||this.canvasStats===null)this.canvasStats=a();this.stats=new Stats.Stats(this.canvasStats);
var f=this;this.frameRate=1;this.drawTime=this.cullTime=this.updateTime=this.frameTime=0;var g=this.canvasStats.height,h=g/c;g-=2;a=function(a,c){var e=document.getElementById(a);return e.style?e.style.getPropertyValue(c):null};this.stats.addLayer(a("frameRate","color"),function(){var a=g/60*(1E3/f.frameRate);return a>g?g:a});this.stats.addLayer(a("frameTime","color"),function(){var a=f.frameTime*h;return a>g?g:a});this.stats.addLayer(a("updateTime","color"),function(){var a=f.updateTime*h;return a>
g?g:a});this.stats.addLayer(a("cullTime","color"),function(){var a=f.cullTime*h;return a>g?g:a});this.stats.addLayer(a("drawTime","color"),function(){var a=f.drawTime*h;return a>g?g:a})},update:function(){this.view.accept(this.updateVisitor)},cull:function(){this.stateGraph.clean();this.renderStage.reset();this.cullVisitor.reset();this.cullVisitor.setStateGraph(this.stateGraph);this.cullVisitor.setRenderStage(this.renderStage);this.renderStage.setClearDepth(this.view.getClearDepth());this.renderStage.setClearColor(this.view.getClearColor());
this.renderStage.setClearMask(this.view.getClearMask());this.view.accept(this.cullVisitor)},draw:function(){this.renderStage.draw(this.state);this.state.popAllStateSets()},frame:function(){var a;a=(new Date).getTime();if(this.lastFrameTime===void 0)this.lastFrameTime=0;this.frameRate=a-this.lastFrameTime;this.lastFrameTime=a;if(this.updateVisitor.getFrameStamp().getFrameNumber()===0)this.updateVisitor.getFrameStamp().setReferenceTime(a/1E3),this.numberFrame=0;this.updateVisitor.getFrameStamp().setSimulationTime(a/
1E3-this.updateVisitor.getFrameStamp().getReferenceTime());this.manipulator&&this.view.setViewMatrix(this.manipulator.getInverseMatrix());var c=(new Date).getTime();this.update();var e=(new Date).getTime();this.updateTime=e-c;this.cull();c=(new Date).getTime();this.cullTime=c-e;this.draw();this.drawTime=c=(new Date).getTime()-c;e=this.updateVisitor.getFrameStamp().getFrameNumber()+1;this.updateVisitor.getFrameStamp().setFrameNumber(e);this.numberFrame++;e=(new Date).getTime();this.frameTime=(new Date).getTime()-
a;if(this.stats!==void 0&&(this.stats.update(),this.numberFrame%60===0))a=(this.numberFrame*1E3/(e-this.statsStartTime)).toFixed(1),this.statsStartTime=e,this.numberFrame=0,e=document.getElementById("StatsCanvasFps"),c=e.getContext("2d"),c.clearRect(0,0,e.width,e.height),c.fillStyle="rgb(255,255,255)",c.fillText(a,0,e.height)},setDone:function(){this._done=!0},done:function(){return this._done},run:function(){var a=this,c=function(){a.done()||(window.requestAnimationFrame(c,a.canvas),a.frame())};
c()},getManipulator:function(){return this.manipulator},setupManipulator:function(a,c){a===void 0&&(a=new osgGA.OrbitManipulator);a.setNode!==void 0?a.setNode(this.root):a.view=this.view;this.manipulator=a;var e=this,f=this;this.manipulator.convertEventToCanvas=function(a){var c=e.canvas,f,g;if(a.pageX||a.pageY)f=a.pageX,g=a.pageY;else if(a.clientX||a.clientY)f=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,g=a.clientY+document.body.scrollTop+document.documentElement.scrollTop;
a=function(a){for(var c=0,e=0,c=a.offsetLeft,e=a.offsetTop,f=document.getElementsByTagName("body")[0];a.offsetParent&&a!=f;)c+=a.offsetParent.offsetLeft,e+=a.offsetParent.offsetTop,a=a.offsetParent;return[c,e]}(c);f-=a[0];g=c.height-(g-a[1]);return[f,g]};if(c===void 0||c===!1){var g=!1;this.canvas.addEventListener("touchstart",function(a){g=!0;return f.getManipulator().touchStart(a)},!1);this.canvas.addEventListener("touchend",function(a){g=!0;return f.getManipulator().touchEnd(a)},!1);this.canvas.addEventListener("touchmove",
function(a){g=!0;return f.getManipulator().touchMove(a)},!1);var h=function(a){if(g===!1)return f.getManipulator().mousedown(a)},k=function(a){if(g===!1)return f.getManipulator().mouseup(a)},i=function(a){if(g===!1)return f.getManipulator().mousemove(a)},m=function(a){if(g===!1)return f.getManipulator().dblclick(a)},n=function(a){if(g===!1){var c=a||window.event,e=[].slice.call(arguments,1),h=0,k=0,i=0;a.type="mousewheel";a.wheelDelta&&(h=a.wheelDelta/120);a.detail&&(h=-a.detail/3);i=h;c.axis!==void 0&&
c.axis===c.HORIZONTAL_AXIS&&(i=0,k=-1*h);c.wheelDeltaY!==void 0&&(i=c.wheelDeltaY/120);c.wheelDeltaX!==void 0&&(k=-1*c.wheelDeltaX/120);e.unshift(a,h,k,i);c=f.getManipulator();return c.mousewheel.apply(c,e)}};f.getManipulator().mousedown&&this.mouseEventNode.addEventListener("mousedown",h,!1);f.getManipulator().mouseup&&this.mouseEventNode.addEventListener("mouseup",k,!1);f.getManipulator().mousemove&&this.mouseEventNode.addEventListener("mousemove",i,!1);f.getManipulator().dblclick&&this.mouseEventNode.addEventListener("dblclick",
m,!1);f.getManipulator().mousewheel&&(this.mouseWheelEventNode.addEventListener("DOMMouseScroll",n,!1),this.mouseWheelEventNode.addEventListener("mousewheel",n,!1));h=function(a){return f.getManipulator().keydown(a)};k=function(a){return f.getManipulator().keyup(a)};f.getManipulator().keydown&&this.keyboardEventNode.addEventListener("keydown",h,!1);f.getManipulator().keyup&&this.keyboardEventNode.addEventListener("keyup",k,!1)}}};osgGA={OrbitManipulatorMode:{Rotate:0,Pan:1,Zoom:2},OrbitManipulator:function(){this.init()}};
osgGA.OrbitManipulator.prototype={init:function(){this.distance=25;this.target=[0,0,0];this.eye=[0,this.distance,0];this.rotation=osg.Matrix.mult(osg.Matrix.makeRotate(Math.PI,0,0,1),osg.Matrix.makeRotate(-Math.PI/10,1,0,0),[]);this.up=[0,0,1];this.dy=this.dx=this.time=0;this.buttonup=!0;this.scale=1;this.targetDistance=this.distance;this.currentMode=osgGA.OrbitManipulatorMode.Rotate;this.minDistance=this.maxDistance=0},reset:function(){this.init()},setNode:function(a){this.node=a},setTarget:function(a){osg.Vec3.copy(a,
this.target)},computeHomePosition:function(){if(this.node!==void 0){var a=this.node.getBound();this.setDistance(a.radius()*1.5);this.setTarget(a.center())}},keydown:function(a){if(a.keyCode===32)this.computeHomePosition();else if(a.keyCode===33)return this.distanceIncrease(),!1;else if(a.keyCode===34)return this.distanceDecrease(),!1},keyup:function(){},mouseup:function(a){this.panning=this.dragging=!1;this.releaseButton(a)},mousedown:function(a){this.dragging=this.panning=!0;var c=this.convertEventToCanvas(a);
this.clientX=c[0];this.clientY=c[1];this.pushButton(a);a.preventDefault()},mousemove:function(a){if(this.buttonup!==!0){var c,e,f;c=this.convertEventToCanvas(a);a=c[0];c=c[1];e=(this.clientX-a)/10;f=(this.clientY-c)/10;this.clientX=a;this.clientY=c;this.update(e,f);return!1}},dblclick:function(){},touchDown:function(){},touchUp:function(){},touchMove:function(){},setMaxDistance:function(a){this.maxDistance=a},setMinDistance:function(a){this.minDistance=a},setDistance:function(a){this.targetDistance=
this.distance=a},panModel:function(a,c){var e=osg.Matrix.inverse(this.rotation),f=[osg.Matrix.get(e,0,0),osg.Matrix.get(e,0,1),0];osg.Vec3.normalize(f,f);e=[osg.Matrix.get(e,1,0),osg.Matrix.get(e,1,1),0];osg.Vec3.normalize(e,e);osg.Vec3.add(this.target,osg.Vec3.mult(f,-a),this.target);osg.Vec3.add(this.target,osg.Vec3.mult(e,-c),this.target)},zoomModel:function(a,c){this.distance+=c},computeRotation:function(a,c){var e=osg.Matrix.makeRotate(a/10,0,0,1),f=osg.Matrix.mult(this.rotation,e,[]),e=osg.Matrix.makeRotate(c/
10,1,0,0),e=osg.Matrix.mult(e,f,[]),g=osg.Matrix.transformVec3(osg.Matrix.inverse(e),[0,this.distance,0]),g=osg.Vec3.neg(g,[]);osg.Vec3.normalize(g,g);g=osg.Vec3.dot(g,[0,0,1]);this.rotation=Math.abs(g)>0.95?f:e},update:function(a,c){this.dx=a;this.dy=c;if(Math.abs(a)+Math.abs(c)>0)this.time=(new Date).getTime()},updateWithDelay:function(){var a=1,c,e=this.dx,f=this.dy;this.buttonup?(a=0,c=((new Date).getTime()-this.time)/1E3,c<2&&(a=1-osgAnimation.EaseOutQuad(c/2)),e*=a,f*=a):this.dy=this.dx=0;Math.abs(e)+
Math.abs(f)>0&&(this.currentMode===osgGA.OrbitManipulatorMode.Pan?this.panModel(e/this.scale,f/this.scale):this.currentMode===osgGA.OrbitManipulatorMode.Rotate?this.computeRotation(e,f):this.currentMode===osgGA.OrbitManipulatorMode.Zoom&&this.zoomModel(e,f))},releaseButton:function(){this.buttonup=!0},changeScale:function(a){var c=this.scale/a;this.scale=a;this.distance=this.targetDistance;this.targetDistance=this.distance*c;this.timeMotion=(new Date).getTime()},mousewheel:function(a,c){c>0?this.distanceDecrease&&
this.distanceDecrease():c<0&&this.distanceIncrease&&this.distanceIncrease()},distanceIncrease:function(){var a=this.targetDistance,c=a+this.distance/10;if(this.maxDistance>0&&c>this.maxDistance)c=this.maxDistance;this.distance=a;this.targetDistance=c;this.timeMotion=(new Date).getTime()},distanceDecrease:function(){var a=this.targetDistance,c=a-this.distance/10;if(this.minDistance>0&&c<this.minDistance)c=this.minDistance;this.distance=a;this.targetDistance=c;this.timeMotion=(new Date).getTime()},
pushButton:function(){this.dx=this.dy=0;this.buttonup=!1},getInverseMatrix:function(){this.updateWithDelay();var a=this.target,c=this.distance;if(this.timeMotion!==void 0){var e=((new Date).getTime()-this.timeMotion)/1E3;if(e<1)e=osgAnimation.EaseOutQuad(e/1),this.targetMotion&&(a=osg.Vec3.add(this.target,osg.Vec3.mult(osg.Vec3.sub(this.targetMotion,this.target),e))),this.targetDistance&&(c=this.distance+(this.targetDistance-this.distance)*e);else{if(this.targetMotion)a=this.target=this.targetMotion;
if(this.targetDistance)c=this.distance=this.targetDistance;this.timeMotion=void 0}}var e=[],f=[];osg.Matrix.inverse(this.rotation,e);osg.Matrix.transformVec3(e,[0,c,0],f);osg.Matrix.makeLookAt(osg.Vec3.add(a,f,f),a,[0,0,1],e);return e}};osgGA.FirstPersonManipulator=function(){this.init()};
osgGA.FirstPersonManipulator.prototype={setNode:function(a){this.node=a},computeHomePosition:function(){if(this.node)this.eye=[0,-this.node.getBound().radius()*1.5,0]},init:function(){this.direction=[0,1,0];this.angleHorizontal=this.angleVertical=0;this.eye=[0,25,10];this.up=[0,0,1];this.time=0;this.buttonup=!0},reset:function(){this.init()},mouseup:function(a){this.dragging=!1;this.releaseButton(a)},mousedown:function(a){this.dragging=!0;var c=this.convertEventToCanvas(a);this.clientX=c[0];this.clientY=
c[1];this.pushButton(a)},mousemove:function(a){if(this.buttonup!==!0){var c,e,f;c=this.convertEventToCanvas(a);a=c[0];c=c[1];e=this.clientX-a;f=this.clientY-c;this.clientX=a;this.clientY=c;this.update(e,f);this.computeRotation(this.dx,this.dy)}},dblclick:function(){},touchdown:function(){},touchup:function(){},touchmove:function(){},pushButton:function(){this.dx=this.dy=0;this.buttonup=!1},computeRotation:function(a,c){this.angleVertical+=c*0.01;this.angleHorizontal-=a*0.01;var e=osg.Matrix.makeRotate(this.angleVertical,
1,0,0),f=osg.Matrix.makeRotate(this.angleHorizontal,0,0,1),e=osg.Matrix.mult(f,e,[]);this.direction=osg.Matrix.transformVec3(e,[0,1,0],[]);this.up=osg.Matrix.transformVec3(e,[0,0,1],[])},update:function(a,c){this.dx=a;this.dy=c;if(Math.abs(a)+Math.abs(c)>0)this.time=(new Date).getTime()},releaseButton:function(){this.buttonup=!0},getInverseMatrix:function(){var a=osg.Vec3.add(this.eye,this.direction,[]);return osg.Matrix.makeLookAt(this.eye,a,this.up,[])},moveForward:function(a){a=osg.Vec3.mult(osg.Vec3.normalize(this.direction,
[]),a,[]);this.eye=osg.Vec3.add(this.eye,a,[])},strafe:function(a){var c=osg.Vec3.cross(this.direction,this.up,[]),a=osg.Vec3.mult(osg.Vec3.normalize(c,c),a,[]);this.eye=osg.Vec3.add(this.eye,a,[])},keydown:function(a){if(a.keyCode===32)this.computeHomePosition();else if(a.keyCode==87)return this.moveForward(5),!1;else if(a.keyCode==83)return this.moveForward(-5),!1;else if(a.keyCode==68)return this.strafe(5),!1;else if(a.keyCode==65)return this.strafe(-5),!1}};
osg.Matrix.equals=function(a,c){if(a==c)return!0;if(a.length!=c.length)return!1;for(var e=0;e<a.length;e++)if(a[e]!=c[e])return!1;return!0};osg.Quat.multiply=function(a,c,e){e===void 0&&(e=[]);return osg.Quat.mult(c,a,e)};osg.Quat.zeroRotation=function(a){return a[0]===0&&a[1]===0&&a[2]===0&&a[3]===1};
osg.Quat.transformVec3=function(a,c){var e=[],f=[],g=[a[0],a[1],a[2]];osg.Vec3.cross(g,c,e);osg.Vec3.cross(g,e,f);osg.Vec3.mult(e,2*a[3],e);osg.Vec3.mult(f,2,f);return osg.Vec3.add(c,osg.Vec3.add(e,f,[]),[])};
osg.Quat.rotateVecOnToVec=function(a,c,e){e===void 0&&(e=[]);var f=osg.Vec3.copy(a,[]),g=osg.Vec3.copy(c,[]),a=osg.Vec3.length2(a),h=0;if(a<0.9999999||a>1.0000001)h=Math.sqrt(a),f=osg.Vec3.mult(f,1/h,[]);c=osg.Vec3.length2(c);if(c<0.9999999||c>1.0000001)var k=0,k=c>a-1.0E-7&&c<a+1.0E-7?h:Math.sqrt(c),g=osg.Vec3.mult(g,1/k,[]);a=1+osg.Vec3.dot(f,g);a<1.0E-7?(Math.abs(f[0])<0.6?(g=Math.sqrt(1-f[0]*f[0]),e[0]=0,e[1]=f[2]/g,e[2]=-f[1]/g):Math.abs(f[1])<0.6?(g=Math.sqrt(1-f[1]*f[1]),e[0]=-f[2]/g,e[1]=
0,e[2]=f[0]/g):(g=Math.sqrt(1-f[2]*f[2]),e[0]=f[1]/g,e[1]=-f[0]/g,e[2]=0),e[3]=0):(a=Math.sqrt(0.5*a),f=osg.Vec3.cross(f,osg.Vec3.mult(g,1/(2*a)),[]),e[0]=f[0],e[1]=f[1],e[2]=f[2],e[3]=a);return e};osg.StateSet.removeUniform=function(a,c){delete a.uniforms[c];var e=a.uniforms.uniformKeys.indexOf(c);e!==-1&&(delete a.uniforms.uniformKeys[e],a.uniforms.uniformKeys.splice(e,1))};osg.BufferArray.destroy=function(a){a!==void 0&&a!==null&&a.buffer!==void 0&&a.buffer!==null&&gl.deleteBuffer(a.buffer)};
osg.Geometry.destroy=function(a){if(a!==void 0&&a!==null){for(var c in a.attributes)osg.BufferArray.destroy(a.attributes[c]);for(c in a.primitives){var e=a.primitives[c];e!==void 0&&e!==null&&e.indices!==void 0&&e.indices!==null&&osg.BufferArray.destroy(e.indicies)}}};osg.Texture.destroy=function(a){if(a!==void 0&&a!==null&&a.textureObject!==null)gl.deleteTexture(a.textureObject),a.textureObject=null,a.image=void 0};
var osgearth={copyright:"(c) Copyright 2011 Pelican Mapping - http://pelicanmapping.com",instance:0,version:"0.0.1",log:function(a){window.console!==void 0?window.console.log(a):jQuery("#debug").append(a+"<br>")},ProxyHost:"proxy.php?url="};osgearth.getURL=function(a){if(osgearth.ProxyHost!==null&&window.document.URL.indexOf("file:")===0)osgearth.ProxyHost=null;osgearth.ProxyHost!==void 0&&osgearth.ProxyHost!==null&&(a=osgearth.ProxyHost+encodeURIComponent(a));return a};
osgearth.FunctionLocation={VertexPreTexture:0,VertexPreLighting:1,VertexPostLighting:2,FragmentPreTexture:3,FragmentPreLighting:4,FragmentPostLighting:5};osgearth.ShaderFactory={};osgearth.ShaderFactory.createVertexShaderMain=function(){return"#ifdef GL_ES\nprecision highp float;\n#endif\nattribute vec3 Vertex;\nattribute vec4 Color;\nattribute vec3 Normal;\nattribute vec3 Elevation;\nuniform int ArrayColorEnabled;\nuniform mat4 ModelViewMatrix;\nuniform mat4 ProjectionMatrix;\nuniform mat4 NormalMatrix;\nuniform int osgearth_LightingEnabled;\nuniform float VerticalScale;\nvarying vec4 VertexColor;\nvoid osgearth_vert_setupTexturing(void);\n\nvoid main() {\n    gl_Position = ProjectionMatrix * ModelViewMatrix * vec4(Vertex + VerticalScale*Elevation, 1.0);\n    if (ArrayColorEnabled == 1)\n        VertexColor = Color;\n    else\n        VertexColor = vec4(1.0,1.0,1.0,1.0);\n\n    osgearth_vert_setupTexturing();\n}"};
osgearth.ShaderFactory.createFragmentShaderMain=function(){return"#ifdef GL_ES\nprecision highp float;\n#endif\nvarying vec4 VertexColor;\nuniform int osgearth_LightingEnabled;\nvoid osgearth_frag_applyTexturing(inout vec4 color);\n\nvoid main(void) {\n    vec4 color = VertexColor;\n    osgearth_frag_applyTexturing(color);\n    gl_FragColor = color;\n}"};
osgearth.ShaderFactory.createVertexSetupTexturing=function(a){var c="",e;for(e=0;e<a.length;++e)c+="attribute vec2 TexCoord"+e+";\n",c+="uniform mat4 TexMat"+e+";\n",c+="varying vec2 FragTexCoord"+e+";\n";c+="void osgearth_vert_setupTexturing(void) { \n";for(e=0;e<a.length;e++)c+="    FragTexCoord"+e+" = (TexMat"+e+" * vec4(TexCoord"+e+",0,1)).xy;\n";c+="}\n";return c};
osgearth.ShaderFactory.createFragmentApplyTexturing=function(a){var c="",e;for(e=0;e<a.length;++e)c+="varying vec2 FragTexCoord"+e+";\n",c+="uniform sampler2D Texture"+e+";\n",c+="uniform bool Texture"+e+"Visible;\n",c+="uniform float Texture"+e+"Opacity;\n";c+="void osgearth_frag_applyTexturing(inout vec4 color) {\n";c+="    vec4 texel;\n";for(e=0;e<a.length;++e)c+="    if (Texture"+e+"Visible) { \n",c+="        texel = texture2D(Texture"+e+", FragTexCoord"+e+".xy );\n",c+="        color = vec4( mix( color.rgb, texel.rgb, texel.a * Texture"+
e+"Opacity), 1);\n",c+="    } \n";c+="}\n";return c};osgearth.VirtualProgram=function(){osg.Program.call(this);this.virtualProgramMarker=!0;this.shaderMap={};this.funcSemanticsByLocation={};this.accumulatedFuncSemanticsByLocation={};this.programCache={};this.vertex={};this.fragment={};this._dirty=!0;this.refreshMains()};
osgearth.VirtualProgram.prototype=osg.objectInehrit(osg.Program.prototype,{isVirtualProgram:function(){return!0},cloneType:function(){return new osgearth.VirtualProgram},setShader:function(a,c,e){this.shaderMap[a+";"+c]=e;this._dirty=!0},setFunction:function(a,c,e){this.semanticsByLocation[e]===void 0&&(this.semanticsByLocation[e]=[]);a=a+";"+(e<=2?gl.VERTEX_SHADER:gl.FRAGMENT_SHADER);this.setShader(a,c);this.funcSemanticsByLocation[e].push(a);this._dirty=!0},refreshMains:function(){this.setShader("osgearth_vert_main",
gl.VERTEX_SHADER,osgearth.ShaderFactory.createVertexShaderMain(this.accumulatedFunctions));this.setShader("osgearth_frag_main",gl.FRAGMENT_SHADER,osgearth.ShaderFactory.createFragmentShaderMain(this.accumulatedFunctions))},apply:function(a){var c=a.attributeMap[this.attributeType];if(c!==void 0){for(var e="",f=0;f<c.length;++f){var g=c[f];if(this.isVirtualProgram(g))for(var h in g.shaderMap)e+=h}for(h in this.shaderMap)e+=h;this.program=this.programCache[e];if(this.program===void 0){this.refreshAccumulatedFunctions(a);
this.refreshMains();c=a="";for(h in this.shaderMap)parseInt(h.split(";")[1])===gl.VERTEX_SHADER?a+=this.shaderMap[h]+"\n":c+=this.shaderMap[h]+"\n";this.vertex=new osg.Shader(gl.VERTEX_SHADER,a);this.vertex.compile();this.fragment=new osg.Shader(gl.FRAGMENT_SHADER,c);this.fragment.compile();this.program=gl.createProgram();gl.attachShader(this.program,this.vertex.shader);gl.attachShader(this.program,this.fragment.shader);gl.linkProgram(this.program);gl.validateProgram(this.program);if(!gl.getProgramParameter(this.program,
gl.LINK_STATUS)){osg.log("can't link program\nvertex shader:\n"+this.vertex.text+"\n fragment shader:\n"+this.fragment.text);osg.log(gl.getProgramInfoLog(this.program));debugger}this.uniformsCache={};this.uniformsCache.uniformKeys=[];this.attributesCache={};this.attributesCache.attributeKeys=[];this.cacheUniformList(this.vertex.text);this.cacheUniformList(this.fragment.text);this.cacheAttributeList(this.vertex.text);this.programCache[e]=this.program;osg.log(a);osg.log(c)}gl.useProgram(this.program)}},
refreshAccumulatedFunctions:function(a){a=a.attributeMap[this.attributeType];if(!(a===void 0||a.length==0)){this.accumulatedFunctions={};for(var c=0;c<a.length;++c){var e=a[c];if(this.isVirtualProgram(e))for(var f in e.funcSemanticsByLocation){this.accumulatedFuncSemanticsByLocation[f]===void 0&&(this.accumulatedFuncSemanticsByLocation[f]={});for(var g=e.funcSemanticsByLocation[f],h=0;h<g.length;++h){var k=g[h].split(";")[0];this.accumulatedFuncSemanticsByLocation[f][k]=k}}}}}});
osgearth.Extent={width:function(a){return a.xmax-a.xmin},height:function(a){return a.ymax-a.ymin},center:function(a){return[(a.xmin+a.xmax)/2,(a.ymin+a.ymax)/2]},clamp:function(a,c){c[0]=Math.clamp(c[0],a.xmin,a.xmax);c[1]=Math.clamp(c[1],a.ymin,a.ymax)}};osgearth.EllipsoidModel=function(){this.setRadii(6378137,6356752.3142)};
osgearth.EllipsoidModel.prototype={setRadii:function(a,c){this.radiusEquator=a;this.radiusPolar=c;var e=(a-c)/a;this.ecc2=2*e-e*e;this.absMaxMerc_m=Math.PI*this.radiusEquator},lla2ecef:function(a){var c=Math.sin(a[1]),e=Math.cos(a[1]),f=this.radiusEquator/Math.sqrt(1-this.ecc2*c*c);return[(f+a[2])*e*Math.cos(a[0]),(f+a[2])*e*Math.sin(a[0]),(f*(1-this.ecc2)+a[2])*c]},ecef2lla:function(a){var c=Math.sqrt(a[0]*a[0]+a[1]*a[1]),e=Math.atan2(a[2]*this.radiusEquator,c*this.radiusPolar),f=Math.sin(e),e=Math.cos(e),
f=Math.atan((a[2]+(this.radiusEquator*this.radiusEquator-this.radiusPolar*this.radiusPolar)/(this.radiusPolar*this.radiusPolar)*this.radiusPolar*f*f*f)/(c-this.ecc2*this.radiusEquator*e*e*e)),e=Math.sin(f);return[Math.atan2(a[1],a[0]),f,c/Math.cos(f)-this.radiusEquator/Math.sqrt(1-this.ecc2*e*e)]},local2worldFromECEF:function(a){var c=this.ecef2lla(a),a=osg.Matrix.makeTranslate(a[0],a[1],a[2]),e=[Math.cos(c[0])*Math.cos(c[1]),Math.sin(c[0])*Math.cos(c[1]),Math.sin(c[1])],c=[-Math.sin(c[0]),Math.cos(c[0]),
0],f=osg.Vec3.cross(e,c,[]);osg.Matrix.set(a,0,0,c[0]);osg.Matrix.set(a,0,1,c[1]);osg.Matrix.set(a,0,2,c[2]);osg.Matrix.set(a,1,0,f[0]);osg.Matrix.set(a,1,1,f[1]);osg.Matrix.set(a,1,2,f[2]);osg.Matrix.set(a,2,0,e[0]);osg.Matrix.set(a,2,1,e[1]);osg.Matrix.set(a,2,2,e[2]);return a},local2worldFromLLA:function(a){a=lla2ecef(a);return local2worldFromECEF(a)}};osgearth.Profile=function(){this.ellipsoid=new osgearth.EllipsoidModel};
osgearth.Profile.prototype={getTileSize:function(a){for(var c=osgearth.Extent.width(this.extent)/this.baseTilesX,e=osgearth.Extent.height(this.extent)/this.baseTilesY,f=0;f<a;f++)c/=2,e/=2;return[c,e]},getTileCount:function(a){a=Math.pow(2,a);return[this.baseTilesX*a,this.baseTilesY*a]}};osgearth.GeodeticProfile=function(){osgearth.Profile.call(this);this.name="WGS84";this.extent={xmin:-Math.PI,ymin:-Math.PI/2,xmax:Math.PI,ymax:Math.PI/2};this.baseTilesX=2;this.baseTilesY=1;this.isGeographic=!0};
osgearth.GeodeticProfile.prototype=osg.objectInehrit(osgearth.Profile.prototype,{});
osgearth.MercatorProfile=function(){osgearth.Profile.call(this);this.name="Mercator";this.extent={xmin:-this.ellipsoid.absMaxMerc_m,ymin:-this.ellipsoid.absMaxMerc_m,xmax:this.ellipsoid.absMaxMerc_m,ymax:this.ellipsoid.absMaxMerc_m};this.baseTilesY=this.baseTilesX=2;this.isGeographic=!1;var a=this.toLLA([this.extent.xmin,this.extent.ymin,0]),c=this.toLLA([this.extent.xmax,this.extent.ymax,0]);this.extentLLA={xmin:a[0],ymin:a[1],xmax:c[0],ymax:c[1]}};
osgearth.MercatorProfile.prototype=osg.objectInehrit(osgearth.Profile.prototype,{getUV:function(a,c){var e=(c[0]-a.xmin)/osgearth.Extent.width(a),f=this.lat2v(Math.clamp(a.ymax,this.extentLLA.ymin,this.extentLLA.ymax)),g=this.lat2v(Math.clamp(a.ymin,this.extentLLA.ymin,this.extentLLA.ymax)),f=1-(this.lat2v(Math.clamp(c[1],this.extentLLA.ymin,this.extentLLA.ymax))-f)/(g-f);return[e,f]},lat2v:function(a){a=Math.sin(a);return 0.5-Math.log((1+a)/(1-a))/(4*Math.PI)},fromLLA:function(a){return[a[0]*this.ellipsoid.radiusEquator,
this.ellipsoid.absMaxMerc_m-this.lat2v(a[1])*2*this.ellipsoid.absMaxMerc_m,a[2]]},toLLA:function(a){return[a[0]/this.ellipsoid.radiusEquator,2*Math.atan(Math.exp(a[1]/this.ellipsoid.radiusEquator))-Math.PI/2,a[2]]}});
osgearth.TileKey={x:function(a){return a[0]},y:function(a){return a[1]},lod:function(a){return a[2]},valid:function(a){return a[2]>=0},parent:function(a){return[parseInt(a[0]/2),parseInt(a[1]/2),lod-1]},child:function(a,c){return[a[0]*2+(c==1?1:0)+(c==3?1:0),a[1]*2+(c==2?1:0)+(c==3?1:0),a[2]+1]},getExtent:function(a,c){var e=c.getTileSize(a[2]),f=c.extent.xmin+e[0]*a[0],g=c.extent.ymax-e[1]*a[1];return{xmin:f,ymin:g-e[1],xmax:f+e[0],ymax:g}},getExtentLLA:function(a,c){var e=this.getExtent(a,c);if(c.toLLA!==
void 0){var f=[e.xmin,e.ymin,0],e=[e.xmax,e.ymax,0],f=c.toLLA(f),e=c.toLLA(e);return{xmin:f[0],ymin:f[1],xmax:e[0],ymax:e[1]}}else return e}};osgearth.ImageLayer=function(a){this.name=a;this.profile=void 0;this.opacity=1;this.visible=!0;this.draw=!1};
osgearth.ImageLayer.prototype={name:function(){return this.name},getOpacity:function(){return this.opacity},setOpacity:function(a){if(this.opacity!=a)this.opacity=a,this.opacityUniform!==void 0&&this.opacityUniform.set([this.opacity])},getVisible:function(){return this.visible},setVisible:function(a){if(this.visible!=a)this.visible=a,this.visibleUniform!==void 0&&this.visibleUniform.set([this.visible])}};
osgearth.HeightField=function(a,c,e){this._numColumns=a;this._numRows=c;e===void 0&&(e=Array(a*c));this._data=e};osgearth.HeightField.prototype={getNumColumns:function(){return this._numColumns},getNumRows:function(){return this._numRows},getHeight:function(a,c){var e=a+c*this._numColumns;if(e<0||e>=this._data.length)throw"Index out of bounds";return this._data[e]},setHeight:function(a,c,e){a+=c*this._numColumns;if(a<0||a>=this._data.length)throw"Index out of bounds";this._data[a]=e}};
osgearth.WebHeightField=function(a,c){this.url=a;this.complete=!1;this.loadNow=c===void 0?!1:c;this.refresh()};osgearth.WebHeightField.prototype=osg.objectInehrit(osgearth.HeightField.prototype,{refresh:function(){this.complete=!1;var a=this;jQuery.ajax({url:this.url,dataType:"json",async:!this.loadNow,success:function(c){a._numColumns=c.width;a._numRows=c.height;a._data=c.data;a.complete=!0},error:function(){}})}});osgearth.ElevationLayer=function(a){this.name=a;this.profile=void 0};
osgearth.ElevationLayer.prototype={name:function(){return this.name}};
osgearth.Map=function(a){this.usingDefaultProfile=!1;this.geocentric=this.threeD=!0;this.minLevel=0;this.maxLevel=22;this.waitForAllLayers=!0;this.zoomScale=1;this.minElevation=-1E6;this.maxElevation=1E6;if(a!==void 0){if(a.profile!==void 0)this.profile=a.profile;if(a.threeD!==void 0)this.threeD=a.threeD;if(a.twoD!==void 0)this.threeD=a.twoD!==!0;if(a.minLevel!==void 0)this.minLevel=a.minLevel;if(a.maxLevel!==void 0)this.maxLevel=a.maxLevel;if(a.waitForAllLayers!==void 0)this.waitForAllLayers=a.waitForAllLayers;
if(a.zoomScale!==void 0)this.zoomScale=a.zoomScale;if(a.minElevation!==void 0)this.minElevation=a.minElevation;if(a.maxElevation!==void 0)this.maxElevation=a.maxElevation;if(a.geocentric!==void 0)this.geocentric=a.geocentric;else if(this.threeD===!1)this.geocentric=!1}if(this.profile===void 0)this.profile=new osgearth.GeodeticProfile,this.usingDefaultProfile=!0;this.imageLayers=[];this.elevationLayers=[];this.drawList={};this.expireList={};this.drawListSize=0};
osgearth.Map.prototype={addImageLayer:function(a){this.imageLayers.push(a);if(this.usingDefaultProfile&&a.profile!==void 0)this.profile=a.profile,this.usingDefaultProfile=!1},addElevationLayer:function(a){this.elevationLayers.push(a)},lla2world:function(a){return this.geocentric?this.profile.ellipsoid.lla2ecef(a):this.profile.fromLLA(a)},world2lla:function(a){return this.geocentric?this.profile.ellipsoid.ecef2lla(a):this.profile.toLLA(a)},markTileDrawn:function(a){this.drawList[a.key]=a;this.expireList[a.key]=
null;this.drawListSize++},createEmptyHeightField:function(a,c){for(var e=[],f=a*c,g=0;g<f;g++)e[g]=0;return new osgearth.HeightField(a,c,e)},createHeightField:function(a,c){return this.elevationLayers.length==0?null:this.elevationLayers[0].createHeightField(a,this.profile,c)},frame:function(){for(var a in this.expireList)tile=this.expireList[a],tile!==void 0&&tile!=null&&tile.parents.length>0&&tile.resetSubtiles();this.expireList=this.drawList;delete this.drawList;this.drawList={};this.drawListSize=
0}};
osgearth.MapNode=function(a){osg.Node.call(this);this.map=a;this.verticalScale=1;for(var c=a.profile.getTileCount(a.minLevel),e=0;e<c[0];e++)for(var f=0;f<c[1];f++)this.addChild(new osgearth.Tile([e,f,a.minLevel],a,null));c=this.getOrCreateStateSet();e=new osgearth.VirtualProgram;e.setShader("osgearth_vert_setupTexturing",gl.VERTEX_SHADER,osgearth.ShaderFactory.createVertexSetupTexturing(a.imageLayers));e.setShader("osgearth_frag_applyTexturing",gl.FRAGMENT_SHADER,osgearth.ShaderFactory.createFragmentApplyTexturing(a.imageLayers));c.setAttributeAndMode(e,
osg.StateAttribute.ON);c.setAttributeAndMode(new osg.CullFace("DISABLE"));for(e=0;e<a.imageLayers.length;e++)f=a.imageLayers[e].getVisible()?!0:!1,f=osg.Uniform.createInt1(f,"Texture"+e+"Visible"),c.addUniform(f,osg.StateAttribute.ON),a.imageLayers[e].visibleUniform=f,f=a.imageLayers[e].getOpacity(),f=osg.Uniform.createFloat1(f,"Texture"+e+"Opacity"),a.imageLayers[e].opacityUniform=f,c.addUniform(f,osg.StateAttribute.ON),f=osg.Uniform.createMatrix4(osg.Matrix.makeIdentity([]),"TexMat"+e),c.addUniform(f,
osg.StateAttribute.ON),c.addUniform(osg.Uniform.createInt1(e,"Texture"+e));this.verticalScaleUniform=osg.Uniform.createFloat1(this.verticalScale,"VerticalScale");c.addUniform(this.verticalScaleUniform,osg.StateAttribute.ON)};
osgearth.MapNode.prototype=osg.objectInehrit(osg.Node.prototype,{setVerticalScale:function(a){this.verticalScaleUniform.set([a])},traverse:function(a){if(a.modelviewMatrixStack!==void 0){var c=[];osg.Matrix.inverse(a.modelviewMatrixStack[a.modelviewMatrixStack.length-1],c);if(a.eyePoint===void 0)a.eyePoint=[];osg.Matrix.getTrans(c,a.eyePoint)}for(var c=this.children.length,e=0;e<c;e++)this.children[e].accept(a)}});osgearth.MapNode.prototype.objectType=osg.objectType.generate("MapNode");
osg.CullVisitor.prototype[osgearth.MapNode.prototype.objectType]=function(a){a.stateset&&this.pushStateSet(a.stateset);this.traverse(a);a.stateset&&this.popStateSet()};
osgearth.Tile=function(a,c,e){osg.Node.call(this);this.key=a;this.map=c;a=osgearth.TileKey.getExtentLLA(a,c.profile);this.lla2local=[osgearth.Extent.width(a),0,0,0,0,osgearth.Extent.height(a),0,0,0,0,1,0,a.xmin,a.ymin,0,1];a=osgearth.Extent.center(a);this.centerWorld=c.lla2world([a[0],a[1],0]);this.centerNormal=[];osg.Vec3.normalize(this.centerWorld,this.centerNormal);this.deviation=0;this.geometry=null;this.subtilesRequested=!1;this.subtileRange=1E14;this.textures=[];this.textureReady=[];this.numTexturesReady=
0;this.parentTextures=e;c=this.key[2]==this.map.minLevel;this.heightField=this.map.createHeightField(this.key,c);e=0;for(a=this.map.imageLayers.length;e<a;e++)this.textures.push(this.map.imageLayers[e].createTexture(this.key,this.map.profile)),this.textureReady.push(!1);this.isBuilt=!1;c&&this.build(this.parentTextures)};
osgearth.Tile.prototype=osg.objectInehrit(osg.Node.prototype,{computeBound:function(a){return this.xform.computeBound(a)},insertArray:function(a,c,e){for(var f=0;f<a.length;f++)c[e+f]=a[f]},allTexturesReady:function(){return this.numTexturesReady===this.textures.length},allChildrenBuilt:function(){for(var a=0;a<this.children.length;a++)if(!this.children[a].isBuilt)return!1;return!0},buildChildren:function(){for(var a=0;a<this.children.length;a++)this.children[a].checkBuild()},checkTextures:function(){for(var a=
this.numTexturesReady=0;a<this.textures.length;a++)this.textureReady[a]===!0?this.numTexturesReady++:this.textures[a].isImageReady()&&(this.textureReady[a]=!0,this.map.waitForAllLayers===!1&&(osg.StateSet.removeUniform(this.getStateSet(),"TexMat"+a),this.getStateSet().setTextureAttributeAndMode(a,this.textures[a])),this.numTexturesReady++)},resetSubtiles:function(){var a,c=this.children.length;for(a=0;a<c;++a)this.children[a].destroy();this.removeChildren();this.subtilesRequested=!1},destroy:function(){for(j=
0;j<this.textures.length;++j)osg.Texture.destroy(this.textures[j]);osg.Geometry.destroy(this.geometry)},build:function(a){var c=[],e=[],f=[],g=[],h=[],k=[],i=this.map.threeD?8:2,m=this.map.threeD?8:2,n=osgearth.TileKey.getExtentLLA(this.key,this.map.profile),o=this.map.threeD?this.map.profile.ellipsoid.local2worldFromECEF(this.centerWorld):osg.Matrix.makeTranslate(this.centerWorld[0],this.centerWorld[1],this.centerWorld[2]),p=[];osg.Matrix.inverse(o,p);var q=[];osg.Matrix.getRotate(p,q);var t=this.map.threeD?
this.heightField:null;t!==null&&(i=t.getNumRows(),m=t.getNumColumns());for(var s=osgearth.Extent.width(n)/(m-1),u=osgearth.Extent.height(n)/(i-1),y=0,z=0,D=0,v=0,w=0;w<i;w++)for(var I=w/(i-1),B=0;B<m;B++){var F=B/(m-1),E=t!=null?t.getHeight(B,w):0,E=Math.clamp(E,this.map.minElevation,this.map.maxElevation),H=[n.xmin+s*B,n.ymin+u*w,0],G=this.map.lla2world(H),A=osg.Matrix.transformVec3(p,G,[]);this.insertArray(A,c,z);this.insertArray(this.map.geocentric?osg.Vec3.normalize(A,[]):[0,0,1],f,z);A=[];osg.Vec3.normalize(G,
A);A=osg.Quat.transformVec3(q,A);osg.Vec3.mult(A,E,A);this.insertArray(A,k,z);z+=3;B<m-1&&w<i-1&&(this.insertArray([v,v+1,v+1+m,v+1+m,v+m,v],e,y),y+=6);v++;E=[F,I];this.map.profile.getUV!==void 0&&(E=this.map.profile.getUV(n,H));this.insertArray([F,E[1]],g,D);D+=2;w==0&&B==0?h[0]=G:w==0&&B==m-1?h[1]=G:w==i-1&&B==0?h[2]=G:w==i-1&&B==m-1&&(h[3]=G)}this.geometry=new osg.Geometry;this.geometry.getAttributes().Vertex=new osg.BufferArray(gl.ARRAY_BUFFER,c,3);this.geometry.getAttributes().Normal=new osg.BufferArray(gl.ARRAY_BUFFER,
f,3);c=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,e,1));this.geometry.getPrimitives().push(c);this.geometry.getAttributes().Elevation=new osg.BufferArray(gl.ARRAY_BUFFER,k,3);k=this.getOrCreateStateSet();this.geometry.getOrCreateStateSet();c=new osg.BufferArray(gl.ARRAY_BUFFER,g,2);g=0;for(e=this.map.imageLayers.length;g<e;g++)f=this.textures[g],a===null||this.map.waitForAllLayers?k.setTextureAttributeAndMode(g,f):(f=osg.Uniform.createMatrix4([0.5,0,0,0,0,0.5,0,
0,0,0,0,0,this.key[0]%2*0.5,(1-this.key[1]%2)*0.5,0,0],"TexMat"+g),k.addUniform(f,osg.StateAttribute.ON)),this.geometry.getAttributes()["TexCoord"+g]=c;this.xform=new osg.MatrixTransform;this.xform.setMatrix(o);this.xform.addChild(this.geometry);this.subtileRange2=this.getBound().radius()*3*this.map.zoomScale;this.subtileRange2*=this.subtileRange2;if(this.map.geocentric&&this.key[2]>0)for(g=0;g<4;g++)if(a=[],osg.Vec3.sub(h[g],this.centerWorld,a),osg.Vec3.normalize(a,a),a=osg.Vec3.dot(this.centerNormal,
a),a<this.deviation)this.deviation=a;this.deviation-=0.2;this.isBuilt=!0},requestSubtiles:function(){for(var a=0;a<4;a++)this.addChild(new osgearth.Tile(osgearth.TileKey.child(this.key,a),this.map,this.textures));this.subtilesRequested=!0},checkBuild:function(){if(!this.isBuilt){var a=!0;this.heightField!=null&&!this.heightField.complete&&(a=!1);a&&this.build(this.parentTextures)}return this.isBuilt},traverse:function(a){this.buildChildren();if(a.modelviewMatrixStack!==void 0){var c=[0,0,0];osg.Vec3.sub(a.eyePoint,
this.centerWorld,c);osg.Vec3.normalize(c,c);if(this.key[2]==0||!this.map.geocentric||osg.Vec3.dot(c,this.centerNormal)>=this.deviation){this.map.markTileDrawn(this);var e=this.getBound(),c=!0,f=this.children.length;if(osg.Vec3.length2(osg.Vec3.sub(a.eyePoint,e.center(),[]))>this.subtileRange2||this.key[2]>=this.map.maxLevel)c=!1;else if(!this.subtilesRequested&&(this.key[2]==this.map.minLevel||this.allTexturesReady()))this.requestSubtiles(),c=!1;else if(this.children.length<4)c=!1;else if(this.allChildrenBuilt())if(this.map.waitForAllLayers)for(e=
0;e<this.children.length;e++){var g=this.children[e];g.allTexturesReady()||(c=!1,g.checkTextures())}else for(e=0;e<this.children.length;e++)g=this.children[e],g.textureReady[0]||(c=!1),g.allTexturesReady()||g.checkTextures();else c=!1;if(c)for(e=0;e<f;e++)this.children[e].accept(a);else this.xform.accept(a)}}}});osgearth.Tile.prototype.objectType=osg.objectType.generate("Tile");
osg.CullVisitor.prototype[osgearth.Tile.prototype.objectType]=function(a){a.stateset&&this.pushStateSet(a.stateset);this.traverse(a);a.stateset&&this.popStateSet()};
(function(a){function c(c){var e=c||window.event,h=[].slice.call(arguments,1),k=0,i=0,m=0,c=a.event.fix(e);c.type="mousewheel";c.wheelDelta&&(k=c.wheelDelta/120);c.detail&&(k=-c.detail/3);m=k;e.axis!==void 0&&e.axis===e.HORIZONTAL_AXIS&&(m=0,i=-1*k);e.wheelDeltaY!==void 0&&(m=e.wheelDeltaY/120);e.wheelDeltaX!==void 0&&(i=-1*e.wheelDeltaX/120);h.unshift(c,k,i,m);return a.event.handle.apply(this,h)}var e=["DOMMouseScroll","mousewheel"];a.event.special.mousewheel={setup:function(){if(this.addEventListener)for(var a=
e.length;a;)this.addEventListener(e[--a],c,!1);else this.onmousewheel=c},teardown:function(){if(this.removeEventListener)for(var a=e.length;a;)this.removeEventListener(e[--a],c,!1);else this.onmousewheel=null}};a.fn.extend({mousewheel:function(a){return a?this.bind("mousewheel",a):this.trigger("mousewheel")},unmousewheel:function(a){return this.unbind("mousewheel",a)}})})(jQuery);Math.deg2rad=function(a){return a*0.0174532925};Math.rad2deg=function(a){return a*57.2957795};
Math.clamp=function(a,c,e){return a<c?c:a>e?e:a};Math.log10=function(a){return Math.log(a)/Math.LN10};Math.powFast=function(a,c){return a/(a+c-c*a)};Math.smoothStepInterp=function(a){return a*a*(3-2*a)};Math.smootherStepInterp=function(a){return a*a*a*(a*(a*6-15)+10)};Math.accelerationInterp=function(a,c){return c==0?a:c>0?Math.powFast(a,c):1-Math.powFast(1-a,-c)};
if(!Array.prototype.indexOf)Array.prototype.indexOf=function(a,c){var e=this.length,f=Number(c)||0,f=f<0?Math.ceil(f):Math.floor(f);for(f<0&&(f+=e);f<e;f++)if(f in this&&this[f]===a)return f;return-1};if(jQuery.browser.mozilla||jQuery.browser.opera)document.removeEventListener("DOMContentLoaded",jQuery.ready,!1),document.addEventListener("DOMContentLoaded",function(){jQuery.ready()},!1);jQuery.event.remove(window,"load",jQuery.ready);jQuery.event.add(window,"load",function(){jQuery.ready()});
jQuery.extend({includeList:[],includeLoaded:{},includePtr:0,includeInOrder:function(a){this.includeList=a;this.includePtr=0;this.loadInclude(this.includePtr)},loadNext:function(){this.includePtr++;this.includePtr<this.includeList.length&&this.loadInclude(this.includePtr)},loadInclude:function(a){if(!(this.includePtr>=this.includeList.length)){var c=this,a=this.includeList[a].replace("\n",""),e=document.createElement("script");e.type="text/javascript";e.src=a;this.includeLoaded[e]=!1;e.onload=function(){c.includeLoaded[this]===
!1&&(c.includeLoaded[this]=!0,c.loadNext())};e.onreadystatechange=function(){!(this.readyState!="complete"&&this.readyState!="loaded")&&c.includedLoaded[this]===!1&&(c.includeLoaded[this]=!0,c.loadNext())};document.getElementsByTagName("head")[0].appendChild(e)}},readyOld:jQuery.ready,ready:function(){jQuery.isReady||(jQuery.includePtr>=jQuery.includeList.length?jQuery.readyOld.apply(jQuery,arguments):setTimeout(arguments.callee,10))}});
var ReadyMap={version:"0.0.1",init:function(a){window.addEventListener("load",a,!0)},getWindowSize:function(){var a=0,c=0;if(typeof window.innerWidth=="number")a=window.innerWidth,c=window.innerHeight;else if(document.documentElement&&(document.documentElement.clientWidth||document.documentElement.clientHeight))a=document.documentElement.clientWidth,c=document.documentElement.clientHeight;else if(document.body&&(document.body.clientWidth||document.body.clientHeight))a=document.body.clientWidth,c=
document.body.clientHeight;return{w:a,h:c}},Manipulator:function(a){this.map=a;this.center=[0,0,0];this.minDistance=0.0010;this.maxDistance=1E10;this.buttonup=!0;this.rotation=osg.Quat.makeIdentity();this.localAzim=0;this.localPitch=Math.deg2rad(-90);this.settingVP=!1;this.continuousPanY=this.continuousPanX=this.continuousZoom=0;this.touchSensitivity=0.1;this.touchStartDistance=0;this.touchStartVec=[0,0]}};
ReadyMap.Manipulator.prototype={init:function(){},reset:function(){this.init()},setNode:function(a){this.node=a},mouseup:function(a){this.panning=this.dragging=!1;this.releaseButton(a)},mousedown:function(a){this.dragging=this.panning=!0;var c=this.convertEventToCanvas(a);this.clientX=c[0];this.clientY=c[1];this.pushButton(a)},touchStart:function(a){if(a.touches)if(a.touches.length==1)this.mousedown(a);else if(a.touches.length==2)a=osg.Vec2.sub([a.touches[1].clientX,a.touches[1].clientY],[a.touches[0].clientX,
a.touches[0].clientY],[]),this.touchStartDistance=osg.Vec2.length(a),this.touchStartVec=osg.Vec2.normalize(a,[])},touchEnd:function(a){this.mouseup(a)},touchMove:function(){},pushButton:function(){this.dx=this.dy=0;this.buttonup=!1},releaseButton:function(){this.buttonup=!0},setDistance:function(a){this.distance=a;if(this.distance<this.minDistance)this.distance=this.minDistance;else if(this.distance>this.maxDistance)this.distance=this.maxDistance},getViewpoint:function(){var a={};a.center=osg.Vec3.copy(this.center,
[]);a.heading=Math.rad2deg(this.localAzim);a.pitch=Math.rad2deg(this.localPitch);a.range=this.distance;return a},startViewpointTransition:function(a,c,e,f,g,h,k){e=this.map.lla2world([Math.deg2rad(c),Math.deg2rad(a),e]);this.startVP=this.getViewpoint();this.deltaHeading=f-this.startVP.heading;this.deltaPitch=g-this.startVP.pitch;this.deltaRange=h-this.startVP.range;for(this.deltaCenter=osg.Vec3.sub(e,this.startVP.center,[]);this.deltaHeading>180;)this.deltaHeading-=360;for(;this.deltaHeading<-180;)this.deltaHeading+=
360;f=this.startVP.range*Math.sin(Math.deg2rad(-this.startVP.pitch));g=h*Math.sin(Math.deg2rad(-g));h=g-f;this.map.geocentric?(e=[this.startVP.center[0],this.startVP.center[1],0],a=this.map.lla2world([Math.deg2rad(c),Math.deg2rad(a),0]),a=osg.Vec3.length(osg.Vec3.sub(e,a,[]))):a=osg.Vec3.length(this.deltaCenter);this.arcHeight=Math.max(a-Math.abs(h),0);if(this.arcHeight>0)c=2*(f+g)+this.arcHeight,this.setVPaccel=Math.log10(Math.abs(c-f)/1E5),this.setVPaccel2=-Math.log10(Math.abs(c-g)/1E5);else if(c=
(g-f)/1E5,this.setVPaccel=Math.abs(c)<=1?0:c>0?Math.log10(c):-Math.log10(-c),Math.abs(this.setVPaccel)<1)this.setVPaccel=0;this.setVPstartTime_ms=(new Date).getTime();this.map.geocentric?(a=Math.clamp(a/this.map.profile.ellipsoid.radiusEquator,0,1),a=Math.accelerationInterp(a,-4.5),this.setVPduration_ms=(2+a*(Math.max(k,2)-2))*1E3):this.setVPduration_ms=k*1E3;this.settingVP=!0},updateSetViewpoint:function(){var a=((new Date).getTime()-this.setVPstartTime_ms)/this.setVPduration_ms,c=a;a>=1?(c=1,this.settingVP=
!1):this.arcHeight>0?(c<=0.5?(c=Math.accelerationInterp(2*c,this.setVPaccel),c*=0.5):(c=Math.accelerationInterp(2*(c-0.5),this.setVPaccel2),c=0.5+0.5*c),c=Math.smoothStepInterp(c)):a>0&&(c=Math.accelerationInterp(c,this.setVPaccel),c=Math.smoothStepInterp(c));a=this.map.world2lla(osg.Vec3.add(this.startVP.center,osg.Vec3.mult(this.deltaCenter,c,[]),[]));this.setViewpoint(Math.rad2deg(a[1]),Math.rad2deg(a[0]),a[2],this.startVP.heading+this.deltaHeading*c,this.startVP.pitch+this.deltaPitch*c,this.startVP.range+
this.deltaRange*c+Math.sin(Math.PI*c)*this.arcHeight)}};ReadyMap.EarthManipulator=function(a){ReadyMap.Manipulator.call(this,a);this.minPitch=Math.deg2rad(-89.9);this.maxPitch=Math.deg2rad(-10);this.buttonup=!0;this.centerRotation=osg.Quat.makeIdentity();this.lockAzimWhilePanning=!0;this.settingVP=!1;this.computeHomePosition()};
ReadyMap.EarthManipulator.prototype=osg.objectInehrit(ReadyMap.Manipulator.prototype,{computeHomePosition:function(){this.setViewpoint(0,-90,0,0,-90,1E7)},keydown:function(a){if(a.keyCode===32)this.computeHomePosition();else if(a.keyCode===33)return this.distanceIncrease(),!1;else if(a.keyCode===34)return this.distanceDecrease(),!1;else if(a.keyCode===13)return this.mode=1-this.mode,!1},mousemove:function(a){if(this.buttonup!==!0){var c,e,f,g;e=this.convertEventToCanvas(a);c=e[0];e=e[1];f=(this.clientX-
c)/100;g=(this.clientY-e)/100;this.clientX=c;this.clientY=e;a.shiftKey?this.rotateModel(-f,-g):a.ctrlKey?this.zoomModel(0,-g):this.panModel(-f,-g);return!1}},mousewheel:function(a,c){this.zoomModel(0,c*-0.1)},dblclick:function(){},touchMove:function(a){a.preventDefault();if(a.touches.length==1)this.mousemove(a);else if(a.touches.length==2){var c=osg.Vec2.sub([a.touches[1].clientX,a.touches[1].clientY],[a.touches[0].clientX,a.touches[0].clientY],[]),a=osg.Vec2.length(c),c=osg.Vec2.normalize(c,[]),
e=a-this.touchStartDistance;if(Math.abs(e)>this.touchSensitivity)this.zoomModel(0,e*-0.0060),this.rotateModel(0,Math.atan2(c[1],c[0])-Math.atan2(this.touchStartVec[1],this.touchStartVec[0])),this.touchStartDistance=a,this.touchStartVec=c}},getCoordFrame:function(a){var a=this.map.profile.ellipsoid.local2worldFromECEF(a),c=osg.Matrix.getTrans(a),e=osg.Matrix.transform3x3(a,[1,0,0]),f=osg.Matrix.transform3x3(a,[0,1,0]),g=osg.Matrix.transform3x3(a,[0,0,1]),e=osg.Matrix.makeScale(1/osg.Vec3.length(e),
1/osg.Vec3.length(f),1/osg.Vec3.length(g));osg.Matrix.postMult(e,a);osg.Matrix.setTrans(a,c[0],c[1],c[2]);return a},normalizeAzimRad:function(a){for(Math.abs(a)>2*Math.PI&&(a%=2*Math.PI);a<-Math.PI;)a+=2*Math.PI;for(;a>Math.PI;)a-=2*Math.PI;return a},getSideVector:function(a){return[osg.Matrix.get(a,0,0),osg.Matrix.get(a,0,1),osg.Matrix.get(a,0,2)]},getFrontVector:function(a){return[osg.Matrix.get(a,1,0),osg.Matrix.get(a,1,1),osg.Matrix.get(a,1,2)]},getUpVector:function(a){return[osg.Matrix.get(a,
2,0),osg.Matrix.get(a,2,1),osg.Matrix.get(a,2,2)]},getAzimuth:function(){return this.localAzim},recalcLocalPitchAndAzim:function(){var a=osg.Matrix.makeRotateFromQuat(this.rotation);this.localPitch=Math.asin(osg.Matrix.get(a,1,2));this.localAzim=Math.abs(this.localPitch-Math.PI/2)<1.0E-6?Math.atan2(osg.Matrix.get(a,0,1),osg.Matrix.get(a,0,0)):Math.atan2(osg.Matrix.get(a,1,0),osg.Matrix.get(a,1,1));this.localPitch-=Math.PI/2},recalculateCenter:function(a){a=this.map.profile.ellipsoid.ecef2lla(osg.Matrix.getTrans(a));
a[2]=0;this.center=this.map.profile.ellipsoid.lla2ecef(a)},panModel:function(a,c){var e=-0.3*this.distance,f=this.getCoordFrame(this.center);this.getAzimuth(f);var g=this.getSideVector(osg.Matrix.makeRotateFromQuat(osg.Quat.multiply(this.rotation,this.centerRotation))),f=this.getUpVector(f),h=osg.Vec3.cross(f,g,[]),g=osg.Vec3.cross(h,f,[]);osg.Vec3.normalize(h,h);osg.Vec3.normalize(g,g);e=osg.Vec3.add(osg.Vec3.mult(h,c*e,[]),osg.Vec3.mult(g,a*e,[]),[]);this.center=osg.Vec3.add(this.center,e,[]);e=
this.getCoordFrame(this.center);this.lockAzimWhilePanning?this.centerRotation=osg.Matrix.getRotate(e):(g=this.getUpVector(e),f=osg.Quat.rotateVecOnToVec(f,g),osg.Quat.zeroRotation(f)||osg.Quat.multiply(this.centerRotation,f,this.centerRotation));this.recalculateCenter(e);this.recalcLocalPitchAndAzim()},rotateModel:function(a,c){if(c+this.localPitch>this.maxPitch||c+this.localPitch<this.minPitch)c=0;var e=this.getSideVector(osg.Matrix.makeRotateFromQuat(this.rotation)),f=osg.Vec3.cross([0,0,1],e,[]),
e=osg.Vec3.cross(f,[0,0,1],[]);osg.Vec3.normalize(f,f);osg.Vec3.normalize(e,e);this.pv=e;e=osg.Quat.makeRotate(c,e[0],e[1],e[2]);f=osg.Quat.makeRotate(-a,0,0,1);this.rotation=osg.Quat.multiply(this.rotation,osg.Quat.multiply(e,f));this.recalcLocalPitchAndAzim()},zoomModel:function(a,c){var e=1+c;1E3*e>this.minDistance?this.setDistance(this.distance*e):this.setDistance(this.minDistance)},getRotation:function(a){var c=this.getCoordFrame(a),c=osg.Vec3.neg(this.getUpVector(c),[]),e=[0,0,1],f=Math.abs(osg.Vec3.dot(e,
c));Math.abs(f-1)<1.0E-6&&(e=[0,1,0]);e=osg.Vec3.cross(c,e,[]);e=osg.Vec3.normalize(osg.Vec3.cross(e,c,[]),[]);return osg.Matrix.makeLookAt(osg.Vec3.sub(a,osg.Vec3.mult(c,1.0E-6,[]),[]),a,e)},setViewpoint:function(a,c,e,f,g,h,k){var i=[Math.deg2rad(c),Math.deg2rad(a),e];k===void 0?(this.center=this.map.lla2world(i),a=Math.clamp(Math.deg2rad(g),this.minPitch,this.maxPitch),f=this.normalizeAzimRad(Math.deg2rad(f)),this.setDistance(h),h=this.getCoordFrame(this.center),this.centerRotation=osg.Matrix.getRotate(h),
c=osg.Quat.makeRotate(f,0,0,1),e=osg.Quat.makeRotate(-a-Math.PI/2,1,0,0),c=osg.Matrix.makeRotateFromQuat(osg.Quat.multiply(c,e)),this.rotation=osg.Matrix.getRotate(osg.Matrix.inverse(c)),this.localPitch=a,this.localAzim=f,this.recalcLocalPitchAndAzim(),this.recalculateCenter(h)):(this.startViewpointTransition(a,c,e,f,g,h,k),this.recalculateCenter(this.getCoordFrame(this.center)))},frame:function(){this.settingVP&&this.updateSetViewpoint();this.continuousZoom!=0&&this.zoomModel(0,this.continuousZoom);
(this.continuousPanX!=0||this.continuousPanY!=0)&&this.panModel(this.continuousPanX,this.continuousPanY)},getMatrix:function(){var a=osg.Matrix.makeTranslate(0,0,this.distance);osg.Matrix.postMult(osg.Matrix.makeRotateFromQuat(this.rotation),a);osg.Matrix.postMult(osg.Matrix.makeRotateFromQuat(this.centerRotation),a);osg.Matrix.postMult(osg.Matrix.makeTranslate(this.center[0],this.center[1],this.center[2]),a);return a},getInverseMatrix:function(){this.frame();var a=osg.Matrix.makeTranslate(-this.center[0],
-this.center[1],-this.center[2]);osg.Matrix.postMult(osg.Matrix.makeRotateFromQuat(osg.Quat.inverse(this.centerRotation)),a);osg.Matrix.postMult(osg.Matrix.makeRotateFromQuat(osg.Quat.inverse(this.rotation)),a);osg.Matrix.postMult(osg.Matrix.makeTranslate(0,0,-this.distance),a);return a}});ReadyMap.MapManipulator=function(a){ReadyMap.Manipulator.call(this,a);this.computeHomePosition()};
ReadyMap.MapManipulator.prototype=osg.objectInehrit(ReadyMap.Manipulator.prototype,{computeHomePosition:function(){this.center=[0,0,0];this.distance=osgearth.Extent.width(this.map.profile.extent)/2;this.maxDistance=this.distance*1.5},setViewpoint:function(a,c,e,f,g,h,k){k===void 0||k==0?(this.center=this.map.lla2world([Math.deg2rad(c),Math.deg2rad(a),e]),this.setDistance(h)):this.startViewpointTransition(a,c,e,f,g,h,k)},panModel:function(a,c){var e=-0.3*this.distance;this.center=osg.Vec3.add(this.center,
[a*e,c*e,0],[]);osgearth.Extent.clamp(this.map.profile.extent,this.center)},zoomModel:function(a,c){var e=1+c;1E3*e>this.minDistance?this.setDistance(this.distance*e):this.setDistance(this.minDistance)},frame:function(){this.settingVP&&this.updateSetViewpoint();this.continuousZoom!=0&&this.zoomModel(0,this.continuousZoom);(this.continuousPanX!=0||this.continuousPanY!=0)&&this.panModel(this.continuousPanX,this.continuousPanY)},getInverseMatrix:function(){this.frame();var a=[];osg.Vec3.copy(this.center,
a);a[2]=this.distance;return osg.Matrix.makeLookAt(a,this.center,[0,1,0])},mousemove:function(a){if(this.buttonup!==!0){var c=this.convertEventToCanvas(a),a=c[0],c=c[1],e=(this.clientX-a)/100,f=(this.clientY-c)/100;this.clientX=a;this.clientY=c;this.panModel(-e,-f);return!1}},mousewheel:function(a,c){this.zoomModel(0,c*-0.1)}});
ReadyMap.MapView=function(a,c,e,f){this.map=e;this.viewer=null;this.endFrame=void 0;this.frameNum=0;this.frameTimes=[0,0,0,0,0,0,0,0,0,0];this.frameRate=0;this.lastTime=(new Date).getTime();a=document.getElementById(a);a.width=c.w;a.height=c.h;this.root=new osg.Node;this.viewer=new osgViewer.Viewer(a,{alpha:!1});this.viewer.eventNode=this.viewer.canvas;this.viewer.init();e.geocentric?this.viewer.setupManipulator(new ReadyMap.EarthManipulator(e)):this.viewer.setupManipulator(new ReadyMap.MapManipulator(e));
this.viewer.view.nearFarRatio=1.0E-5;this.mapNode=new osgearth.MapNode(e);f!==void 0&&f.verticalScale!==void 0&&this.setVerticalScale(f.verticalScale);this.root.addChild(this.mapNode);this.root.getOrCreateStateSet().setAttributeAndMode(new osg.BlendFunc("SRC_ALPHA","ONE_MINUS_SRC_ALPHA"));this.viewer.setScene(this.root);delete this.viewer.view.light;this.viewer.getManipulator().computeHomePosition();this.run();this.frameEnd=[]};
ReadyMap.MapView.prototype={home:function(){this.viewer.getManipulator().computeHomePosition()},zoom:function(a){this.viewer.getManipulator().zoomModel(0,a)},setVerticalScale:function(a){this.mapNode.setVerticalScale(a)},projectObjectIntoWindow:function(a){var c=this.viewer.view.getViewMatrix(),e=this.viewer.view.getProjectionMatrix(),f=null,g=this.viewer.view.getViewport();g!==void 0&&(f=g.computeWindowMatrix());g=[];osg.Matrix.copy(f,g);osg.Matrix.preMult(g,e);osg.Matrix.preMult(g,c);a=osg.Matrix.transformVec3(g,
a);a[1]=this.viewer.canvas.height-a[1]-1;return a},run:function(){var a=this,c=function(){window.requestAnimationFrame(c,this.canvas);(new Date).getTime();a.viewer.frame();if(a.frameEnd!==void 0&&a.frameEnd!=null)for(var e=0;e<a.frameEnd.length;e++)a.frameEnd[e]();e=(new Date).getTime()*0.0010;a.frameTimes[a.frameNum%10]=e-a.lastTime;for(var f=0.0010,g=0;g<10;g++)f+=a.frameTimes[g];a.frameRate=10/f;a.lastTime=e;a.frameNum++;a.map.frame()};c()},addFrameEndCallback:function(a){this.frameEnd.push(a)}};
ReadyMap.PositionedElement=function(a,c,e,f,g){this.hAlign="left";this.vAlign="top";this.lat=e;this.lon=c;this.alt=f;this.offset=[0,0];this.ecf=null;this._dirty=!0;g=jQuery.extend({},{hAlign:"left",vAlign:"top",offset:[0,0]},g);this.vAlign=g.vAlign;this.hAlign=g.hAlign;if(g.element!==void 0)this.element=g.element;this.id=a;this.ownsElement=this.element!==void 0;if(this.element===void 0&&(this.element=jQuery("#"+a)))this.ownsElement=!1};
ReadyMap.PositionedElement.prototype={destroy:function(){this.ownsElement&&this.element.remove()},setLocation:function(a,c,e){if(this.lon!=a||this.lat!=c||this.alt!=e)this.lon=a,this.lat=c,this.alt=e,_dirty=!0},sizeChanged:function(){return this.element._lastSize!==void 0?this.element._lastSize[0]!=this.element.width()||this.element._lastSize[1]!=this.element.height():!0},hide:function(){this.element.hide()},show:function(){this.element.show()},toggle:function(a){this.element.toggle(a)},update:function(a){if(this.ecf==
null||this._dirty){var c=a.map.lla2world([this.lon,this.lat,this.alt]);this._dirty=!1;this.ecf=c}if(a.map.geocentric){viewMatrix=a._inverseViewMatrix;var e=[];osg.Matrix.getTrans(viewMatrix,e);c=[];osg.Vec3.sub(this.ecf,e,c);e=[];osg.Vec3.copy(this.ecf,e);osg.Vec3.normalize(e,e);if(osg.Vec3.dot(c,e)>0){this.element.offset({top:0,left:-1E4});return}}e=a.projectObjectIntoWindow(this.ecf);c=(e[0]+this.offset[0]).toFixed();e=(e[1]+this.offset[1]).toFixed();if(this.lastWindow!==void 0){var f=this.lastWindow[1]-
e;if(this.lastWindow[0]-c==0&&f==0)return}f=this.element.width();this.hAlign=="right"&&(c-=f);var g=this.element.height();this.vAlign=="bottom"&&(e-=g);this.element._lastSize=[f,g];this.element.position({my:"left top",at:"left top",of:a.viewer.canvas,offset:c+" "+e,collision:"none none"});this.lastWindow=[c,e]}};ReadyMap.PositionEngine=function(a){this.mapView=a;var c=this;this.mapView.addFrameEndCallback(function(){c.frameEnd()});this.elements=[]};
ReadyMap.PositionEngine.prototype={addElement:function(a){this.elements.push(a)},removeElement:function(a){var c=this.elements.indexOf(a);c>=0&&(a.destroy(),this.elements.splice(c,1))},clear:function(){for(var a=0;a<this.elements.length;a++)this.elements[a].destroy();this.elements=[]},hide:function(){for(var a=0;a<this.elements.length;a++)this.elements[a].hide()},show:function(){for(var a=0;a<this.elements.length;a++)this.elements[a].show()},frameEnd:function(){var a=this.mapView.viewer.view.getViewMatrix(),
c=!0;this._lastViewMatrix!==void 0?c=!osg.Matrix.equals(a,this._lastViewMatrix):this._lastViewMatrix=[];osg.Matrix.copy(a,this._lastViewMatrix);this.mapView._inverseViewMatrix=osg.Matrix.inverse(a);for(a=0;a<this.elements.length;a++)(c||this.elements[a]._dirty||this.elements[a].sizeChanged())&&this.elements[a].update(this.mapView)}};ReadyMap.ArcGISImageLayer=function(a){osgearth.ImageLayer.call(this,a.name);this.url=a.url;this.extension=a.imageType!==void 0?a.imageType:"jpg"};
ReadyMap.ArcGISImageLayer.prototype=osg.objectInehrit(osgearth.ImageLayer.prototype,{getURL:function(a){a=this.url+"/tile/"+a[2]+"/"+a[1]+"/"+a[0]+"."+this.extension;this.args!==void 0&&this.args!=null&&(a+="?"+this.args);return osgearth.getURL(a)},createTexture:function(a,c){var e=this.getURL(a,c);return osg.Texture.createFromURL(e)}});
ReadyMap.GeoRSSLayer=function(a,c,e,f){this.mapView=a;this.url=c;this.options=jQuery.extend({},{url:"http://google-maps-icons.googlecode.com/files/redblank.png",width:32,height:32,cssClass:""},f);this.positionEngine=new ReadyMap.PositionEngine(a);var g=this;this.reader=new ReadyMap.GeoRSSReader(c,e,function(a){g.createIcons(a)})};function showDialog(a,c){return $("<div/>").html(a).dialog({bgiframe:!0,resizable:!1,modal:!1,draggable:!1,title:c,overlay:{backgroundColor:"#000",opacity:0.5}})}
ReadyMap.GeoRSSLayer.prototype={setRate:function(a){this.reader.setRate(a)},createIcons:function(a){this.positionEngine.clear();for(var c in a){var e=new ReadyMap.Icon("icon"+c+"_"+a[c].guid,Math.deg2rad(a[c].longitude),Math.deg2rad(a[c].latitude),0,this.options.url,{width:this.options.width,height:this.options.height,cssClass:this.options.cssClass,title:a[c].title});e.offset=[this.options.width/-2,this.options.height*-1];e.element.bind("click",{url:a[c].link,title:a[c].title,engine:this.positionEngine,
lat:a[c].latitude,lon:a[c].longitude,description:a[c].description},function(a){var c="<div><h3>"+a.data.title+"</h3>   <p> "+a.data.description+"</p>";a.data.url!==void 0&&a.data.url!=null&&(c+='<a href="'+a.data.url+'" target="_blank">Link</a>');c+="</div>";c=showDialog(c,a.data.title);c=c.parent();a.data.engine.addElement(new ReadyMap.PositionedElement("dlg",Math.deg2rad(a.data.lon),Math.deg2rad(a.data.lat),0,{element:c,vAlign:"bottom"}))});this.positionEngine.addElement(e)}}};
ReadyMap.GeoRSSReader=function(a,c,e){this.url=a;this.callbacks=[];e!=void 0&&this.callbacks.push(e);this.updateFeed();this.setRate(c)};
ReadyMap.GeoRSSReader.prototype={updateFeed:function(){this.items=[];if(this.url!=void 0){var a=this.items,c=this.callbacks;$.ajax({url:this.url,type:"GET",dataType:"xml",success:function(e){var f=$(e).find("item").length>0?"item":"entry";$(e).find(f).each(function(){var c=void 0,e=void 0,e=$(this).find("georss\\:point").text();e==""&&(e=$(this).find("point").text());if(e!="")c=e.split(" ")[0],e=e.split(" ")[1];else if(c=$(this).find("geo\\:lat").text(),e=$(this).find("geo\\:long").text(),c==""||
e=="")c=$(this).find("lat").text(),e=$(this).find("long").text();var f=void 0;try{f=$(this).find("description").get(0).innerHTML}catch(g){}if(f==void 0||f=="")f=$(this).find("description").text();a.push({guid:$(this).find("guid").text(),title:$(this).find("title").text(),author:$(this).find("author").text(),pubDate:$(this).find("pubDate").text(),description:f,link:$(this).find("link").text(),latitude:c,longitude:e,src:$(this).get()})});for(var g in c)(0,c[g])(a)},error:function(){for(var e in c)(0,c[e])(a)}})}},
setRate:function(a){this.interval!=void 0&&window.clearInterval(this.interval);this.rate=a;if(this.rate>0)this.interval=window.setInterval(function(a){a.updateFeed()},this.rate*1E3,this)},addCallback:function(a){a!=void 0&&(this.callbacks.push(a),a(this.items))}};
ReadyMap.HeatMapNode=function(a,c){osg.Node.call(this);this.map=a;this.originLLA={lat:Math.deg2rad(c.origin.lat),lon:Math.deg2rad(c.origin.lon)};this.spacingLL={lat:Math.deg2rad(c.spacing.lat),lon:Math.deg2rad(c.spacing.lon)};this.extentLLA={xmin:Math.deg2rad(c.origin.lon),xmax:Math.deg2rad(c.origin.lon+c.spacing.lon*c.numCols),ymin:Math.deg2rad(c.origin.lat),ymax:Math.deg2rad(c.origin.lat+c.spacing.lat*c.numRows)};this.minHeight=5;this.maxHeight=2500;this.dataArray=[];for(var e=0;e<c.data.length;++e)this.dataArray.push(parseFloat(c.data[e].value));
this.heightField=new osgearth.HeightField(c.numCols,c.numRows,this.dataArray);for(e=0;e<2;e++)for(var f=1;f<c.numCols-2;f++)for(var g=1;g<c.numRows-2;g++){var h=this.heightField.getHeight(f-1,g-1)+this.heightField.getHeight(f,g-1)+this.heightField.getHeight(f+1,g-1)+this.heightField.getHeight(f-1,g)+this.heightField.getHeight(f,g)+this.heightField.getHeight(f+1,g)+this.heightField.getHeight(f-1,g+1)+this.heightField.getHeight(f,g+1)+this.heightField.getHeight(f+1,g+1);this.heightField.setHeight(f,
g,h/8)}this.build()};
ReadyMap.HeatMapNode.prototype=osg.objectInehrit(osg.Node.prototype,{insertArray:function(a,c,e){for(var f=0;f<a.length;f++)c[e+f]=a[f]},rampColor:function(a,c,e){var f=[1,1,1];c===void 0&&(c=0);e===void 0&&(e=1);e-=c;a<c+0.25*e?(f[0]=0,f[1]=4*(a-c)/e):a<c+0.5*e?(f[0]=0,f[2]=1+4*(c+0.25*e-a)/e):(a<c+0.75*e?f[0]=4*(a-c-0.5*e)/e:f[1]=1+4*(c+0.75*e-a)/e,f[2]=0);return f},build:function(){var a=[],c=[],e=[],f=[],g=this.map.lla2world([this.originLLA.lon,this.originLLA.lat,0]),g=this.map.threeD?this.map.profile.ellipsoid.local2worldFromECEF(g):
osg.Matrix.makeTranslate(this.centerWorld[0],this.centerWorld[1],this.centerWorld[2]),h=[];osg.Matrix.inverse(g,h);for(var k=this.heightField.getNumRows(),i=this.heightField.getNumColumns(),m=99999999,n=-m,o=0;o<k;o++)for(var p=0;p<i;p++){var q=this.heightField.getHeight(p,o);q<m&&(m=q);q>n&&(n=q)}for(var t=0,s=0,u=0,y=0,o=0;o<k;o++)for(p=0;p<i;p++){var q=this.heightField.getHeight(p,o),z=(q-m)/(n-m),q=this.minHeight+z*(this.maxHeight-this.minHeight),q=this.map.lla2world([this.extentLLA.xmin+this.spacingLL.lon*
p,this.extentLLA.ymin+this.spacingLL.lat*o,q]),q=osg.Matrix.transformVec3(h,q,[]);this.insertArray(q,a,s);this.insertArray(this.map.geocentric?osg.Vec3.normalize(q,[]):[0,0,1],e,s);s+=3;q=this.rampColor(z);q[3]=z>0.25?0.75:z*3;this.insertArray(q,f,u);u+=4;p<i-1&&o<k-1&&(this.insertArray([y,y+1,y+1+i,y+1+i,y+i,y],c,t),t+=6);y++}this.geometry=new osg.Geometry;this.geometry.getAttributes().Vertex=new osg.BufferArray(gl.ARRAY_BUFFER,a,3);this.geometry.getAttributes().Normal=new osg.BufferArray(gl.ARRAY_BUFFER,
e,3);this.geometry.getAttributes().Color=new osg.BufferArray(gl.ARRAY_BUFFER,f,4);a=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,c,1));this.geometry.getPrimitives().push(a);a=new osg.MatrixTransform;a.setMatrix(g);a.addChild(this.geometry);this.addChild(a);this.getOrCreateStateSet().setAttributeAndMode(new osg.CullFace("DISABLE"))},traverse:function(a){for(var c=this.children.length,e=0;e<c;e++)this.children[e].accept(a)}});
ReadyMap.HeatMapNode.prototype.objectType=osg.objectType.generate("HeatMapNode");osg.CullVisitor.prototype[ReadyMap.HeatMapNode.prototype.objectType]=function(a){a.stateset&&this.pushStateSet(a.stateset);this.traverse(a);a.stateset&&this.popStateSet()};ReadyMap.LeafletImageLayer=function(a){osgearth.ImageLayer.call(this,a.name);this.args=a.args!==void 0?a.args:null;this.sourceLayer=a.sourceLayer!==void 0?a.sourceLayer:null};
ReadyMap.LeafletImageLayer.prototype=osg.objectInehrit(osgearth.ImageLayer.prototype,{getURL:function(a,c){var e=a[1];this.sourceLayer.options.scheme==="tms"&&(e=c.getTileCount(a[2])[1]-1-a[1]);return this.sourceLayer.getTileUrl({x:a[0],y:e},a[2])},createTexture:function(a,c){var e=this.getURL(a,c),e=osgearth.getURL(e);this.sourceLayer.format!==void 0&&(e+="&mimeType="+this.sourceLayer.format);return osg.Texture.createFromURL(e)}});ReadyMap.Map=function(a){osgearth.Map.call(this,a)};
ReadyMap.Map.prototype=osg.objectInehrit(osgearth.Map.prototype,{});ReadyMap.OLImageLayer=function(a){osgearth.ImageLayer.call(this,a.name);this.args=a.args!==void 0?a.args:null;this.sourceLayer=a.sourceLayer!==void 0?a.sourceLayer:null;var c=this;if(this.sourceLayer!==null)this.sourceLayer.setOpacity=function(a){if(a!=this.opacity)this.opacity=a,c.setOpacity(a)},this.sourceLayer.setVisibility=function(a){if(this.visibility!=a)this.visibility=a,c.setVisible(this.visibility)}};
ReadyMap.OLImageLayer.prototype=osg.objectInehrit(osgearth.ImageLayer.prototype,{getURL:function(a,c){var e=osgearth.TileKey.getExtent(a,c),f=new OpenLayers.Bounds;f.left=Math.rad2deg(e.xmin);f.right=Math.rad2deg(e.xmax);f.bottom=Math.rad2deg(e.ymin);f.top=Math.rad2deg(e.ymax);f.centerLonLat=new OpenLayers.LonLat(0.5*(f.left+f.right),0.5*(f.bottom+f.top));return this.sourceLayer.getURL(f)},createTexture:function(a,c){var e=this.getURL(a,c),e=osgearth.getURL(e);this.sourceLayer.format!==void 0&&(e+=
"&mimeType="+this.sourceLayer.format);return osg.Texture.createFromURL(e)}});ReadyMap.TMSImageLayer=function(a){osgearth.ImageLayer.call(this,a.name);this.url=a.url;this.flipY=a.tmsType!=="google";this.extension=a.imageType!==void 0?a.imageType:"jpg";this.baseLevel=a.baseLevel!==void 0?a.baseLevel:0;this.args=a.args!==void 0?a.args:null};
ReadyMap.TMSImageLayer.prototype=osg.objectInehrit(osgearth.ImageLayer.prototype,{getURL:function(a,c){var e=a[1];this.flipY&&(e=c.getTileCount(a[2])[1]-1-a[1]);e=this.url+"/"+(a[2]+this.baseLevel)+"/"+a[0]+"/"+e+"."+this.extension;this.args!==void 0&&this.args!=null&&(e+="?"+this.args);return osgearth.getURL(e)},createTexture:function(a,c){var e=this.getURL(a,c);return osg.Texture.createFromURL(e)}});
ReadyMap.TMSElevationLayer=function(a){osgearth.ElevationLayer.call(this,a.name);this.url=a.url;this.flipY=a.tmsType!=="google";this.extension="json";this.baseLevel=a.baseLevel!==void 0?a.baseLevel:0;this.args=a.args!==void 0?a.args:null};
ReadyMap.TMSElevationLayer.prototype=osg.objectInehrit(osgearth.ElevationLayer.prototype,{getURL:function(a,c){var e=a[1];this.flipY&&(e=c.getTileCount(a[2])[1]-1-a[1]);e=this.url+"/"+(a[2]+this.baseLevel)+"/"+a[0]+"/"+e+"."+this.extension;this.args!==void 0&&this.args!=null&&(e+="?"+this.args);return osgearth.getURL(e)},createHeightField:function(a,c,e){a=this.getURL(a,c);return new osgearth.WebHeightField(a,e)}});
ReadyMap.WMSImageLayer=function(a){osgearth.ImageLayer.call(this,a.name);this.url=a.url;this.version=a.version!==void 0?a.version:"1.1.1";this.format=a.format!==void 0?a.format:"image/jpeg";this.profile=a.profile!==void 0?a.profile:new osgearth.GeodeticProfile;this.args=a.args!==void 0?a.args:null;this.layers=a.layers!==void 0?a.layers:"default";this.width=a.width!==void 0?a.width:256;this.height=a.height!==void 0?a.height:256;this.srs=a.srs!==void 0?a.srs:"EPSG:4326";this.styles=a.styles!==void 0?
a.styles:""};
ReadyMap.WMSImageLayer.prototype=osg.objectInehrit(osgearth.ImageLayer.prototype,{getURL:function(a){var c=this.profile.getTileSize(a[2]),e=this.profile.extent.xmin+c[0]*a[0],a=this.profile.extent.ymax-c[1]*a[1],f=e+c[0],c=a-c[1],e=Math.rad2deg(e),c=Math.rad2deg(c),f=Math.rad2deg(f),a=Math.rad2deg(a),e=[this.url,this.url.indexOf("?")>=0?"&":"?","SERVICE=WMS","&VERSION="+this.version,"&REQUEST=GetMap","&LAYERS="+this.layers,"&FORMAT="+this.format,"&STYLES="+this.styles,"&SRS="+this.srs,"&WIDTH="+this.width,
"&HEIGHT="+this.height,"&BBOX="+e+","+c+","+f+","+a].join("");this.args!==void 0&&this.args!=null&&(e+="&"+this.args);return osgearth.getURL(e)},createTexture:function(a,c){var e=this.getURL(a,c);return osg.Texture.createFromURL(e)}});
ReadyMap.WOEIDWeatherLayer=function(a,c,e,f,g){this.positionEngine=new ReadyMap.PositionEngine(a);this.places=c;this.rate=e;this.proxy=f;this.options=jQuery.extend({},{url:"http://google-maps-icons.googlecode.com/files/cloudsun.png",width:32,height:32,cssClass:"",renderer:void 0},g);this.readers=[];this.icons=[];this.init()};
ReadyMap.WOEIDWeatherLayer.prototype={init:function(){for(var a in this.places){var c=this;ReadyMap.PlaceSearch.doSearch(this.places[a],function(a,f,g,h,k,i,m){a=$(m).find("woeId").eq(0).text();a!=void 0&&a!=""&&c.createReader(a)})}},createReader:function(a){var c=this,e=this.options.renderer;this.readers[a]=new ReadyMap.GeoRSSReader(this.proxy+"http://weather.yahooapis.com/forecastrss?w="+a,this.rate,function(f){e!=void 0?e(f[0],a):c.createIcon(f[0],a)})},createIcon:function(a,c){var e=!1;this.icons[c]!=
void 0&&(this.icons[c].popup!=void 0&&(this.positionEngine.removeElement(this.icons[c].popup),e=!0),this.positionEngine.removeElement(this.icons[c]),this.icons[c]=void 0);var f=new ReadyMap.Icon("icon"+c,Math.deg2rad(a.longitude),Math.deg2rad(a.latitude),0,this.options.url,{width:this.options.width,height:this.options.height,cssClass:this.options.cssClass,title:a.title});f.offset=[this.options.width/-2,this.options.height/-2];e&&this.createIconPopup(f,c,a.latitude,a.longitude,a.title,a.description,
a.link);var g=this;f.element.bind("click",{url:a.link,title:a.title,engine:this.positionEngine,lat:a.latitude,lon:a.longitude,description:a.description,icon:f,id:c},function(a){a.data.icon.popup!=void 0?(a.data.engine.removeElement(a.data.icon.popup),a.data.icon.popup=void 0):g.createIconPopup(a.data.icon,a.data.id,a.data.lat,a.data.lon,a.data.title,a.data.description,a.data.url)});this.icons[c]=f;this.positionEngine.addElement(f)},createIconPopup:function(a,c,e,f,g,h){g=$('<div class="weather_popup_background"><div class="weather_popup"><h4 class="weather_popup">'+
g+"</h4>"+h+"</div></div>");jQuery("body").append(g);g[0].onselectstart=function(){return!1};g[0].onmousedown=function(){return!1};g.bind("click",{icon:a},function(a){$(a.data.icon.element).click()});c=new ReadyMap.PositionedElement("popup_"+c,Math.deg2rad(f),Math.deg2rad(e),0,{element:g,vAlign:"bottom"});a.popup=c;this.positionEngine.addElement(c)}};ReadyMap.Controls={};ReadyMap.Controls.GeoRSSList=function(a,c,e){this.id=a;this.element=$("#"+a);this.mapView=c;this.classid=e;this.items=void 0;this.init()};
ReadyMap.Controls.GeoRSSList.prototype={init:function(){this.element.append("...")},setItems:function(a){this.items=a;this.renderList()},renderList:function(){this.element.empty();var a=this.mapView,c=this.element,e=this.classid;$.each(this.items,function(f,g){var h;e==void 0?(h=$('<div style="padding: 4px;'+(f==0?"":" border-top: 1px dotted #999;")+'">'+g.title+(g.link==void 0||g.link.length<0?"":'...<a href="'+g.link+'" target="_blank">Details</a>')+"</div>"),$(h).hover(function(){$(this).css("color",
"#09f")},function(){$(this).css("color","")})):h=$('<div class="'+e+'">'+g.title+(g.link==void 0||g.link.length<0?"":'...<a href="'+g.link+'">Details</a>')+"</div>");$(h).click(function(){a.viewer.manipulator.setViewpoint(g.latitude,g.longitude,0,0,-90,2E6,1)});c.append(h)})}};
ReadyMap.Icon=function(a,c,e,f,g,h){ReadyMap.PositionedElement.call(this,a,c,e,f);this.url=g;this.ownsElement=!0;h=jQuery.extend({},{width:64,height:64,cssClass:""},h);this.width=h.width;this.height=h.height;this.cssClass=h.cssClass;this.element=jQuery('<img id="'+this.id+'" class="'+h.cssClass+'" src="'+g+'" width="'+this.width+'" height="'+this.height+(h.title!=void 0?'" title="'+h.title:"")+'"/>');this.element[0].onselectstart=function(){return!1};this.element[0].onmousedown=function(){return!1};
jQuery("body").append(this.element)};ReadyMap.Icon.prototype=osg.objectInehrit(ReadyMap.PositionedElement.prototype,{getWidth:function(){return this.width},setWidth:function(a){setSize(a,this.height)},getHeight:function(){return this.height},setHeight:function(a){setSize(this.width,a)},setSize:function(a,c){if(this.height!=c||this.width!=a)this.width=a,this.height=c,this.element.attr("height",this.height),this.element.attr("width",this.width)}});
ReadyMap.Label=function(a,c,e,f,g,h){ReadyMap.PositionedElement.call(this,a,c,e,f);this.text=g;this.ownsElement=!0;h=jQuery.extend({},{cssClass:""},h);this.cssClass=h.cssClass;this.element=jQuery('<span id="'+this.id+'" class="'+h.cssClass+'">'+this.text+"</span>");this.element[0].onselectstart=function(){return!1};this.element[0].onmousedown=function(){return!1};jQuery("body").append(this.element)};ReadyMap.Label.prototype=osg.objectInehrit(ReadyMap.PositionedElement.prototype,{});
ReadyMap.Controls.LayerSwitcher=function(a,c){this.id=a;this.element=jQuery("#"+a);this.map=c;this.init()};
ReadyMap.Controls.LayerSwitcher.prototype={init:function(){jQuery(this.element).children().remove();jQuery(this.element).append('<div class="ui-widget-header"><span id="layer-header-toggle" style="float:left" class="ui-icon ui-icon-triangle-1-s"></span>Layers</div>');var a=jQuery('<div id="layer_container"/>');jQuery(this.element).append(a);jQuery("#layer-header-toggle").bind("click",function(){jQuery("#layer_container").slideToggle();var a=jQuery(this);a.hasClass("ui-icon-triangle-1-s")?(a.removeClass("ui-icon-triangle-1-s"),
a.addClass("ui-icon-triangle-1-e")):a.hasClass("ui-icon-triangle-1-e")&&(a.addClass("ui-icon-triangle-1-s"),a.removeClass("ui-icon-triangle-1-e"))});for(var c=0;c<this.map.imageLayers.length;c++){var e=this.map.imageLayers[c],f=jQuery('<div id="layer_"'+c+">").addClass("ui-widget-content ui-state-default ui-corner-all ui-helper-clearfix");jQuery(f).append('<input id="layercheck_'+c+'" type="checkbox" checked="checked"/><span>'+e.name+"</span>");jQuery(f).append('<div id="layeropacity_'+c+'" class="opacity-slider"></div>');
jQuery(a).append(f);jQuery("#layercheck_"+c).bind("click",{layer:e},function(a){var c=jQuery(this).attr("checked");a.data.layer.setVisible(c)});jQuery("#layeropacity_"+c).slider({min:0,max:100,value:e.getOpacity()*100,range:"min",layer:e,slide:function(a,c){var e=c.value/100;jQuery(this).data("slider").options.layer.setOpacity(e)}})}}};
ReadyMap.PlaceSearch=function(a,c,e){c==void 0&&(c="inputPlaceSearch");document.getElementById(a).innerHTML='Search: <input id="'+c+'" size="20em" type="text" onkeydown="if(event.keyCode==13) ReadyMap.PlaceSearch.doSearch(value, '+e+');" />'};
ReadyMap.PlaceSearch.doSearch=function(a,c){if(a!=void 0&&typeof c=="function"){var e=encodeURI("http://wherein.yahooapis.com/v1/document");$.ajax({url:"http://demo.pelicanmapping.com/rmweb/proxy.php",async:"false",type:"POST",headers:{Connection:"close"},data:{url:e,mimeType:"text/xml",documentContent:encodeURI(a),documentType:"text/plain",appid:"n51Mo.jV34EwZuxIhJ0GqHLzPXoZyjSG6jhLJsQ1v1q975Lf9g7iC4gRYKecVQ--"},success:function(e){var g=e.documentElement;try{var h=g.getElementsByTagName("latitude")[0].firstChild.nodeValue,
k=g.getElementsByTagName("longitude")[0].firstChild.nodeValue,i=g.getElementsByTagName("southWest")[0],m=i.getElementsByTagName("latitude")[0].firstChild.nodeValue,n=i.getElementsByTagName("longitude")[0].firstChild.nodeValue,o=g.getElementsByTagName("northEast")[0],p=o.getElementsByTagName("latitude")[0].firstChild.nodeValue,q=o.getElementsByTagName("longitude")[0].firstChild.nodeValue;c(h,k,m,n,p,q,e)}catch(t){c(0,0,0,0,0,0,"Cannot find location: "+a)}},error:function(a,e){c(0,0,0,0,0,0,e)}})}};
ReadyMap.Controls.Pan=function(a,c){this.mapView=a;this._parent=c;this.init()};
ReadyMap.Controls.Pan.prototype={init:function(){var a=this;this._container=jQuery("<div>").addClass("readymap-control-pan");var c="body";this._parent!==void 0&&(c="#"+this._parent);jQuery(c).append(this._container);this._container.append(jQuery("<div>").addClass("readymap-control-pan-left readymap-control-button").bind("mousedown",function(){a.mapView.viewer.getManipulator().continuousPanX=0.01}));this._container.append(jQuery("<div>").addClass("readymap-control-pan-right readymap-control-button").bind("mousedown",function(){a.mapView.viewer.getManipulator().continuousPanX=
-0.01}));this._container.append(jQuery("<div>").addClass("readymap-control-pan-up readymap-control-button").bind("mousedown",function(){a.mapView.viewer.getManipulator().continuousPanY=-0.01}));this._container.append(jQuery("<div>").addClass("readymap-control-pan-down readymap-control-button").bind("mousedown",function(){a.mapView.viewer.getManipulator().continuousPanY=0.01}));this._container.append(jQuery("<div>").addClass("readymap-control-home readymap-control-button").bind("click",function(){a.mapView.home()}));
jQuery("body").bind("mouseup",function(){a.mapView.viewer.getManipulator().continuousPanX=0;a.mapView.viewer.getManipulator().continuousPanY=0})}};ReadyMap.Controls.Zoom=function(a,c){this.mapView=a;this._parent=c;this.init()};
ReadyMap.Controls.Zoom.prototype={init:function(){var a=this;this._container=jQuery("<div>").addClass("readymap-control-zoom");var c="body";this._parent!==void 0&&(c="#"+this._parent);jQuery(c).append(this._container);this._container.append(jQuery("<div>").addClass("readymap-control-zoom-in readymap-control-button").bind("mousedown",function(){a.mapView.viewer.getManipulator().continuousZoom=-0.01}));this._container.append(jQuery("<div>").addClass("readymap-control-zoom-out readymap-control-button").bind("mousedown",
function(){a.mapView.viewer.getManipulator().continuousZoom=0.01}));jQuery("body").bind("mouseup",function(){a.mapView.viewer.getManipulator().continuousZoom=0})}};
if(typeof OpenLayers!=="undefined"){OpenLayers.Map.prototype.finishGlobe=function(){var a={w:$(this.div).width(),h:$(this.div).height()};this._mapView=new ReadyMap.MapView(this._canvasId,a,this._map)};OpenLayers.Map.prototype.setupGlobe=function(){this._map=new ReadyMap.Map;this._canvasId=this.div.id+"_canvas";this._canvas=$("<canvas/>").attr("id",this._canvasId);$(this.div).append(this._canvas);this.destroy=function(){OpenLayers.Map.prototype.destroy.call(this);$(this._canvas).remove()};this.addLayer=
function(a){OpenLayers.Map.prototype.addLayer.call(this,a);a instanceof OpenLayers.Layer.Grid&&this._map.addImageLayer(new ReadyMap.OLImageLayer({name:a.name,sourceLayer:a}))};this.pan=function(a,c,e){this.is3D?this._mapView.viewer.getManipulator().panModel(-a*0.0020,c*0.0020):OpenLayers.Map.prototype.pan.call(this,a,c,e)};this.zoomIn=function(){this.is3D?this._mapView.viewer.getManipulator().zoomModel(0,-0.1):OpenLayers.Map.prototype.zoomIn.call(this)};this.zoomOut=function(){this.is3D?this._mapView.viewer.getManipulator().zoomModel(0,
0.1):OpenLayers.Map.prototype.zoomOut.call(this)};this.zoomToExtent=function(a,c){if(this.is3D){a===null&&(a=new OpenLayers.Bounds(-180,-90,180,90));var e=a.getWidth(),f=a.getHeight(),f=(e>f?e:f)/2,e=a.getCenterLonLat(),f=0.5*f/0.267949849*111E3;f!=0&&this._mapView.viewer.manipulator.setViewpoint(e.lat,e.lon,0,0,-90,f)}else OpenLayers.Map.prototype.zoomToExtent.call(this,a,c)};this.show3D=function(){this.is3D=!0;$(this._canvas).show();$(this.viewPortDiv).hide();if(this._mapView!==void 0){var a=this.getExtent();
a!==null?this.zoomToExtent(a,!1):this.zoomToMaxExtent();this._positionEngine!==void 0&&this._positionEngine.show()}};this.show2D=function(){this.is3D=!1;$(this._canvas).hide();$(this.viewPortDiv).show();if(this._mapView!==void 0){var a=this._mapView.viewer.view.getViewMatrix(),a=osg.Matrix.inverse(a),c=[];osg.Matrix.getTrans(a,c);a=this._mapView.map.profile.ellipsoid.ecef2lla(c);a[0]=Math.rad2deg(a[0]);a[1]=Math.rad2deg(a[1]);c=a[2]/111E3*0.267949849/0.5;a=new OpenLayers.Bounds(a[0]-c,a[1]-c,a[0]+
c,a[1]+c);a.getWidth()>360||a.getHeight()>180?this.zoomToMaxExtent():this.zoomToExtent(a,!1);this._positionEngine!==void 0&&this._positionEngine.hide()}};this.set3D=function(a){a?this.show3D():this.show2D()};this.set3D(!0)};var markerId=0;OpenLayers.Layer.Markers.prototype.base_addMarker=OpenLayers.Layer.Markers.prototype.addMarker;OpenLayers.Layer.Markers.prototype.addMarker=function(a){OpenLayers.Layer.Markers.prototype.base_addMarker.call(this,a);if(this.map._mapView){if(this.map._positionEngine===
void 0)this.map._positionEngine=new ReadyMap.PositionEngine(this.map._mapView);var c=a.lonlat.lat,e=a.lonlat.lon,f=a.icon.url,g=a.icon.size.w,a=a.icon.size.h;markerId++;this.map._positionEngine.elements.push(new ReadyMap.Icon("icon"+markerId,Math.deg2rad(e),Math.deg2rad(c),0,f,{width:g,height:a}))}}}
if(typeof L!=="undefined")L.Map.prototype._base_initialize=L.Map.prototype.initialize,L.Map.prototype.initialize=function(a,c){var e=L.DomUtil.get(a),f=$("#"+a).height(),g=$("#"+a).width();c.globe&&c.splitview&&(g=Math.floor(g/2)-2);this._leafletDivId="leaflet_div";this._leafletDiv=L.DomUtil.create("div","",e);this._leafletDiv.id=this._leafletDivId;document.getElementById(this._leafletDivId).style.width=g+"px";document.getElementById(this._leafletDivId).style.height=f+"px";this._base_initialize(this._leafletDivId,
c);if(this.options.globe){this._rmDivId="rm_div";this._rmDiv=L.DomUtil.create("div","",e);this._rmDiv.id=this._rmDivId;document.getElementById(this._rmDivId).style.width=g+"px";document.getElementById(this._rmDivId).style.height=f+"px";if(this.options.splitview)document.getElementById(this._leafletDivId).style.position="absolute",document.getElementById(this._leafletDivId).style.left="0px",document.getElementById(this._leafletDivId).style.top="0px",document.getElementById(this._rmDivId).style.position=
"absolute",document.getElementById(this._rmDivId).style.left=g+4+"px",document.getElementById(this._rmDivId).style.top="0px";this._rmMap=new ReadyMap.Map;this._rmMap.profile=new osgearth.MercatorProfile;this._rmMap.profile.baseTilesX=1;this._rmMap.profile.baseTilesY=1;this._canvasId="rm_canvas";this._canvas=L.DomUtil.create("canvas","",document.getElementById(this._rmDivId));this._canvas.id=this._canvasId;this.on("viewreset",this.onLeafletViewReset,this);this.on("move",this.onLeafletViewReset,this)}},
L.Map.prototype.onLeafletViewReset=function(){if(this._loaded){var a=this.getBounds(),c=Math.abs(a.getNorthEast().lng-a.getSouthWest().lng)%180;a.getNorthEast().lng<a.getSouthWest().lng&&(c=180-c);var e=a.getNorthEast().lat-a.getSouthWest().lat,c=(c>e?c:e)/(c>e?4:2),a=a.getCenter(),c=0.5*c/0.267949849*111E3;c!=0&&this.MapView.viewer.manipulator.setViewpoint(a.lat,a.lng,0,0,-90,c)}},L.Map.prototype._base_addLayer=L.Map.prototype.addLayer,L.Map.prototype.addLayer=function(a){this._base_addLayer(a);
this._rmMap.addImageLayer(new ReadyMap.LeafletImageLayer({name:"Leaflet TileLayer",sourceLayer:a}))},L.Map.prototype.finalizeGlobe=function(){if(this.options.globe&&this._rmMap){if(!this.options.splitview)document.getElementById(this._leafletDivId).style.display="none";var a={w:$(this._rmDiv).width(),h:$(this._rmDiv).height()};this.MapView=new ReadyMap.MapView(this._canvasId,a,this._rmMap);this.onLeafletViewReset()}},L.Map.prototype.show3D=function(){if(this.options.globe)document.getElementById(this._leafletDivId).style.display=
"none",document.getElementById(this._rmDivId).style.display="block"},L.Map.prototype.show2D=function(){if(this.options.globe)document.getElementById(this._rmDivId).style.display="none",document.getElementById(this._leafletDivId).style.display="block"};var RealFlow={BuildingNode:function(a,c,e,f,g,h){osg.Node.call(this);this.map=a;this.originLLA={lat:Math.deg2rad(c[f].vertices[0].lat),lon:Math.deg2rad(c[f].vertices[0].lon)};this.heightField=[];this.build(c,1,e,f,g,h)}};
RealFlow.BuildingNode.prototype=osg.objectInehrit(osg.Node.prototype,{insertArray:function(a,c,e){for(var f=0;f<a.length;f++)c[e+f]=a[f]},rampColor:function(a,c){return a<=2*c?[0,0,0,1]:a<=9*c?[0,0,1,1]:a<=15*c?[0,1,0,1]:a<=30*c?[1,1,0,1]:a<=60*c?[1,0.46,0,1]:[1,0,0,1]},rampColor2:function(a,c,e,f,g){var a=g.length,h=Math.floor(a/3),k,i=[0,0,0,1];if(c<=2*e)return i;for(c=0;c<a;c++)f==g[c]&&(k=c);return k<=h?i=[(k+1)/h,0,0,1]:i=k<=2*h&&k>h?[1,(k-h)/h,0,1]:[1,1,(k-2*h)/(h+1),1]},build:function(a,c,
e,f,g,h){function k(a,c,e){for(var f=0;c<e;c++)for(var g=0;g<a[c].vertices.length;g++)a[c].vertices[g].lon==-0.323081&&console.log("puerto de valencia en index: "+c),I.push(f),f++}function i(a,c,e){for(var f=0;c<e;c++){var g=a[c].vertices.length;g%2!=0&&console.log("edificio "+c+" tiene longitud impar");var h=!1,k=!0;v.push(f+0);w.push(f+0);v.push(f+1);w.push(f+2);v.push(f+1);w.push(f+2);for(var i=2;i<g-1;i++)i%2!==0?(k?(v.push(i+f-1),v.push(i+f-1),w.push(i+f+2),w.push(i+f+2)):(v.push(i+f),v.push(i+
f),w.push(i+f+1),w.push(i+f+1)),k=!k):(h?(v.push(i+f),v.push(i+f),w.push(i+f),w.push(i+f)):(v.push(i+f+1),v.push(i+f+1),w.push(i+f+1),w.push(i+f+1)),h=!h);g/2%2==0?(v.push(f+i-1),v.push(f+i-1),w.push(f+1),v.push(f+0)):(v.push(f+i),v.push(f+i),w.push(f+0),v.push(f+1));f+=g}}function m(a,c,e,f){for(var g=!0,h=0;h<a[c].vertices.length-2;h++)g?(e.push(f+h),e.push(f+h+1)):(e.push(f+h+1),e.push(f+h)),e.push(f+h+2),g=!g;e.push(f+a[c].vertices.length-2);e.push(f+a[c].vertices.length-1);e.push(f);e.push(f);
e.push(f+a[c].vertices.length-1);e.push(f+1);return a[c].vertices.length}function n(a,c,e,f){for(var g=0;g<a[c].vertices.length;g+=2)f.push(e+g),temp=new RealFlow.poly2tri_Point(parseFloat(a[c].vertices[g].lon),parseFloat(a[c].vertices[g].lat)),z.push(temp)}function o(a,c,e,f,g){e=new RealFlow.poly2tri_SweepContext(e);try{var h=RealFlow.poly2tri_sweep_Triangulate(e)}catch(i){console.log("Roof failure creation, building: "+c)}if(h)for(var k,m,e=0;e<h.length;e++){k=h[e].points_[2];h[e].points_[2]=h[e].points_[0];
h[e].points_[0]=k;for(var n=0,o=0;o<3;o++){k=h[e].points_[o].x;m=h[e].points_[o].y;for(var p=0;p<a[c].vertices.length;p+=2)if(k==a[c].vertices[p].lon&&m==a[c].vertices[p].lat){f.push(g+p);n++;break}}n!=3&&console.log("Triangle point retrieving Error. Building: "+c+" check="+n)}else console.log("Triangle point retrieving Error. Building: "+c)}var p=[];if(e=="1")for(var q=[],t=0,s=[],u=f;u<g;u++){var y=[],z=[],D=m(a,u,q,t);n(a,u,t,y);o(a,u,z,s,t,y);t+=D}if(e=="2"){var v=[],w=[];i(a,f,g)}if(e=="3"){var I=
[];k(a,f,g)}var y=[],D=[],t=this.map.lla2world([this.originLLA.lon,this.originLLA.lat,0]),t=this.map.threeD?this.map.profile.ellipsoid.local2worldFromECEF(t):osg.Matrix.makeTranslate(this.centerWorld[0],this.centerWorld[1],this.centerWorld[2]),B=[];osg.Matrix.inverse(t,B);var F=0,E=0,H=0,G=0,A=[],C;A.push(a[0].hoja);for(var J=1;J<a.length;J++){u=!1;C=a[J].hoja;for(var x=0;x<A.length;x++)C==A[x]&&(u=!0);u||A.push(C)}console.log("Cadaster Sheets : "+A);for(u=f;u<g;u++)for(x=0;x<a[u].vertices.length;x++)this.heightField.push(parseFloat(a[u].vertices[x].altura)*
c),f=this.heightField[H],C=this.map.lla2world([Math.deg2rad(a[u].vertices[x].lon),Math.deg2rad(a[u].vertices[x].lat),f]),C=osg.Matrix.transformVec3(B,C,[]),this.insertArray(C,p,F),this.insertArray(this.map.geocentric?osg.Vec3.normalize(C,[]):[0,0,1],y,F),F+=3,C=[0.5,0.5,0.5,1],h=="0"?C=this.rampColor(f,c):h=="1"&&(C=this.rampColor2(u,f,c,a[u].hoja,A)),this.insertArray(C,D,E),E+=4,H++,G++;this.geometry=new osg.Geometry;this.geometry.getAttributes().Vertex=new osg.BufferArray(gl.ARRAY_BUFFER,p,3);this.geometry.getAttributes().Normal=
new osg.BufferArray(gl.ARRAY_BUFFER,y,3);this.geometry.getAttributes().Color=new osg.BufferArray(gl.ARRAY_BUFFER,D,4);e=="1"&&(a=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,q,1)),this.geometry.getPrimitives().push(a),s=new osg.DrawElements(gl.TRIANGLES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,s,1)),this.geometry.getPrimitives().push(s));e=="2"&&(s=new osg.DrawElements(gl.LINES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,v,1)),this.geometry.getPrimitives().push(s),
s=new osg.DrawElements(gl.LINES,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,w,1)),this.geometry.getPrimitives().push(s));e=="3"&&(e=new osg.DrawElements(gl.POINTS,new osg.BufferArray(gl.ELEMENT_ARRAY_BUFFER,I,1)),this.geometry.getPrimitives().push(e));e=new osg.MatrixTransform;e.setMatrix(t);e.addChild(this.geometry);this.addChild(e);this.getOrCreateStateSet().setAttributeAndMode(new osg.CullFace("FRONT"))},traverse:function(a){for(var c=this.children.length,e=0;e<c;e++)this.children[e].accept(a)}});
RealFlow.BuildingNode.prototype.objectType=osg.objectType.generate("BuildingNode");osg.CullVisitor.prototype[RealFlow.BuildingNode.prototype.objectType]=function(a){a.stateset&&this.pushStateSet(a.stateset);this.traverse(a);a.stateset&&this.popStateSet()};RealFlow.poly2tri_Point=function(){this.y=this.x=null;arguments.length==0?this.y=this.x=0:arguments.length==2?(this.x=arguments[0],this.y=arguments[1]):alert("Invalid RealFlow.poly2tri_Point constructor call!");this.edge_list=[]};
RealFlow.poly2tri_Point.prototype.set_zero=function(){this.y=this.x=0};RealFlow.poly2tri_Point.prototype.set=function(a,c){this.x=a;this.y=c};RealFlow.poly2tri_Point.prototype.negate=function(){this.x=-this.x;this.y=-this.y};RealFlow.poly2tri_Point.prototype.add=function(a){this.x+=a.x;this.y+=a.y};RealFlow.poly2tri_Point.prototype.sub=function(a){this.x-=a.x;this.y-=a.y};RealFlow.poly2tri_Point.prototype.mul=function(a){this.x*=a;this.y*=a};
RealFlow.poly2tri_Point.prototype.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};RealFlow.poly2tri_Point.prototype.normalize=function(){var a=this.length();this.x/=a;this.y/=a;return a};RealFlow.poly2tri_Point.prototype.equals=function(a){return RealFlow.poly2tri_equals(this,a)};RealFlow.poly2tri_negate=function(a){return new RealFlow.poly2tri_Point(-a.x,-a.y)};RealFlow.poly2tri_cmp=function(a,c){return a.y==c.y?a.x-c.x:a.y-c.y};
RealFlow.poly2tri_add=function(a,c){return new RealFlow.poly2tri_Point(a.x+c.x,a.y+c.y)};RealFlow.poly2tri_sub=function(a,c){return new RealFlow.poly2tri_Point(a.x-c.x,a.y-c.y)};RealFlow.poly2tri_mul=function(a,c){return new RealFlow.poly2tri_Point(a*c.x,a*c.y)};RealFlow.poly2tri_equals=function(a,c){return a.x==c.x&&a.y==c.y};RealFlow.poly2tri_dot=function(a,c){return a.x*c.x+a.y*c.y};
RealFlow.poly2tri_cross=function(){var a=!1,c=!1;if(arguments.length==2)return typeof arguments[0]=="number"&&(a=!0),typeof(arguments[1]=="number")&&(c=!0),a?c?arguments[0].x*arguments[1].y-arguments[0].y*arguments[1].x:new RealFlow.poly2tri_Point(arguments[1]*arguments[0].y,-arguments[1]*arguments[0].x):c?new RealFlow.poly2tri_Point(-arguments[0]*arguments[1].y,arguments[0]*arguments[1].x):arguments[0]*arguments[1];else alert("Invalid RealFlow.poly2tri_cross call!")};
RealFlow.poly2tri_Edge=function(){this.q=this.p=null;arguments.length==2?arguments[0].y>arguments[1].y?(this.q=arguments[0],this.p=arguments[1]):arguments[0].y==arguments[1].y?arguments[0].x>arguments[1].x?(this.q=arguments[0],this.p=arguments[1]):arguments[0].x==arguments[1].x?alert("Invalid RealFlow.poly2tri_edge constructor call: repeated points!"+arguments[0].x+","+arguments[0].y):(this.p=arguments[0],this.q=arguments[1]):(this.p=arguments[0],this.q=arguments[1]):alert("Invalid RealFlow.poly2tri_Edge constructor call!");
this.q.edge_list.push(this)};RealFlow.poly2tri_Triangle=function(a,c,e){this.points_=[null,null,null];this.neighbors_=[null,null,null];this.interior_=!1;this.constrained_edge=[!1,!1,!1];this.delaunay_edge=[!1,!1,!1];arguments.length==3&&(this.points_[0]=a,this.points_[1]=c,this.points_[2]=e)};RealFlow.poly2tri_Triangle.prototype.GetPoint=function(a){return this.points_[a]};RealFlow.poly2tri_Triangle.prototype.GetNeighbor=function(a){return this.neighbors_[a]};
RealFlow.poly2tri_Triangle.prototype.ContainsP=function(){for(var a=!0,c=0;c<arguments.length;++c)a=a&&(arguments[c].equals(this.points_[0])||arguments[c].equals(this.points_[1])||arguments[c].equals(this.points_[2]));return a};RealFlow.poly2tri_Triangle.prototype.ContainsE=function(){for(var a=!0,c=0;c<arguments.length;++c)a=a&&this.ContainsP(arguments[c].p,arguments[c].q);return a};RealFlow.poly2tri_Triangle.prototype.IsInterior=function(){if(arguments.length!=0)this.interior_=arguments[0];return this.interior_};
RealFlow.poly2tri_Triangle.prototype.MarkNeighbor=function(){var a;if(arguments.length==3){var c=arguments[0],e=arguments[1];a=arguments[2];c.equals(this.points_[2])&&e.equals(this.points_[1])||c.equals(this.points_[1])&&e.equals(this.points_[2])?this.neighbors_[0]=a:c.equals(this.points_[0])&&e.equals(this.points_[2])||c.equals(this.points_[2])&&e.equals(this.points_[0])?this.neighbors_[1]=a:c.equals(this.points_[0])&&e.equals(this.points_[1])||c.equals(this.points_[1])&&e.equals(this.points_[0])?
this.neighbors_[2]=a:console.log("Triangle point retrieving Error. Building: "+index)}else arguments.length==1?(a=arguments[0],a.ContainsP(this.points_[1],this.points_[2])?(this.neighbors_[0]=a,a.MarkNeighbor(this.points_[1],this.points_[2],this)):a.ContainsP(this.points_[0],this.points_[2])?(this.neighbors_[1]=a,a.MarkNeighbor(this.points_[0],this.points_[2],this)):a.ContainsP(this.points_[0],this.points_[1])&&(this.neighbors_[2]=a,a.MarkNeighbor(this.points_[0],this.points_[1],this))):alert("Invalid RealFlow.poly2tri_Triangle.MarkNeighbor call! (2)")};
RealFlow.poly2tri_Triangle.prototype.ClearNeigbors=function(){this.neighbors_[0]=null;this.neighbors_[1]=null;this.neighbors_[2]=null};RealFlow.poly2tri_Triangle.prototype.ClearDelunayEdges=function(){this.delaunay_edge[0]=!1;this.delaunay_edge[1]=!1;this.delaunay_edge[2]=!1};RealFlow.poly2tri_Triangle.prototype.PointCW=function(a){return a.equals(this.points_[0])?this.points_[2]:a.equals(this.points_[1])?this.points_[0]:a.equals(this.points_[2])?this.points_[1]:null};
RealFlow.poly2tri_Triangle.prototype.PointCCW=function(a){return a.equals(this.points_[0])?this.points_[1]:a.equals(this.points_[1])?this.points_[2]:a.equals(this.points_[2])?this.points_[0]:null};RealFlow.poly2tri_Triangle.prototype.NeighborCW=function(a){return a.equals(this.points_[0])?this.neighbors_[1]:a.equals(this.points_[1])?this.neighbors_[2]:this.neighbors_[0]};
RealFlow.poly2tri_Triangle.prototype.NeighborCCW=function(a){return a.equals(this.points_[0])?this.neighbors_[2]:a.equals(this.points_[1])?this.neighbors_[0]:this.neighbors_[1]};RealFlow.poly2tri_Triangle.prototype.GetConstrainedEdgeCW=function(a){return a.equals(this.points_[0])?this.constrained_edge[1]:a.equals(this.points_[1])?this.constrained_edge[2]:this.constrained_edge[0]};
RealFlow.poly2tri_Triangle.prototype.GetConstrainedEdgeCCW=function(a){return a.equals(this.points_[0])?this.constrained_edge[2]:a.equals(this.points_[1])?this.constrained_edge[0]:this.constrained_edge[1]};RealFlow.poly2tri_Triangle.prototype.SetConstrainedEdgeCW=function(a,c){a.equals(this.points_[0])?this.constrained_edge[1]=c:a.equals(this.points_[1])?this.constrained_edge[2]=c:this.constrained_edge[0]=c};
RealFlow.poly2tri_Triangle.prototype.SetConstrainedEdgeCCW=function(a,c){a.equals(this.points_[0])?this.constrained_edge[2]=c:a.equals(this.points_[1])?this.constrained_edge[0]=c:this.constrained_edge[1]=c};RealFlow.poly2tri_Triangle.prototype.GetDelaunayEdgeCW=function(a){return a.equals(this.points_[0])?this.delaunay_edge[1]:a.equals(this.points_[1])?this.delaunay_edge[2]:this.delaunay_edge[0]};
RealFlow.poly2tri_Triangle.prototype.GetDelaunayEdgeCCW=function(a){return a.equals(this.points_[0])?this.delaunay_edge[2]:a.equals(this.points_[1])?this.delaunay_edge[0]:this.delaunay_edge[1]};RealFlow.poly2tri_Triangle.prototype.SetDelaunayEdgeCW=function(a,c){a.equals(this.points_[0])?this.delaunay_edge[1]=c:a.equals(this.points_[1])?this.delaunay_edge[2]=c:this.delaunay_edge[0]=c};
RealFlow.poly2tri_Triangle.prototype.SetDelaunayEdgeCCW=function(a,c){a.equals(this.points_[0])?this.delaunay_edge[2]=c:a.equals(this.points_[1])?this.delaunay_edge[0]=c:this.delaunay_edge[1]=c};RealFlow.poly2tri_Triangle.prototype.NeighborAcross=function(a){return a.equals(this.points_[0])?this.neighbors_[0]:a.equals(this.points_[1])?this.neighbors_[1]:this.neighbors_[2]};RealFlow.poly2tri_Triangle.prototype.OppositePoint=function(a,c){return this.PointCW(a.PointCW(c))};
RealFlow.poly2tri_Triangle.prototype.Legalize=function(){if(arguments.length==1)this.Legalize(this.points_[0],arguments[0]);else if(arguments.length==2){var a=arguments[0],c=arguments[1];a.equals(this.points_[0])?(this.points_[1]=this.points_[0],this.points_[0]=this.points_[2],this.points_[2]=c):a.equals(this.points_[1])?(this.points_[2]=this.points_[1],this.points_[1]=this.points_[0],this.points_[0]=c):a.equals(this.points_[2])?(this.points_[0]=this.points_[2],this.points_[2]=this.points_[1],this.points_[1]=
c):alert("Invalid RealFlow.poly2tri_Triangle.Legalize call!")}else alert("Invalid RealFlow.poly2tri_Triangle.Legalize call!")};RealFlow.poly2tri_Triangle.prototype.Index=function(a){return a.equals(this.points_[0])?0:a.equals(this.points_[1])?1:a.equals(this.points_[2])?2:-1};
RealFlow.poly2tri_Triangle.prototype.EdgeIndex=function(a,c){if(a.equals(this.points_[0]))if(c.equals(this.points_[1]))return 2;else{if(c.equals(this.points_[2]))return 1}else if(a.equals(this.points_[1]))if(c.equals(this.points_[2]))return 0;else{if(c.equals(this.points_[0]))return 2}else if(a.equals(this.points_[2]))if(c.equals(this.points_[0]))return 1;else if(c.equals(this.points_[1]))return 0;return-1};
RealFlow.poly2tri_Triangle.prototype.MarkConstrainedEdge=function(){if(arguments.length==1)typeof arguments[0]=="number"?this.constrained_edge[arguments[0]]=!0:this.MarkConstrainedEdge(arguments[0].p,arguments[0].q);else if(arguments.length==2){var a=arguments[0],c=arguments[1];if(c.equals(this.points_[0])&&a.equals(this.points_[1])||c.equals(this.points_[1])&&a.equals(this.points_[0]))this.constrained_edge[2]=!0;else if(c.equals(this.points_[0])&&a.equals(this.points_[2])||c.equals(this.points_[2])&&
a.equals(this.points_[0]))this.constrained_edge[1]=!0;else if(c.equals(this.points_[1])&&a.equals(this.points_[2])||c.equals(this.points_[2])&&a.equals(this.points_[1]))this.constrained_edge[0]=!0}else alert("Invalid RealFlow.poly2tri_Triangle.MarkConstrainedEdge call!")};RealFlow.poly2tri_PI_3div4=3*Math.PI/4;RealFlow.poly2tri_PI_2=Math.PI/2;RealFlow.poly2tri_EPSILON=1.0E-20;RealFlow.poly2tri_kAlpha=0.3;RealFlow.poly2tri_Orientation={CW:1,CCW:-1,COLLINEAR:0};
RealFlow.poly2tri_Orient2d=function(a,c,e){a=(a.x-e.x)*(c.y-e.y)-(a.y-e.y)*(c.x-e.x);return a>-RealFlow.poly2tri_EPSILON&&a<RealFlow.poly2tri_EPSILON?RealFlow.poly2tri_Orientation.COLLINEAR:a>0?RealFlow.poly2tri_Orientation.CCW:RealFlow.poly2tri_Orientation.CW};RealFlow.poly2tri_InScanArea=function(a,c,e,f){var g=f.x,f=f.y,h=a.x-g,a=a.y-f;return h*(c.y-f)-(c.x-g)*a<=RealFlow.poly2tri_EPSILON?!1:(e.x-g)*a-h*(e.y-f)<=RealFlow.poly2tri_EPSILON?!1:!0};
RealFlow.poly2tri_Node=function(){this.prev=this.next=this.triangle=this.point=null;this.value=0;arguments.length==1?(this.point=arguments[0],this.value=this.point.x):arguments.length==2?(this.point=arguments[0],this.triangle=arguments[1],this.value=this.point.x):alert("Invalid RealFlow.poly2tri_Node constructor call!")};RealFlow.poly2tri_AdvancingFront=function(a,c){this.head_=a;this.tail_=c;this.search_node_=a};RealFlow.poly2tri_AdvancingFront.prototype.head=function(){return this.head_};
RealFlow.poly2tri_AdvancingFront.prototype.set_head=function(a){this.head_=a};RealFlow.poly2tri_AdvancingFront.prototype.tail=function(){return this.tail_};RealFlow.poly2tri_AdvancingFront.prototype.set_tail=function(a){this.tail_=a};RealFlow.poly2tri_AdvancingFront.prototype.search=function(){return this.search_node_};RealFlow.poly2tri_AdvancingFront.prototype.set_search=function(a){this.search_node_=a};RealFlow.poly2tri_AdvancingFront.prototype.FindSearchNode=function(){return this.search_node_};
RealFlow.poly2tri_AdvancingFront.prototype.LocateNode=function(a){var c=this.search_node_;if(a<c.value)for(;(c=c.prev)!=null;){if(a>=c.value)return this.search_node_=c}else for(;(c=c.next)!=null;)if(a<c.value)return this.search_node_=c.prev;return null};
RealFlow.poly2tri_AdvancingFront.prototype.LocatePoint=function(a){var c=a.x,e=this.FindSearchNode(c),f=e.point.x;if(c==f)if(a.equals(e.prev.point))e=e.prev;else if(a.equals(e.next.point))e=e.next;else{if(!a.equals(e.point))return alert("Invalid RealFlow.poly2tri_AdvancingFront.LocatePoint call!"),null}else if(c<f)for(;(e=e.prev)!=null;){if(a.equals(e.point))break}else for(;(e=e.next)!=null;)if(a.equals(e.point))break;if(e!=null)this.search_node_=e;return e};
RealFlow.poly2tri_Basin=function(){this.right_node=this.bottom_node=this.left_node=null;this.width=0;this.left_highest=!1};RealFlow.poly2tri_Basin.prototype.Clear=function(){this.right_node=this.bottom_node=this.left_node=null;this.width=0;this.left_highest=!1};RealFlow.poly2tri_EdgeEvent=function(){this.constrained_edge=null;this.right=!1};
RealFlow.poly2tri_SweepContext=function(a){this.triangles_=[];this.map_=[];this.points_=a;this.edge_list=[];this.offsetY=this.offsetX=0;var a=this.points_[0].x,c=this.points_[0].x,e=this.points_[0].y,f=this.points_[0].y,g;for(g in this.points_){var h=this.points_[g];if(h.x>a)a=h.x;if(h.x<c)c=h.x;if(h.y>e)e=h.y;if(h.y<f)f=h.y}if(a<0||c<0)this.offsetX=a<c?Math.abs(a):Math.abs(c);if(e<0||f<0)this.offsetY=e<f?Math.abs(e):Math.abs(f);for(g in this.points_)this.points_[g].x=parseFloat(this.points_[g].x)+
this.offsetX,this.points_[g].y=parseFloat(this.points_[g].y)+this.offsetY;a=this.points_[0].x;c=this.points_[0].x;e=this.points_[0].y;f=this.points_[0].y;for(g in this.points_){h=this.points_[g];if(h.x>a)a=h.x;if(h.x<c)c=h.x;if(h.y>e)e=h.y;if(h.y<f)f=h.y}this.tail_=this.head_=this.front_=null;a=Math.abs(a);c=Math.abs(c);e=Math.abs(e);f=Math.abs(f);g=RealFlow.poly2tri_kAlpha*(e-f);this.head_=new RealFlow.poly2tri_Point(a+RealFlow.poly2tri_kAlpha*(a-c),f-g);this.tail_=new RealFlow.poly2tri_Point(c-
g,f-g);this.af_tail_=this.af_middle_=this.af_head_=null;this.basin=new RealFlow.poly2tri_Basin;this.edge_event=new RealFlow.poly2tri_EdgeEvent;this.InitEdges(this.points_);return this};RealFlow.poly2tri_SweepContext.prototype.AddHole=function(a){this.InitEdges(a);for(var c in a)this.points_.push(a[c])};RealFlow.poly2tri_SweepContext.prototype.front=function(){return this.front_};RealFlow.poly2tri_SweepContext.prototype.point_count=function(){return this.points_.length};
RealFlow.poly2tri_SweepContext.prototype.head=function(){return this.head_};RealFlow.poly2tri_SweepContext.prototype.set_head=function(a){this.head_=a};RealFlow.poly2tri_SweepContext.prototype.tail=function(){return this.tail_};RealFlow.poly2tri_SweepContext.prototype.set_tail=function(a){this.tail_=a};RealFlow.poly2tri_SweepContext.prototype.GetTriangles=function(){return this.triangles_};RealFlow.poly2tri_SweepContext.prototype.GetMap=function(){return this.map_};
RealFlow.poly2tri_SweepContext.prototype.InitTriangulation=function(){this.points_.sort(RealFlow.poly2tri_cmp)};RealFlow.poly2tri_SweepContext.prototype.InitEdges=function(a){for(var c=0;c<a.length;++c)this.edge_list.push(new RealFlow.poly2tri_Edge(a[c],a[(c+1)%a.length]))};RealFlow.poly2tri_SweepContext.prototype.GetPoint=function(a){return this.points_[a]};RealFlow.poly2tri_SweepContext.prototype.AddToMap=function(a){this.map_.push(a)};RealFlow.poly2tri_SweepContext.prototype.LocateNode=function(a){return this.front_.LocateNode(a.x)};
RealFlow.poly2tri_SweepContext.prototype.CreateAdvancingFront=function(){var a,c,e;e=new RealFlow.poly2tri_Triangle(this.points_[0],this.tail_,this.head_);this.map_.push(e);a=new RealFlow.poly2tri_Node(e.GetPoint(1),e);c=new RealFlow.poly2tri_Node(e.GetPoint(0),e);e=new RealFlow.poly2tri_Node(e.GetPoint(2));this.front_=new RealFlow.poly2tri_AdvancingFront(a,e);a.next=c;c.next=e;c.prev=a;e.prev=c};RealFlow.poly2tri_SweepContext.prototype.RemoveNode=function(){};
RealFlow.poly2tri_SweepContext.prototype.MapTriangleToNodes=function(a){for(var c=0;c<3;++c)if(a.GetNeighbor(c)==null){var e=this.front_.LocatePoint(a.PointCW(a.GetPoint(c)));if(e!=null)e.triangle=a}};RealFlow.poly2tri_SweepContext.prototype.RemoveFromMap=function(a){for(var c in this.map_)if(this.map_[c]==a){delete this.map_[c];break}};
RealFlow.poly2tri_SweepContext.prototype.MeshClean=function(a){if(a!=null&&!a.IsInterior()){a.IsInterior(!0);this.triangles_.push(a);for(var c=0;c<3;++c)a.constrained_edge[c]||this.MeshClean(a.GetNeighbor(c))}};RealFlow.poly2tri_sweep_Triangulate=function(a){a.InitTriangulation();a.CreateAdvancingFront();RealFlow.poly2tri_sweep_SweepPoints(a);RealFlow.poly2tri_sweep_FinalizationPolygon(a);for(var c in a.points_)a.points_[c].x-=a.offsetX,a.points_[c].y-=a.offsetY;return a.triangles_};
RealFlow.poly2tri_sweep_SweepPoints=function(a){for(var c=1;c<a.point_count();++c)for(var e=a.GetPoint(c),f=RealFlow.poly2tri_sweep_PointEvent(a,e),g=0;g<e.edge_list.length;++g)RealFlow.poly2tri_sweep_EdgeEvent(a,e.edge_list[g],f)};RealFlow.poly2tri_sweep_FinalizationPolygon=function(a){for(var c=a.front().head().next.triangle,e=a.front().head().next.point;!c.GetConstrainedEdgeCW(e);)c=c.NeighborCCW(e);a.MeshClean(c)};
RealFlow.poly2tri_sweep_PointEvent=function(a,c){var e=a.LocateNode(c),f=RealFlow.poly2tri_sweep_NewFrontTriangle(a,c,e);c.x<=e.point.x+RealFlow.poly2tri_EPSILON&&RealFlow.poly2tri_sweep_Fill(a,e);RealFlow.poly2tri_sweep_FillAdvancingFront(a,f);return f};
RealFlow.poly2tri_sweep_EdgeEvent=function(){var a;if(arguments.length==3){a=arguments[0];var c=arguments[1],e=arguments[2];a.edge_event.constrained_edge=c;a.edge_event.right=c.p.x>c.q.x;RealFlow.poly2tri_sweep_IsEdgeSideOfTriangle(e.triangle,c.p,c.q)||(RealFlow.poly2tri_sweep_FillEdgeEvent(a,c,e),RealFlow.poly2tri_sweep_EdgeEvent(a,c.p,c.q,e.triangle,c.q))}else if(arguments.length==5){a=arguments[0];var c=arguments[1],e=arguments[2],f=arguments[3],g=arguments[4];if(!RealFlow.poly2tri_sweep_IsEdgeSideOfTriangle(f,
c,e)){var h=f.PointCCW(g),h=RealFlow.poly2tri_Orient2d(e,h,c);if(h==RealFlow.poly2tri_Orientation.COLLINEAR)alert("RealFlow.poly2tri_sweep_EdgeEvent: Collinear not supported!");else{var k=f.PointCW(g),k=RealFlow.poly2tri_Orient2d(e,k,c);k==RealFlow.poly2tri_Orientation.COLLINEAR?alert("RealFlow.poly2tri_sweep_EdgeEvent: Collinear not supported!"):h==k?(f=h==RealFlow.poly2tri_Orientation.CW?f.NeighborCCW(g):f.NeighborCW(g),RealFlow.poly2tri_sweep_EdgeEvent(a,c,e,f,g)):RealFlow.poly2tri_sweep_FlipEdgeEvent(a,
c,e,f,g)}}}else alert("Invalid RealFlow.poly2tri_sweep_EdgeEvent call!")};RealFlow.poly2tri_sweep_IsEdgeSideOfTriangle=function(a,c,e){var f=a.EdgeIndex(c,e);return f!=-1?(a.MarkConstrainedEdge(f),a=a.GetNeighbor(f),a!=null&&a.MarkConstrainedEdge(c,e),!0):!1};
RealFlow.poly2tri_sweep_NewFrontTriangle=function(a,c,e){var f=new RealFlow.poly2tri_Triangle(c,e.point,e.next.point);f.MarkNeighbor(e.triangle);a.AddToMap(f);c=new RealFlow.poly2tri_Node(c);c.next=e.next;c.prev=e;e.next.prev=c;e.next=c;RealFlow.poly2tri_sweep_Legalize(a,f)||a.MapTriangleToNodes(f);return c};
RealFlow.poly2tri_sweep_Fill=function(a,c){var e=new RealFlow.poly2tri_Triangle(c.prev.point,c.point,c.next.point);e.MarkNeighbor(c.prev.triangle);e.MarkNeighbor(c.triangle);a.AddToMap(e);c.prev.next=c.next;c.next.prev=c.prev;RealFlow.poly2tri_sweep_Legalize(a,e)||a.MapTriangleToNodes(e)};
RealFlow.poly2tri_sweep_FillAdvancingFront=function(a,c){for(var e=c.next,f;e.next!=null;){f=RealFlow.poly2tri_sweep_HoleAngle(e);if(f>RealFlow.poly2tri_PI_2||f<-RealFlow.poly2tri_PI_2)break;RealFlow.poly2tri_sweep_Fill(a,e);e=e.next}for(e=c.prev;e.prev!=null;){f=RealFlow.poly2tri_sweep_HoleAngle(e);if(f>RealFlow.poly2tri_PI_2||f<-RealFlow.poly2tri_PI_2)break;RealFlow.poly2tri_sweep_Fill(a,e);e=e.prev}c.next!=null&&c.next.next!=null&&(f=RealFlow.poly2tri_sweep_BasinAngle(c),f<RealFlow.poly2tri_PI_3div4&&
RealFlow.poly2tri_sweep_FillBasin(a,c))};RealFlow.poly2tri_sweep_BasinAngle=function(a){return Math.atan2(a.point.y-a.next.next.point.y,a.point.x-a.next.next.point.x)};RealFlow.poly2tri_sweep_HoleAngle=function(a){var c=a.next.point.x-a.point.x,e=a.next.point.y-a.point.y,f=a.prev.point.x-a.point.x,a=a.prev.point.y-a.point.y;return Math.atan2(c*a-e*f,c*f+e*a)};
RealFlow.poly2tri_sweep_Legalize=function(a,c){for(var e=0;e<3;++e)if(!c.delaunay_edge[e]){var f=c.GetNeighbor(e);if(f!=null){var g=c.GetPoint(e),h=f.OppositePoint(c,g),k=f.Index(h);if(f.constrained_edge[k]||f.delaunay_edge[k])c.constrained_edge[e]=f.constrained_edge[k];else if(RealFlow.poly2tri_sweep_Incircle(g,c.PointCCW(g),c.PointCW(g),h))return c.delaunay_edge[e]=!0,f.delaunay_edge[k]=!0,RealFlow.poly2tri_sweep_RotateTrianglePair(c,g,f,h),(g=!RealFlow.poly2tri_sweep_Legalize(a,c))&&a.MapTriangleToNodes(c),
(g=!RealFlow.poly2tri_sweep_Legalize(a,f))&&a.MapTriangleToNodes(f),c.delaunay_edge[e]=!1,f.delaunay_edge[k]=!1,!0}}return!1};RealFlow.poly2tri_sweep_Incircle=function(a,c,e,f){var g=a.x-f.x,a=a.y-f.y,h=c.x-f.x,c=c.y-f.y,k=g*c-h*a;if(k<=0)return!1;var i=e.x-f.x,e=e.y-f.y,f=i*a-g*e;return f<=0?!1:(g*g+a*a)*(h*e-i*c)+(h*h+c*c)*f+(i*i+e*e)*k>0};
RealFlow.poly2tri_sweep_RotateTrianglePair=function(a,c,e,f){var g,h,k,i;g=a.NeighborCCW(c);h=a.NeighborCW(c);k=e.NeighborCCW(f);i=e.NeighborCW(f);var m,n,o,p;m=a.GetConstrainedEdgeCCW(c);n=a.GetConstrainedEdgeCW(c);o=e.GetConstrainedEdgeCCW(f);p=e.GetConstrainedEdgeCW(f);var q,t,s,u;q=a.GetDelaunayEdgeCCW(c);t=a.GetDelaunayEdgeCW(c);s=e.GetDelaunayEdgeCCW(f);u=e.GetDelaunayEdgeCW(f);a.Legalize(c,f);e.Legalize(f,c);e.SetDelaunayEdgeCCW(c,q);a.SetDelaunayEdgeCW(c,t);a.SetDelaunayEdgeCCW(f,s);e.SetDelaunayEdgeCW(f,
u);e.SetConstrainedEdgeCCW(c,m);a.SetConstrainedEdgeCW(c,n);a.SetConstrainedEdgeCCW(f,o);e.SetConstrainedEdgeCW(f,p);a.ClearNeigbors();e.ClearNeigbors();g&&e.MarkNeighbor(g);h&&a.MarkNeighbor(h);k&&a.MarkNeighbor(k);i&&e.MarkNeighbor(i);a.MarkNeighbor(e)};
RealFlow.poly2tri_sweep_FillBasin=function(a,c){a.basin.left_node=RealFlow.poly2tri_Orient2d(c.point,c.next.point,c.next.next.point)==RealFlow.poly2tri_Orientation.CCW?c.next.next:c.next;for(a.basin.bottom_node=a.basin.left_node;a.basin.bottom_node.next!=null&&a.basin.bottom_node.point.y>=a.basin.bottom_node.next.point.y;)a.basin.bottom_node=a.basin.bottom_node.next;if(a.basin.bottom_node!=a.basin.left_node){for(a.basin.right_node=a.basin.bottom_node;a.basin.right_node.next!=null&&a.basin.right_node.point.y<
a.basin.right_node.next.point.y;)a.basin.right_node=a.basin.right_node.next;if(a.basin.right_node!=a.basin.bottom_node)a.basin.width=a.basin.right_node.point.x-a.basin.left_node.point.x,a.basin.left_highest=a.basin.left_node.point.y>a.basin.right_node.point.y,RealFlow.poly2tri_sweep_FillBasinReq(a,a.basin.bottom_node)}};
RealFlow.poly2tri_sweep_FillBasinReq=function(a,c){if(!RealFlow.poly2tri_sweep_IsShallow(a,c)){RealFlow.poly2tri_sweep_Fill(a,c);var e;if(!(c.prev==a.basin.left_node&&c.next==a.basin.right_node)){if(c.prev==a.basin.left_node){e=RealFlow.poly2tri_Orient2d(c.point,c.next.point,c.next.next.point);if(e==RealFlow.poly2tri_Orientation.CW)return;c=c.next}else if(c.next==a.basin.right_node){e=RealFlow.poly2tri_Orient2d(c.point,c.prev.point,c.prev.prev.point);if(e==RealFlow.poly2tri_Orientation.CCW)return;
c=c.prev}else c=c.prev.point.y<c.next.point.y?c.prev:c.next;RealFlow.poly2tri_sweep_FillBasinReq(a,c)}}};RealFlow.poly2tri_sweep_IsShallow=function(a,c){return a.basin.width>(a.basin.left_highest?a.basin.left_node.point.y-c.point.y:a.basin.right_node.point.y-c.point.y)?!0:!1};RealFlow.poly2tri_sweep_FillEdgeEvent=function(a,c,e){a.edge_event.right?RealFlow.poly2tri_sweep_FillRightAboveEdgeEvent(a,c,e):RealFlow.poly2tri_sweep_FillLeftAboveEdgeEvent(a,c,e)};
RealFlow.poly2tri_sweep_FillRightAboveEdgeEvent=function(a,c,e){for(;e.next.point.x<c.p.x;)RealFlow.poly2tri_Orient2d(c.q,e.next.point,c.p)==RealFlow.poly2tri_Orientation.CCW?RealFlow.poly2tri_sweep_FillRightBelowEdgeEvent(a,c,e):e=e.next};
RealFlow.poly2tri_sweep_FillRightBelowEdgeEvent=function(a,c,e){e.point.x<c.p.x&&(RealFlow.poly2tri_Orient2d(e.point,e.next.point,e.next.next.point)==RealFlow.poly2tri_Orientation.CCW?RealFlow.poly2tri_sweep_FillRightConcaveEdgeEvent(a,c,e):(RealFlow.poly2tri_sweep_FillRightConvexEdgeEvent(a,c,e),RealFlow.poly2tri_sweep_FillRightBelowEdgeEvent(a,c,e)))};
RealFlow.poly2tri_sweep_FillRightConcaveEdgeEvent=function(a,c,e){RealFlow.poly2tri_sweep_Fill(a,e.next);e.next.point!=c.p&&RealFlow.poly2tri_Orient2d(c.q,e.next.point,c.p)==RealFlow.poly2tri_Orientation.CCW&&RealFlow.poly2tri_Orient2d(e.point,e.next.point,e.next.next.point)==RealFlow.poly2tri_Orientation.CCW&&RealFlow.poly2tri_sweep_FillRightConcaveEdgeEvent(a,c,e)};
RealFlow.poly2tri_sweep_FillRightConvexEdgeEvent=function(a,c,e){RealFlow.poly2tri_Orient2d(e.next.point,e.next.next.point,e.next.next.next.point)==RealFlow.poly2tri_Orientation.CCW?RealFlow.poly2tri_sweep_FillRightConcaveEdgeEvent(a,c,e.next):RealFlow.poly2tri_Orient2d(c.q,e.next.next.point,c.p)==RealFlow.poly2tri_Orientation.CCW&&RealFlow.poly2tri_sweep_FillRightConvexEdgeEvent(a,c,e.next)};
RealFlow.poly2tri_sweep_FillLeftAboveEdgeEvent=function(a,c,e){for(;e.prev.point.x>c.p.x;)RealFlow.poly2tri_Orient2d(c.q,e.prev.point,c.p)==RealFlow.poly2tri_Orientation.CW?RealFlow.poly2tri_sweep_FillLeftBelowEdgeEvent(a,c,e):e=e.prev};
RealFlow.poly2tri_sweep_FillLeftBelowEdgeEvent=function(a,c,e){e.point.x>c.p.x&&(RealFlow.poly2tri_Orient2d(e.point,e.prev.point,e.prev.prev.point)==RealFlow.poly2tri_Orientation.CW?RealFlow.poly2tri_sweep_FillLeftConcaveEdgeEvent(a,c,e):(RealFlow.poly2tri_sweep_FillLeftConvexEdgeEvent(a,c,e),RealFlow.poly2tri_sweep_FillLeftBelowEdgeEvent(a,c,e)))};
RealFlow.poly2tri_sweep_FillLeftConvexEdgeEvent=function(a,c,e){RealFlow.poly2tri_Orient2d(e.prev.point,e.prev.prev.point,e.prev.prev.prev.point)==RealFlow.poly2tri_Orientation.CW?RealFlow.poly2tri_sweep_FillLeftConcaveEdgeEvent(a,c,e.prev):RealFlow.poly2tri_Orient2d(c.q,e.prev.prev.point,c.p)==RealFlow.poly2tri_Orientation.CW&&RealFlow.poly2tri_sweep_FillLeftConvexEdgeEvent(a,c,e.prev)};
RealFlow.poly2tri_sweep_FillLeftConcaveEdgeEvent=function(a,c,e){RealFlow.poly2tri_sweep_Fill(a,e.prev);e.prev.point!=c.p&&RealFlow.poly2tri_Orient2d(c.q,e.prev.point,c.p)==RealFlow.poly2tri_Orientation.CW&&RealFlow.poly2tri_Orient2d(e.point,e.prev.point,e.prev.prev.point)==RealFlow.poly2tri_Orientation.CW&&RealFlow.poly2tri_sweep_FillLeftConcaveEdgeEvent(a,c,e)};
RealFlow.poly2tri_sweep_FlipEdgeEvent=function(a,c,e,f,g){var h=f.NeighborAcross(g);if(h==null)alert("[BUG:FIXME] FLIP failed due to missing triangle!");else{var k=h.OppositePoint(f,g);if(RealFlow.poly2tri_InScanArea(g,f.PointCCW(g),f.PointCW(g),k))if(RealFlow.poly2tri_sweep_RotateTrianglePair(f,g,h,k),a.MapTriangleToNodes(f),a.MapTriangleToNodes(h),g==e&&k==c)e==a.edge_event.constrained_edge.q&&c==a.edge_event.constrained_edge.p&&(f.MarkConstrainedEdge(c,e),h.MarkConstrainedEdge(c,e),RealFlow.poly2tri_sweep_Legalize(a,
f),RealFlow.poly2tri_sweep_Legalize(a,h));else{var i=RealFlow.poly2tri_Orient2d(e,k,c),f=RealFlow.poly2tri_sweep_NextFlipTriangle(a,i,f,h,g,k);RealFlow.poly2tri_sweep_FlipEdgeEvent(a,c,e,f,g)}else k=RealFlow.poly2tri_sweep_NextFlipPoint(c,e,h,k),RealFlow.poly2tri_sweep_FlipScanEdgeEvent(a,c,e,f,h,k),RealFlow.poly2tri_sweep_EdgeEvent(a,c,e,f,g)}};
RealFlow.poly2tri_sweep_NextFlipTriangle=function(a,c,e,f,g,h){if(c==RealFlow.poly2tri_Orientation.CCW)return c=f.EdgeIndex(g,h),f.delaunay_edge[c]=!0,RealFlow.poly2tri_sweep_Legalize(a,f),f.ClearDelunayEdges(),e;c=e.EdgeIndex(g,h);e.delaunay_edge[c]=!0;RealFlow.poly2tri_sweep_Legalize(a,e);e.ClearDelunayEdges();return f};
RealFlow.poly2tri_sweep_NextFlipPoint=function(a,c,e,f){a=RealFlow.poly2tri_Orient2d(c,f,a);if(a==RealFlow.poly2tri_Orientation.CW)return e.PointCCW(f);else if(a==RealFlow.poly2tri_Orientation.CCW)return e.PointCW(f);else alert("[Unsupported] RealFlow.poly2tri_sweep_NextFlipPoint: opposing point on constrained edge!")};
RealFlow.poly2tri_sweep_FlipScanEdgeEvent=function(a,c,e,f,g,h){var k=g.NeighborAcross(h);k==null?alert("[BUG:FIXME] FLIP failed due to missing triangle"):(g=k.OppositePoint(g,h),RealFlow.poly2tri_InScanArea(e,f.PointCCW(e),f.PointCW(e),g)?RealFlow.poly2tri_sweep_FlipEdgeEvent(a,e,g,k,g):(g=NextFlipPoint(c,e,k,g),RealFlow.poly2tri_sweep_FlipScanEdgeEvent(a,c,e,f,k,g)))};
